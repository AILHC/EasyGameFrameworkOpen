{"version":3,"file":"index.js","sources":["../../../src/egf-app.ts"],"sourcesContent":["export class App<ModuleMap = any> implements egf.IApp<ModuleMap> {\n    public static readonly UN_RUN: number = 0;\n    public static readonly BOOTING: number = 1;\n    public static readonly BOOTEND: number = 2;\n    public static readonly RUNING: number = 3;\n    public static readonly STOP: number = 4;\n    protected _state: number = 0;\n    protected _moduleMap: { [key: string]: egf.IModule } = {};\n    public get state(): number {\n        return this._state;\n    }\n    public get moduleMap(): ModuleMap {\n        return this._moduleMap as any;\n    }\n    public async bootstrap(bootLoaders?: egf.IBootLoader[]): Promise<boolean> {\n        this.setState(App.BOOTING);\n        if (!bootLoaders || bootLoaders.length <= 0) {\n            this.setState(App.BOOTEND);\n            return true;\n        }\n        if (bootLoaders && bootLoaders.length > 0) {\n            const bootPromises: Promise<void>[] = [];\n            for (let i = 0; i < bootLoaders.length; i++) {\n                const bootLoader: egf.IBootLoader = bootLoaders[i];\n                bootPromises.push(\n                    new Promise((res, rej) => {\n                        bootLoader.onBoot(this as any, (isOk) => {\n                            if (isOk) {\n                                res();\n                            } else {\n                                rej();\n                            }\n                        });\n                    })\n                );\n            }\n            try {\n                await Promise.all(bootPromises);\n                this.setState(App.BOOTEND);\n                return true;\n            } catch (e) {\n                console.error(e);\n                this.setState(App.BOOTEND);\n                return false;\n            }\n        }\n    }\n\n    public init(): void {\n        const moduleMap = this._moduleMap;\n        let moduleIns: egf.IModule;\n        if (this.state === App.RUNING) return;\n        for (const key in moduleMap) {\n            moduleIns = moduleMap[key];\n            moduleIns.onInit && moduleIns.onInit(this as any);\n        }\n        for (const key in moduleMap) {\n            moduleIns = moduleMap[key];\n            moduleIns.onAfterInit && moduleIns.onAfterInit(this as any);\n        }\n        this.setState(App.RUNING);\n    }\n    public loadModule(moduleIns: any | egf.IModule, key?: keyof ModuleMap): boolean {\n        if (this._state === App.STOP) return false;\n        let res: boolean = false;\n        if (!key) {\n            key = moduleIns.key as never;\n        }\n        if (key && typeof key === \"string\") {\n            if (moduleIns) {\n                if (!this._moduleMap[key]) {\n                    this._moduleMap[key] = moduleIns;\n                    res = true;\n                    if (this._state === App.RUNING) {\n                        moduleIns.onInit && moduleIns.onInit(this);\n                        moduleIns.onAfterInit && moduleIns.onAfterInit();\n                    }\n                } else {\n                    this._log(`加载模块:模块:${key}已经存在,不重复加载`);\n                }\n            } else {\n                this._log(`加载模块:模块:${key}实例为空`);\n            }\n        } else {\n            this._log(`加载模块:模块key为空`);\n        }\n        return res;\n    }\n    public hasModule(moduleKey: keyof ModuleMap): boolean {\n        return !!this._moduleMap[moduleKey as any];\n    }\n    public stop(): void {\n        const moduleMap = this._moduleMap;\n        let moduleIns: egf.IModule;\n        this.setState(App.STOP);\n        for (const key in moduleMap) {\n            moduleIns = moduleMap[key];\n            moduleIns.onStop && moduleIns.onStop();\n        }\n    }\n    public getModule<K extends keyof ModuleMap>(moduleKey: K): ModuleMap[K] {\n        return this._moduleMap[moduleKey as any] as any;\n    }\n\n    protected setState(state: number) {\n        if (!isNaN(this._state)) {\n            if (this._state >= state) return;\n        }\n        this._state = state;\n    }\n    /**\n     * 输出\n     * @param level 1 warn 2 error\n     * @param msg\n     */\n    protected _log(msg: string, level?: number): void {\n        switch (level) {\n            case 1:\n                console.warn(`【主程序】${msg}`);\n                break;\n            case 2:\n                console.error(`【主程序】${msg}`);\n                break;\n            default:\n                console.warn(`【主程序】${msg}`);\n                break;\n        }\n    }\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;gBAAA;oBAMc,WAAM,GAAW,CAAC,CAAC;oBACnB,eAAU,GAAmC,EAAE,CAAC;iBAyH7D;gBAxHG,sBAAW,sBAAK;yBAAhB;wBACI,OAAO,IAAI,CAAC,MAAM,CAAC;qBACtB;;;mBAAA;gBACD,sBAAW,0BAAS;yBAApB;wBACI,OAAO,IAAI,CAAC,UAAiB,CAAC;qBACjC;;;mBAAA;gBACY,uBAAS,GAAtB,UAAuB,WAA+B;;;;;;;oCAClD,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;oCAC3B,IAAI,CAAC,WAAW,IAAI,WAAW,CAAC,MAAM,IAAI,CAAC,EAAE;wCACzC,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;wCAC3B,WAAO,IAAI,EAAC;qCACf;0CACG,WAAW,IAAI,WAAW,CAAC,MAAM,GAAG,CAAC,CAAA,EAArC,cAAqC;oCAC/B,YAAY,GAAoB,EAAE,CAAC;wDAChC,CAAC;wCACN,IAAM,UAAU,GAAoB,WAAW,CAAC,CAAC,CAAC,CAAC;wCACnD,YAAY,CAAC,IAAI,CACb,IAAI,OAAO,CAAC,UAAC,GAAG,EAAE,GAAG;4CACjB,UAAU,CAAC,MAAM,CAAC,KAAW,EAAE,UAAC,IAAI;gDAChC,IAAI,IAAI,EAAE;oDACN,GAAG,EAAE,CAAC;iDACT;qDAAM;oDACH,GAAG,EAAE,CAAC;iDACT;6CACJ,CAAC,CAAC;yCACN,CAAC,CACL,CAAC;;oCAZN,KAAS,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,WAAW,CAAC,MAAM,EAAE,CAAC,EAAE;gDAAlC,CAAC;qCAaT;;;;oCAEG,WAAM,OAAO,CAAC,GAAG,CAAC,YAAY,CAAC,EAAA;;oCAA/B,SAA+B,CAAC;oCAChC,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;oCAC3B,WAAO,IAAI,EAAC;;;oCAEZ,OAAO,CAAC,KAAK,CAAC,GAAC,CAAC,CAAC;oCACjB,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;oCAC3B,WAAO,KAAK,EAAC;;;;;iBAGxB;gBAEM,kBAAI,GAAX;oBACI,IAAM,SAAS,GAAG,IAAI,CAAC,UAAU,CAAC;oBAClC,IAAI,SAAsB,CAAC;oBAC3B,IAAI,IAAI,CAAC,KAAK,KAAK,GAAG,CAAC,MAAM;wBAAE,OAAO;oBACtC,KAAK,IAAM,GAAG,IAAI,SAAS,EAAE;wBACzB,SAAS,GAAG,SAAS,CAAC,GAAG,CAAC,CAAC;wBAC3B,SAAS,CAAC,MAAM,IAAI,SAAS,CAAC,MAAM,CAAC,IAAW,CAAC,CAAC;qBACrD;oBACD,KAAK,IAAM,GAAG,IAAI,SAAS,EAAE;wBACzB,SAAS,GAAG,SAAS,CAAC,GAAG,CAAC,CAAC;wBAC3B,SAAS,CAAC,WAAW,IAAI,SAAS,CAAC,WAAW,CAAC,IAAW,CAAC,CAAC;qBAC/D;oBACD,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;iBAC7B;gBACM,wBAAU,GAAjB,UAAkB,SAA4B,EAAE,GAAqB;oBACjE,IAAI,IAAI,CAAC,MAAM,KAAK,GAAG,CAAC,IAAI;wBAAE,OAAO,KAAK,CAAC;oBAC3C,IAAI,GAAG,GAAY,KAAK,CAAC;oBACzB,IAAI,CAAC,GAAG,EAAE;wBACN,GAAG,GAAG,SAAS,CAAC,GAAY,CAAC;qBAChC;oBACD,IAAI,GAAG,IAAI,OAAO,GAAG,KAAK,QAAQ,EAAE;wBAChC,IAAI,SAAS,EAAE;4BACX,IAAI,CAAC,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,EAAE;gCACvB,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,GAAG,SAAS,CAAC;gCACjC,GAAG,GAAG,IAAI,CAAC;gCACX,IAAI,IAAI,CAAC,MAAM,KAAK,GAAG,CAAC,MAAM,EAAE;oCAC5B,SAAS,CAAC,MAAM,IAAI,SAAS,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;oCAC3C,SAAS,CAAC,WAAW,IAAI,SAAS,CAAC,WAAW,EAAE,CAAC;iCACpD;6BACJ;iCAAM;gCACH,IAAI,CAAC,IAAI,CAAC,2CAAW,GAAG,4DAAY,CAAC,CAAC;6BACzC;yBACJ;6BAAM;4BACH,IAAI,CAAC,IAAI,CAAC,2CAAW,GAAG,6BAAM,CAAC,CAAC;yBACnC;qBACJ;yBAAM;wBACH,IAAI,CAAC,IAAI,CAAC,sDAAc,CAAC,CAAC;qBAC7B;oBACD,OAAO,GAAG,CAAC;iBACd;gBACM,uBAAS,GAAhB,UAAiB,SAA0B;oBACvC,OAAO,CAAC,CAAC,IAAI,CAAC,UAAU,CAAC,SAAgB,CAAC,CAAC;iBAC9C;gBACM,kBAAI,GAAX;oBACI,IAAM,SAAS,GAAG,IAAI,CAAC,UAAU,CAAC;oBAClC,IAAI,SAAsB,CAAC;oBAC3B,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;oBACxB,KAAK,IAAM,GAAG,IAAI,SAAS,EAAE;wBACzB,SAAS,GAAG,SAAS,CAAC,GAAG,CAAC,CAAC;wBAC3B,SAAS,CAAC,MAAM,IAAI,SAAS,CAAC,MAAM,EAAE,CAAC;qBAC1C;iBACJ;gBACM,uBAAS,GAAhB,UAA4C,SAAY;oBACpD,OAAO,IAAI,CAAC,UAAU,CAAC,SAAgB,CAAQ,CAAC;iBACnD;gBAES,sBAAQ,GAAlB,UAAmB,KAAa;oBAC5B,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE;wBACrB,IAAI,IAAI,CAAC,MAAM,IAAI,KAAK;4BAAE,OAAO;qBACpC;oBACD,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC;iBACvB;gBAMS,kBAAI,GAAd,UAAe,GAAW,EAAE,KAAc;oBACtC,QAAQ,KAAK;wBACT,KAAK,CAAC;4BACF,OAAO,CAAC,IAAI,CAAC,mCAAQ,GAAK,CAAC,CAAC;4BAC5B,MAAM;wBACV,KAAK,CAAC;4BACF,OAAO,CAAC,KAAK,CAAC,mCAAQ,GAAK,CAAC,CAAC;4BAC7B,MAAM;wBACV;4BACI,OAAO,CAAC,IAAI,CAAC,mCAAQ,GAAK,CAAC,CAAC;4BAC5B,MAAM;qBACb;iBACJ;gBA9HsB,UAAM,GAAW,CAAC,CAAC;gBACnB,WAAO,GAAW,CAAC,CAAC;gBACpB,WAAO,GAAW,CAAC,CAAC;gBACpB,UAAM,GAAW,CAAC,CAAC;gBACnB,QAAI,GAAW,CAAC,CAAC;gBA2H5C,UAAC;aAhID;;;;;;;;;;"}