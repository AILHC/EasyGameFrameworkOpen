{"version":3,"file":"index.js","sources":["../../../src/egf-app.ts"],"sourcesContent":["export class App<ModuleMap = any> implements egf.IApp<ModuleMap> {\r\n    public static readonly UN_RUN: number = 0;\r\n    public static readonly BOOTING: number = 1;\r\n    public static readonly BOOTEND: number = 2;\r\n    public static readonly RUNING: number = 3;\r\n    public static readonly STOP: number = 4;\r\n    protected _state: number = 0;\r\n    protected _moduleMap: { [key: string]: egf.IModule } = {};\r\n    protected _proxyModuleMap: { [key: string]: egf.IModule };\r\n    public get state(): number {\r\n        return this._state;\r\n    }\r\n    public get moduleMap(): ModuleMap {\r\n        const moduleMap = this._moduleMap;\r\n        if (!this._proxyModuleMap) {\r\n            this._proxyModuleMap = new Proxy(moduleMap, {\r\n                get(target, key) {\r\n                    if (typeof key === \"string\") {\r\n                        return moduleMap[key];\r\n                    } else {\r\n                        return null;\r\n                    }\r\n                }\r\n            });\r\n        }\r\n        return this._proxyModuleMap as any;\r\n    }\r\n    public async bootstrap(bootLoaders?: egf.IBootLoader[]): Promise<boolean> {\r\n        this.setState(App.BOOTING);\r\n        if (!bootLoaders || bootLoaders.length <= 0) {\r\n            this.setState(App.BOOTEND);\r\n            return true;\r\n        }\r\n        if (bootLoaders && bootLoaders.length > 0) {\r\n            const bootPromises: Promise<boolean>[] = [];\r\n            for (let i = 0; i < bootLoaders.length; i++) {\r\n                const bootLoader: egf.IBootLoader = bootLoaders[i];\r\n                bootPromises.push(new Promise((res, rej) => {\r\n                    bootLoader.onBoot(this as any, (isOk) => {\r\n                        if (isOk) {\r\n                            res();\r\n                        } else {\r\n                            rej();\r\n                        }\r\n                    });\r\n                }));\r\n            }\r\n            try {\r\n                await Promise.all(bootPromises);\r\n                this.setState(App.BOOTEND);\r\n                return true;\r\n            }\r\n            catch (e) {\r\n                console.error(e);\r\n                this.setState(App.BOOTEND);\r\n                return false;\r\n            }\r\n        }\r\n    }\r\n\r\n    public init(): void {\r\n        const moduleMap = this._moduleMap;\r\n        let moduleIns: egf.IModule;\r\n        if (this.state === App.RUNING) return;\r\n        for (const key in moduleMap) {\r\n            moduleIns = moduleMap[key];\r\n            moduleIns.onInit && moduleIns.onInit(this as any);\r\n        }\r\n        for (const key in moduleMap) {\r\n            moduleIns = moduleMap[key];\r\n            moduleIns.onAfterInit && moduleIns.onAfterInit(this as any);\r\n        }\r\n        this.setState(App.RUNING);\r\n    }\r\n    public loadModule(moduleIns: any | egf.IModule, key?: keyof ModuleMap): boolean {\r\n        if (this._state === App.STOP) return false;\r\n        let res: boolean = false;\r\n        if (!key) {\r\n            key = moduleIns.key as never;\r\n        }\r\n        if (key && typeof key === \"string\") {\r\n            if (moduleIns) {\r\n                if (!this._moduleMap[key]) {\r\n                    this._moduleMap[key] = moduleIns;\r\n                    res = true;\r\n                    if (this._state === App.RUNING) {\r\n                        moduleIns.onInit && moduleIns.onInit(this);\r\n                        moduleIns.onAfterInit && moduleIns.onAfterInit();\r\n                    }\r\n                } else {\r\n                    this._log(`加载模块:模块:${key}已经存在,不重复加载`);\r\n                }\r\n            } else {\r\n                this._log(`加载模块:模块:${key}实例为空`);\r\n            }\r\n        } else {\r\n            this._log(`加载模块:模块key为空`);\r\n        }\r\n        return res;\r\n    }\r\n    public hasModule(moduleKey: keyof ModuleMap): boolean {\r\n        return !!this._moduleMap[moduleKey as any];\r\n    }\r\n    public stop(): void {\r\n        const moduleMap = this._moduleMap;\r\n        let moduleIns: egf.IModule;\r\n        this.setState(App.STOP);\r\n        for (const key in moduleMap) {\r\n            moduleIns = moduleMap[key];\r\n            moduleIns.onStop && moduleIns.onStop();\r\n        }\r\n    }\r\n    public getModule<K extends keyof ModuleMap>(moduleKey: K): ModuleMap[K] {\r\n        return this._moduleMap[moduleKey as any] as any;\r\n    }\r\n\r\n    protected setState(state: number) {\r\n        this._state = state;\r\n    }\r\n    /**\r\n     * 输出\r\n     * @param level 1 warn 2 error\r\n     * @param msg \r\n     */\r\n    protected _log(msg: string, level?: number): void {\r\n        switch (level) {\r\n            case 1:\r\n                console.warn(`【主程序】${msg}`);\r\n                break;\r\n            case 2:\r\n                console.error(`【主程序】${msg}`);\r\n                break;\r\n            default:\r\n                console.warn(`【主程序】${msg}`);\r\n                break;\r\n        }\r\n    };\r\n\r\n}"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;QAAA;YAMc,WAAM,GAAW,CAAC,CAAC;YACnB,eAAU,GAAmC,EAAE,CAAC;SAmI7D;QAjIG,sBAAW,sBAAK;iBAAhB;gBACI,OAAO,IAAI,CAAC,MAAM,CAAC;aACtB;;;WAAA;QACD,sBAAW,0BAAS;iBAApB;gBACI,IAAM,SAAS,GAAG,IAAI,CAAC,UAAU,CAAC;gBAClC,IAAI,CAAC,IAAI,CAAC,eAAe,EAAE;oBACvB,IAAI,CAAC,eAAe,GAAG,IAAI,KAAK,CAAC,SAAS,EAAE;wBACxC,GAAG,YAAC,MAAM,EAAE,GAAG;4BACX,IAAI,OAAO,GAAG,KAAK,QAAQ,EAAE;gCACzB,OAAO,SAAS,CAAC,GAAG,CAAC,CAAC;6BACzB;iCAAM;gCACH,OAAO,IAAI,CAAC;6BACf;yBACJ;qBACJ,CAAC,CAAC;iBACN;gBACD,OAAO,IAAI,CAAC,eAAsB,CAAC;aACtC;;;WAAA;QACY,uBAAS,GAAtB,UAAuB,WAA+B;;;;;;;4BAClD,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;4BAC3B,IAAI,CAAC,WAAW,IAAI,WAAW,CAAC,MAAM,IAAI,CAAC,EAAE;gCACzC,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;gCAC3B,sBAAO,IAAI,EAAC;6BACf;kCACG,WAAW,IAAI,WAAW,CAAC,MAAM,GAAG,CAAC,CAAA,EAArC,wBAAqC;4BAC/B,YAAY,GAAuB,EAAE,CAAC;gDACnC,CAAC;gCACN,IAAM,UAAU,GAAoB,WAAW,CAAC,CAAC,CAAC,CAAC;gCACnD,YAAY,CAAC,IAAI,CAAC,IAAI,OAAO,CAAC,UAAC,GAAG,EAAE,GAAG;oCACnC,UAAU,CAAC,MAAM,CAAC,KAAW,EAAE,UAAC,IAAI;wCAChC,IAAI,IAAI,EAAE;4CACN,GAAG,EAAE,CAAC;yCACT;6CAAM;4CACH,GAAG,EAAE,CAAC;yCACT;qCACJ,CAAC,CAAC;iCACN,CAAC,CAAC,CAAC;;4BAVR,KAAS,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,WAAW,CAAC,MAAM,EAAE,CAAC,EAAE;wCAAlC,CAAC;6BAWT;;;;4BAEG,qBAAM,OAAO,CAAC,GAAG,CAAC,YAAY,CAAC,EAAA;;4BAA/B,SAA+B,CAAC;4BAChC,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;4BAC3B,sBAAO,IAAI,EAAC;;;4BAGZ,OAAO,CAAC,KAAK,CAAC,GAAC,CAAC,CAAC;4BACjB,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;4BAC3B,sBAAO,KAAK,EAAC;;;;;SAGxB;QAEM,kBAAI,GAAX;YACI,IAAM,SAAS,GAAG,IAAI,CAAC,UAAU,CAAC;YAClC,IAAI,SAAsB,CAAC;YAC3B,IAAI,IAAI,CAAC,KAAK,KAAK,GAAG,CAAC,MAAM;gBAAE,OAAO;YACtC,KAAK,IAAM,GAAG,IAAI,SAAS,EAAE;gBACzB,SAAS,GAAG,SAAS,CAAC,GAAG,CAAC,CAAC;gBAC3B,SAAS,CAAC,MAAM,IAAI,SAAS,CAAC,MAAM,CAAC,IAAW,CAAC,CAAC;aACrD;YACD,KAAK,IAAM,GAAG,IAAI,SAAS,EAAE;gBACzB,SAAS,GAAG,SAAS,CAAC,GAAG,CAAC,CAAC;gBAC3B,SAAS,CAAC,WAAW,IAAI,SAAS,CAAC,WAAW,CAAC,IAAW,CAAC,CAAC;aAC/D;YACD,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;SAC7B;QACM,wBAAU,GAAjB,UAAkB,SAA4B,EAAE,GAAqB;YACjE,IAAI,IAAI,CAAC,MAAM,KAAK,GAAG,CAAC,IAAI;gBAAE,OAAO,KAAK,CAAC;YAC3C,IAAI,GAAG,GAAY,KAAK,CAAC;YACzB,IAAI,CAAC,GAAG,EAAE;gBACN,GAAG,GAAG,SAAS,CAAC,GAAY,CAAC;aAChC;YACD,IAAI,GAAG,IAAI,OAAO,GAAG,KAAK,QAAQ,EAAE;gBAChC,IAAI,SAAS,EAAE;oBACX,IAAI,CAAC,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,EAAE;wBACvB,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,GAAG,SAAS,CAAC;wBACjC,GAAG,GAAG,IAAI,CAAC;wBACX,IAAI,IAAI,CAAC,MAAM,KAAK,GAAG,CAAC,MAAM,EAAE;4BAC5B,SAAS,CAAC,MAAM,IAAI,SAAS,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;4BAC3C,SAAS,CAAC,WAAW,IAAI,SAAS,CAAC,WAAW,EAAE,CAAC;yBACpD;qBACJ;yBAAM;wBACH,IAAI,CAAC,IAAI,CAAC,2CAAW,GAAG,4DAAY,CAAC,CAAC;qBACzC;iBACJ;qBAAM;oBACH,IAAI,CAAC,IAAI,CAAC,2CAAW,GAAG,6BAAM,CAAC,CAAC;iBACnC;aACJ;iBAAM;gBACH,IAAI,CAAC,IAAI,CAAC,sDAAc,CAAC,CAAC;aAC7B;YACD,OAAO,GAAG,CAAC;SACd;QACM,uBAAS,GAAhB,UAAiB,SAA0B;YACvC,OAAO,CAAC,CAAC,IAAI,CAAC,UAAU,CAAC,SAAgB,CAAC,CAAC;SAC9C;QACM,kBAAI,GAAX;YACI,IAAM,SAAS,GAAG,IAAI,CAAC,UAAU,CAAC;YAClC,IAAI,SAAsB,CAAC;YAC3B,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;YACxB,KAAK,IAAM,GAAG,IAAI,SAAS,EAAE;gBACzB,SAAS,GAAG,SAAS,CAAC,GAAG,CAAC,CAAC;gBAC3B,SAAS,CAAC,MAAM,IAAI,SAAS,CAAC,MAAM,EAAE,CAAC;aAC1C;SACJ;QACM,uBAAS,GAAhB,UAA4C,SAAY;YACpD,OAAO,IAAI,CAAC,UAAU,CAAC,SAAgB,CAAQ,CAAC;SACnD;QAES,sBAAQ,GAAlB,UAAmB,KAAa;YAC5B,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC;SACvB;;;;;;QAMS,kBAAI,GAAd,UAAe,GAAW,EAAE,KAAc;YACtC,QAAQ,KAAK;gBACT,KAAK,CAAC;oBACF,OAAO,CAAC,IAAI,CAAC,mCAAQ,GAAK,CAAC,CAAC;oBAC5B,MAAM;gBACV,KAAK,CAAC;oBACF,OAAO,CAAC,KAAK,CAAC,mCAAQ,GAAK,CAAC,CAAC;oBAC7B,MAAM;gBACV;oBACI,OAAO,CAAC,IAAI,CAAC,mCAAQ,GAAK,CAAC,CAAC;oBAC5B,MAAM;aACb;SACJ;QAvIsB,UAAM,GAAW,CAAC,CAAC;QACnB,WAAO,GAAW,CAAC,CAAC;QACpB,WAAO,GAAW,CAAC,CAAC;QACpB,UAAM,GAAW,CAAC,CAAC;QACnB,QAAI,GAAW,CAAC,CAAC;QAqI5C,UAAC;KA1ID;;;;;;;;;;;;;"}