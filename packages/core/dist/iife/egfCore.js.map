{"version":3,"file":"egfCore.js","sources":["@ailhc/egf-core/src/egf-app.ts"],"sourcesContent":["export class App<ModuleMap = any> implements egf.IApp<ModuleMap> {\n    public static readonly UN_RUN: number = 0;\n    public static readonly BOOTING: number = 1;\n    public static readonly BOOTEND: number = 2;\n    public static readonly RUNING: number = 3;\n    public static readonly STOP: number = 4;\n    protected _state: number = 0;\n    protected _moduleMap: { [key: string]: egf.IModule } = {};\n    public get state(): number {\n        return this._state;\n    }\n    public get moduleMap(): ModuleMap {\n        return this._moduleMap as any;\n    }\n    public async bootstrap(bootLoaders?: egf.IBootLoader[]): Promise<boolean> {\n        this.setState(App.BOOTING);\n        if (!bootLoaders || bootLoaders.length <= 0) {\n            this.setState(App.BOOTEND);\n            return true;\n        }\n        if (bootLoaders && bootLoaders.length > 0) {\n            const bootPromises: Promise<void>[] = [];\n            for (let i = 0; i < bootLoaders.length; i++) {\n                const bootLoader: egf.IBootLoader = bootLoaders[i];\n                bootPromises.push(\n                    new Promise((res, rej) => {\n                        bootLoader.onBoot(this as any, (isOk) => {\n                            if (isOk) {\n                                res();\n                            } else {\n                                rej();\n                            }\n                        });\n                    })\n                );\n            }\n            try {\n                await Promise.all(bootPromises);\n                this.setState(App.BOOTEND);\n                return true;\n            } catch (e) {\n                console.error(e);\n                this.setState(App.BOOTEND);\n                return false;\n            }\n        }\n    }\n\n    public init(): void {\n        const moduleMap = this._moduleMap;\n        let moduleIns: egf.IModule;\n        if (this.state === App.RUNING) return;\n        for (const key in moduleMap) {\n            moduleIns = moduleMap[key];\n            moduleIns.onInit && moduleIns.onInit(this as any);\n        }\n        for (const key in moduleMap) {\n            moduleIns = moduleMap[key];\n            moduleIns.onAfterInit && moduleIns.onAfterInit(this as any);\n        }\n        this.setState(App.RUNING);\n    }\n    public loadModule(moduleIns: any | egf.IModule, key?: keyof ModuleMap): boolean {\n        if (this._state === App.STOP) return false;\n        let res: boolean = false;\n        if (!key) {\n            key = moduleIns.key as never;\n        }\n        if (key && typeof key === \"string\") {\n            if (moduleIns) {\n                if (!this._moduleMap[key]) {\n                    this._moduleMap[key] = moduleIns;\n                    res = true;\n                    if (this._state === App.RUNING) {\n                        moduleIns.onInit && moduleIns.onInit(this);\n                        moduleIns.onAfterInit && moduleIns.onAfterInit();\n                    }\n                } else {\n                    this._log(`加载模块:模块:${key}已经存在,不重复加载`);\n                }\n            } else {\n                this._log(`加载模块:模块:${key}实例为空`);\n            }\n        } else {\n            this._log(`加载模块:模块key为空`);\n        }\n        return res;\n    }\n    public hasModule(moduleKey: keyof ModuleMap): boolean {\n        return !!this._moduleMap[moduleKey as any];\n    }\n    public stop(): void {\n        const moduleMap = this._moduleMap;\n        let moduleIns: egf.IModule;\n        this.setState(App.STOP);\n        for (const key in moduleMap) {\n            moduleIns = moduleMap[key];\n            moduleIns.onStop && moduleIns.onStop();\n        }\n    }\n    public getModule<K extends keyof ModuleMap>(moduleKey: K): ModuleMap[K] {\n        return this._moduleMap[moduleKey as any] as any;\n    }\n\n    protected setState(state: number) {\n        if (!isNaN(this._state)) {\n            if (this._state >= state) return;\n        }\n        this._state = state;\n    }\n    /**\n     * 输出\n     * @param level 1 warn 2 error\n     * @param msg\n     */\n    protected _log(msg: string, level?: number): void {\n        switch (level) {\n            case 1:\n                console.warn(`【主程序】${msg}`);\n                break;\n            case 2:\n                console.error(`【主程序】${msg}`);\n                break;\n            default:\n                console.warn(`【主程序】${msg}`);\n                break;\n        }\n    }\n}\n"],"names":[],"mappings":"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"}