{"version":3,"file":"index.js","sources":["../../../src/egf-app.ts"],"sourcesContent":["export class App<ModuleMap = any> implements egf.IApp {\r\n    public static readonly UN_RUN: number = 0;\r\n    public static readonly BOOTING: number = 1;\r\n    public static readonly BOOTEND: number = 2;\r\n    public static readonly RUNING: number = 3;\r\n    public static readonly STOP: number = 4;\r\n    protected _state: number = 0;\r\n    protected _moduleMap: { [key: string]: egf.IModule } = {};\r\n    protected _proxyModuleMap: { [key: string]: egf.IModule };\r\n    public get state(): number {\r\n        return this._state;\r\n    }\r\n    public get moduleMap(): ModuleMap {\r\n        const moduleMap = this._moduleMap;\r\n        if (!this._proxyModuleMap) {\r\n            this._proxyModuleMap = new Proxy(moduleMap, {\r\n                get(target, key) {\r\n                    if (typeof key === \"string\") {\r\n                        return moduleMap[key];\r\n                    } else {\r\n                        return null;\r\n                    }\r\n                }\r\n            });\r\n        }\r\n        return this._proxyModuleMap as any;\r\n    }\r\n    public async bootstrap(bootLoaders?: egf.IBootLoader[]): Promise<boolean> {\r\n        this.setState(App.BOOTING);\r\n        if (!bootLoaders || bootLoaders.length <= 0) {\r\n            this.setState(App.BOOTEND);\r\n            return true;\r\n        }\r\n        if (bootLoaders && bootLoaders.length > 0) {\r\n            const bootPromises: Promise<boolean>[] = [];\r\n            for (let i = 0; i < bootLoaders.length; i++) {\r\n                const bootLoader: egf.IBootLoader = bootLoaders[i];\r\n                bootPromises.push(new Promise((res, rej) => {\r\n                    bootLoader.onBoot(this, (isOk) => {\r\n                        if (isOk) {\r\n                            res();\r\n                        } else {\r\n                            rej();\r\n                        }\r\n                    });\r\n                }));\r\n            }\r\n            try {\r\n                await Promise.all(bootPromises);\r\n                this.setState(App.BOOTEND);\r\n                return true;\r\n            }\r\n            catch (e) {\r\n                console.error(e);\r\n                this.setState(App.BOOTEND);\r\n                return false;\r\n            }\r\n        }\r\n    }\r\n\r\n    public init(): void {\r\n        const moduleMap = this._moduleMap;\r\n        let moduleIns: egf.IModule;\r\n        if (this.state === App.RUNING) return;\r\n        for (const key in moduleMap) {\r\n            moduleIns = moduleMap[key];\r\n            moduleIns.onInit && moduleIns.onInit(this);\r\n        }\r\n        for (const key in moduleMap) {\r\n            moduleIns = moduleMap[key];\r\n            moduleIns.onAfterInit && moduleIns.onAfterInit(this);\r\n        }\r\n        this.setState(App.RUNING);\r\n    }\r\n    public loadModule(moduleIns: any | egf.IModule, key?: keyof ModuleMap): boolean {\r\n        if (this._state === App.STOP) return false;\r\n        let res: boolean = false;\r\n        if (!key) {\r\n            key = moduleIns.key as never;\r\n        }\r\n        if (key && typeof key === \"string\") {\r\n            if (moduleIns) {\r\n                if (!this._moduleMap[key]) {\r\n                    this._moduleMap[key] = moduleIns;\r\n                    res = true;\r\n                    if (this._state === App.RUNING) {\r\n                        moduleIns.onInit && moduleIns.onInit(this);\r\n                        moduleIns.onAfterInit && moduleIns.onAfterInit();\r\n                    }\r\n                } else {\r\n                    this._log(`加载模块:模块:${key}已经存在,不重复加载`);\r\n                }\r\n            } else {\r\n                this._log(`加载模块:模块:${key}实例为空`);\r\n            }\r\n        } else {\r\n            this._log(`加载模块:模块key为空`);\r\n        }\r\n        return res;\r\n    }\r\n    public hasModule(moduleKey: keyof ModuleMap): boolean {\r\n        return !!this._moduleMap[moduleKey as any];\r\n    }\r\n    public stop(): void {\r\n        const moduleMap = this._moduleMap;\r\n        let moduleIns: egf.IModule;\r\n        this.setState(App.STOP);\r\n        for (const key in moduleMap) {\r\n            moduleIns = moduleMap[key];\r\n            moduleIns.onStop && moduleIns.onStop();\r\n        }\r\n    }\r\n    public getModule<T extends egf.IModule>(moduleKey: keyof ModuleMap): T {\r\n        return this._moduleMap[moduleKey as any] as T;\r\n    }\r\n\r\n    protected setState(state: number) {\r\n        this._state = state;\r\n    }\r\n    /**\r\n     * 输出\r\n     * @param level 1 warn 2 error\r\n     * @param msg \r\n     */\r\n    protected _log(msg: string, level?: number): void {\r\n        switch (level) {\r\n            case 1:\r\n                console.warn(`【主程序】${msg}`);\r\n                break;\r\n            case 2:\r\n                console.error(`【主程序】${msg}`);\r\n                break;\r\n            default:\r\n                console.warn(`【主程序】${msg}`);\r\n                break;\r\n        }\r\n    };\r\n\r\n}"],"names":[],"mappings":"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"}