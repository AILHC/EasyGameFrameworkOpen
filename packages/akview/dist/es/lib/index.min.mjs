class e{constructor(){this.handleMethodMap=new Map}onRegist(){}on(e,t,i,o,s){let n,a=this.handleMethodMap.get(e);a||(a=[],this.handleMethodMap.set(e,a)),t&&(n="object"==typeof t?t:{method:t,caller:i,args:o},s&&this.off(e,n.method,n.caller),a.push(n))}once(e,t,i,o){const s={method:t,caller:i,args:o,once:!0};this.on(e,s,null,null,!0)}off(e,t,i){let o=this.handleMethodMap.get(e);if(o){let e;for(let s=o.length-1;s>=0;s--)e=o[s],e.method===t&&e.caller===i&&(o[s]=o[o.length-1],o.pop())}}emit(e,t){let i=this.handleMethodMap.get(e);if(i){let e;for(let o=i.length-1;o>=0;o--)e=i[o],e.once&&(i[o]=i[i.length-1],i.pop()),e.method.call(e.caller,e.args,t)}}onViewEvent(e,t,i,o,s){const n=this.getIdEventKey(e,t);this.on(n,i,o,s)}onceViewEvent(e,t,i,o,s){const n=this.getIdEventKey(e,t);this.once(n,i,o,s)}offViewEvent(e,t,i,o){const s=this.getIdEventKey(e,t);this.off(s,i,o)}emitViewEvent(e,t,i){const o=this.getIdEventKey(e,t);i&&!i.viewId&&(i.viewId=e),this.emit(o,i),this.emit(t,i)}getIdEventKey(e,t){return e+"_*_"+t}}class t{constructor(e){this._option=e,this._templateLoadResConfigsMap={},this._loadedMap={},this._loadResIdMap={},this._resRefMap={},this._resInfoMap={},this._option||(this._option={})}createView(e){var t,i,o;let s;return s=e.viewClass?new e.viewClass:null===(t=null==e?void 0:e.createView)||void 0===t?void 0:t.call(e,e),s||(s=null===(o=(i=this._option).createView)||void 0===o?void 0:o.call(i,e)),s}createViewState(e){var t,i,o;let s;return s=e.viewStateClass?new e.viewStateClass:null===(t=null==e?void 0:e.createViewState)||void 0===t?void 0:t.call(e,e),s||(s=null===(o=(i=this._option).createViewState)||void 0===o?void 0:o.call(i,e)),s}addToLayer(e){var t,i,o;const s=e.template;(null===(t=null==s?void 0:s.layerHandler)||void 0===t?void 0:t.addToLayer)?s.layerHandler.addToLayer(e):null===(o=(i=this._option).addToLayer)||void 0===o||o.call(i,e)}removeFromLayer(e){var t,i;const o=e.template;o.removeFromLayer?o.removeFromLayer(e):null===(i=(t=this._option).removeFromLayer)||void 0===i||i.call(t,e)}destroyView(e,t){}getPreloadResInfo(e){var t,i,o;let s=this._resInfoMap[e.key];return s||(s=null===(t=e.getPreloadResInfo)||void 0===t?void 0:t.call(e),s||(s=null===(o=(i=this._option).getPreloadResInfo)||void 0===o?void 0:o.call(i,e)),this._resInfoMap[e.key]=s),s}isLoaded(e){let t=this._loadedMap[e.key];return t||(t=!this._option.isLoaded||this._option.isLoaded(this.getPreloadResInfo(e))),t}loadRes(e){var t,i;const o=e.id,s=e.template.key;let n,a=this._templateLoadResConfigsMap[s];if(a?n=Object.keys(a).length>0:(a={},this._templateLoadResConfigsMap[s]=a),a[o]=e,n)return;let l=null===(i=(t=this._option).loadRes)||void 0===i?void 0:i.call(t,this.getPreloadResInfo(e.template),(e=>{var t;const i=this._templateLoadResConfigsMap[s];let o;e&&console.error(` templateKey ${s} load error:`,e),this._templateLoadResConfigsMap[s]=void 0,Object.keys(i).length>0&&(e||(this._loadedMap[s]=!0));for(let s in i)o=i[s],o&&(null===(t=o.complete)||void 0===t||t.call(o,e),i[s]=void 0)}),((...e)=>{const t=this._templateLoadResConfigsMap[s];let i;for(let o in t)i=t[o],(null==i?void 0:i.progress)&&i.progress.apply(null,e)}),e.loadOption);this._loadResIdMap[s]=l}cancelLoad(e,t){var i,o,s;let n=t.key;const a=this._templateLoadResConfigsMap[n];if(a){const t=a[e];null===(i=null==t?void 0:t.complete)||void 0===i||i.call(t,"cancel load",!0),delete a[e]}if(!Object.keys(a).length){let e=this._loadResIdMap[n];e&&(delete this._loadResIdMap[n],null===(s=(o=this._option).cancelLoadRes)||void 0===s||s.call(o,e,this.getPreloadResInfo(t)))}}addResRef(e,t){var i,o;let s=this._resRefMap[e];s||(s=[],this._resRefMap[e]=s),s.push(e),null===(o=(i=this._option).addResRef)||void 0===o||o.call(i,t)}decResRef(e,t){var i,o;let s=this._resRefMap[e];if(s){const t=s.indexOf(e);t>-1&&(0===t?s.pop():s[t]=s.pop())}null===(o=(i=this._option).decResRef)||void 0===o||o.call(i,this.getPreloadResInfo(t)),s.length<=0&&(this._loadedMap[t.key]=!1)}destroyRes(e){var t,i;const o=this._templateLoadResConfigsMap[e.key];if(o&&Object.keys(o).length)return!1;let s=this._resRefMap[e.key];return!(s&&s.length>0)&&(this._loadedMap[e.key]=!1,null===(i=(t=this._option).destroyRes)||void 0===i||i.call(t,this.getPreloadResInfo(e)),!0)}}
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function i(e,t,i,o){return new(i||(i=Promise))((function(s,n){function a(e){try{d(o.next(e))}catch(e){n(e)}}function l(e){try{d(o.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,l)}d((o=o.apply(e,t||[])).next())}))}class o{onCreate(e){this._isConstructed||(this._isConstructed=!0,this._option=e)}initAndShowView(){this.initView(),this.needShowView&&(this.isViewInited?this.showView():console.error(`id:${this.id} isViewInited is false`))}onShow(e){if(this.showCfg=e,this.needDestroy=!1,this.needShowView=e.needShowView,this._needDestroyRes=!1,(this.isViewShowed||this.hiding)&&(this.showingPromise&&(this.showingPromise=void 0),this.hidingPromise&&(this.hidingPromise=void 0),this.hideViewIns()),this.isHoldTemplateResRef||this.viewMgr.isPreloadResLoaded(this.id))this.initAndShowView();else if(!this.isLoading){const t=e=>{this.isLoading=!1,e||this.destroyed||this.initAndShowView()};this.isLoading=!0,this.viewMgr.preloadResById(this.id,t,e.loadOption)}}onUpdate(e){var t;if(this.destroyed)return;const i=this.viewIns;this.isViewInited?null===(t=null==i?void 0:i.onUpdateView)||void 0===t||t.call(i,e):this.updateState=e}onHide(e){var t,o;return i(this,void 0,void 0,(function*(){const i=this.viewIns;let s;if(this.hideCfg=e,this.hiding=!0,this.needDestroy=null===(t=this.hideCfg)||void 0===t?void 0:t.destroyAfterHide,this.showingPromise=void 0,this.isLoading&&(this.isLoading=!1,this.viewMgr.cancelPreloadRes(this.id)),this.viewMgr.eventBus.emitViewEvent("onViewHide",this.id),this.isViewShowed=!1,this.isViewShowEnd=!1,i&&(s=null===(o=i.onPlayAnim)||void 0===o?void 0:o.call(i,!1,null==e?void 0:e.hideOption),this.hidingPromise=s),s){if(yield s,this.hidingPromise!==s)return;this.hidingPromise=void 0}this.hideViewIns(),this.needDestroy&&this.entryDestroyed()}))}onDestroy(e){this.hidingPromise&&(this.hidingPromise=void 0),this.showingPromise&&(this.showingPromise=void 0),this.isLoading&&(this.isLoading=!1,this.viewMgr.cancelPreloadRes(this.id)),this._needDestroyRes=e,this.hideViewIns(),this.entryDestroyed()}initView(){var e;if(!this.isViewInited){const t=this.viewMgr.createView(this);this.viewMgr.addTemplateResRef(this),!this.isViewInited&&t&&(null===(e=t.onInitView)||void 0===e||e.call(t,this.showCfg.onInitData),this.isViewInited=!0,this.viewMgr.eventBus.emitViewEvent("onViewInit",this.id))}}showView(){var e,t,i;const o=this.viewIns;null===(e=o.onBeforeViewShow)||void 0===e||e.call(o,this.showCfg.onShowData),this.viewMgr.eventBus.on("onWindowResize",o.onWindowResize,o),this.addToLayer(this),null===(t=o.onShowView)||void 0===t||t.call(o,this.showCfg.onShowData),this.viewMgr.eventBus.emitViewEvent("onViewShow",this.id);const s=null===(i=o.onPlayAnim)||void 0===i?void 0:i.call(o,!0);var n;this.showingPromise=s,this.isViewShowed=!0,this.needShowView=!1,this.updateState&&o.onUpdateView&&(o.onUpdateView(this.updateState),this.updateState=void 0),null!==(n=this.showingPromise)&&"object"==typeof n&&"function"==typeof n.then&&"function"==typeof n.catch?this.showingPromise.then((()=>{this.showingPromise===s&&(this.showingPromise=void 0,this.entryShowEnd())})):this.entryShowEnd()}entryShowEnd(){this.isViewShowEnd=!0,this.viewMgr.eventBus.emitViewEvent("onViewShowEnd",this.id)}hideViewIns(){var e;this.hiding=!1,this.isViewShowed=!1,this.isViewShowEnd=!1;const t=this.hideCfg,i=this.viewIns;i&&(this.removeFromLayer(this),null===(e=i.onHideView)||void 0===e||e.call(i,null==t?void 0:t.hideOption),this.viewMgr.eventBus.off("onWindowResize",i.onWindowResize,i)),this._option.canDecTemplateResRefOnHide&&(null==t?void 0:t.decTemplateResRef)&&this.viewMgr.decTemplateResRef(this),this.hideCfg=void 0,this.viewMgr.eventBus.emitViewEvent("onViewHideEnd",this.id)}entryDestroyed(){var e;const t=this.viewMgr,i=this.viewIns;this.needDestroy=!1,this.destroyed=!0,this.isViewInited=!1,i&&(null===(e=i.onDestroyView)||void 0===e||e.call(i),this.viewIns=void 0);const o=this.template,s=t.templateHandler;null==s||s.destroyView(i,o),t.decTemplateResRef(this),(this._needDestroyRes||this._option.destroyResOnDestroy)&&t.destroyRes(o.key),this._needDestroyRes=!1,t.eventBus.emitViewEvent("onViewDestroyed",this.id)}addToLayer(e){if(e.template){const t=this.viewMgr.templateHandler;(null==t?void 0:t.addToLayer)?t.addToLayer(e):console.error(`${e.template.key} \u6ca1\u6709\u53d6\u5230\u6dfb\u52a0\u5230\u5c42\u7ea7\u7684\u65b9\u6cd5`)}}removeFromLayer(e){if(e.template){const t=this.viewMgr.templateHandler;(null==t?void 0:t.removeFromLayer)?t.removeFromLayer(e):console.error(`${e.template.key} \u6ca1\u6709\u53d6\u5230\u4ece\u5c42\u7ea7\u79fb\u9664\u7684\u65b9\u6cd5`)}}}class s{constructor(e){this._option=e,this.cache=new Map,this._option||(this._option={maxSize:5})}onViewStateShow(e){this.put(e.id,e)}onViewStateUpdate(e){this.get(e.id)}onViewStateHide(e){}onViewStateDestroy(e){this.cache.delete(e.id)}get(e){if(this.cache.has(e)){let t=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,t),t}}put(e,t){const i=this._option.maxSize,o=this.cache;if(o.has(e))o.delete(e);else if(o.size>=i){let s=o.size-i,n=0;for(let e of o.keys()){if(!(n<s))break;o.get(e).isViewShowed||o.delete(e),n++}console.log(`refresh: key:${e} , value:${t}`)}o.set(e,t)}toString(){console.log("maxSize",this._option.maxSize),console.table(this.cache)}}const n={};function a(e,t=n){const i=e.key;return t[i]?(console.error("template is exit"),!1):(t[i]=e,!0)}class l{constructor(){this._viewCount=0}get cacheHandler(){return this._cacheHandler}get eventBus(){return this._eventBus}get templateHandler(){return this._templateHandler}get option(){return this._option}getKey(e){return e}init(i){if(this._inited)return;this._eventBus=(null==i?void 0:i.eventBus)?null==i?void 0:i.eventBus:new e,this._cacheHandler=(null==i?void 0:i.cacheHandler)?null==i?void 0:i.cacheHandler:new s(null==i?void 0:i.defaultCacheHandlerOption),this._viewStateMap={};let o=null==i?void 0:i.templateHandler;o||(o=new t(null==i?void 0:i.defaultTplHandlerInitOption)),this._templateHandler=o,this._viewStateCreateOption=(null==i?void 0:i.viewStateCreateOption)?null==i?void 0:i.viewStateCreateOption:{},this._inited=!0,this._option=i||{};const a=(null==i?void 0:i.templateMap)?null==i?void 0:i.templateMap:n;this._templateMap=a?Object.assign({},a):{}}use(e,t){var i;e&&(e.viewMgr=this,null===(i=e.onUse)||void 0===i||i.call(e,t))}template(e){if(e)if(this._inited)if(Array.isArray(e)){let t;for(let i in e)t=e[i],"object"==typeof t?this._addTemplate(t):this._addTemplate({key:t})}else"object"==typeof e?this._addTemplate(e):"string"==typeof e&&this._addTemplate({key:e});else console.error("[viewMgr](template): is no inited")}hasTemplate(e){return!!this._templateMap[e]}getTemplate(e){const t=this._templateMap[e];return t||console.warn(`template is not exit:${e}`),t}_addTemplate(e){if(!e)return;if(!this._inited)return void console.error("[viewMgr](_addTemplate): is no inited");const t=e.key;"string"==typeof t&&""!==t?this._templateMap[t]?console.error(`[viewMgr](_addTemplate): [key:${t}] is exit`):this._templateMap[t]=e:console.error("[viewMgr](_addTemplate): key is null")}getPreloadResInfo(e){const t=this.getTemplate(e);if(t)return this._templateHandler.getPreloadResInfo(t)}preloadResById(e,t,i,o){var s,n;if(!this._inited)return void console.error("viewMgr is no inited");let a,l;l="object"==typeof e?e:{id:e},a=this.getKeyById(l.id);const d=this.getTemplate(a);if(!d)return;l.template=d,t&&"function"==typeof t&&(l.complete=t),o&&"function"==typeof o&&(l.progress=o),void 0!==i&&(l.loadOption=i),d.loadOption&&(l.loadOption=Object.assign({},d.loadOption,l.loadOption));const r=this._templateHandler;r.loadRes&&!(null===(s=r.isLoaded)||void 0===s?void 0:s.call(r,d))?r.loadRes(l):null===(n=l.complete)||void 0===n||n.call(l)}cancelPreloadRes(e){if(!e)return;const t=this.getKeyById(e),i=this.getTemplate(t);this._templateHandler.cancelLoad(e,i)}preloadRes(e,...t){var i;if(!this._inited)return void console.error("[viewMgr](loadRess): is no inited");if(!e||e.includes("_$_")){const t=`key:${e} is id`;return void console.error(t)}let o;const s=t[0];"object"==typeof s?o=o:"function"==typeof s&&(o={complete:s,id:void 0});const n=t[1];o||(o={});const a=t[2];if(a){if("function"!=typeof a)return void console.error("arg progress is not a function");o.progress=a}o.id=this.createViewId(e);if(this.getTemplate(e))return void 0!==n&&(o.loadOption=n),this.preloadResById(o),o.id;{const t=`template:${e} not registed`;null===(i=null==o?void 0:o.complete)||void 0===i||i.call(o,t)}}destroyRes(e){const t=this.getTemplate(e);if(t){const e=this._templateHandler;if(e.destroyRes)return e.destroyRes(t);console.warn(`can not handle template:${t.key} destroyRes`)}}isPreloadResLoaded(e){if(!this._inited)return void console.error("viewMgr is no inited");let t;t="object"==typeof e?e:this.getTemplate(this.getKeyById(e));const i=this._templateHandler;return!i.isLoaded||i.isLoaded(t)}addTemplateResRef(e){if(e&&!e.isHoldTemplateResRef){const t=e.id,i=e.template;this._templateHandler.addResRef(t,i),e.isHoldTemplateResRef=!0}}decTemplateResRef(e){if(e&&e.isHoldTemplateResRef){const t=e.template,i=e.id;this._templateHandler.decResRef(i,t),e.isHoldTemplateResRef=!1}}create(e,t,i,o,s){if(!this._inited)return void console.error("[viewMgr](show) is no inited");let n;if("string"==typeof e)n={key:e,onInitData:t,onShowData:o,needShowView:i};else{if("object"!=typeof e)return void console.warn("(create) unknown param",e);n=e,void 0!==o&&(n.onShowData=o),void 0!==t&&(n.onInitData=t),void 0!==i&&(n.needShowView=i)}n.id=this.createViewId(n.key);const a=this.createViewState(n.id);return a?(s&&(a.cacheMode=s),"FOREVER"===a.cacheMode&&(this._viewStateMap[a.id]=a),this._showViewState(a,n),a):void 0}show(e,t,i){let o,s,n,a,l;if("string"==typeof e)a=e,l=a,s=!0;else{if("object"!=typeof e)return void console.warn("[viewMgr](show) unknown param",e);e.__$flag?(n=e,a=n.id,l=n.template.key):(o=e,o.id=o.key,void 0!==t&&(o.onShowData=t),void 0!==i&&(o.onInitData=i))}if(o||(o={id:a,key:l,onInitData:i,onShowData:t}),n||(n=this.getOrCreateViewState(o.id)),n)return s&&!n.cacheMode&&(n.cacheMode="FOREVER"),o.needShowView=!0,this._showViewState(n,o),null==n?void 0:n.id}_showViewState(e,t){var i,o;if(!this._inited)return void console.error("viewMgr is no inited");if(!e)return;e.onShow(t);const s=e.cacheMode;s&&"FOREVER"!==s&&(null===(o=null===(i=this._cacheHandler)||void 0===i?void 0:i.onViewStateShow)||void 0===o||o.call(i,e))}update(e,t){var i,o;if(!this._inited)return void console.error("viewMgr is no inited");let s="object"==typeof e?e:void 0;if(s="object"==typeof e?e:this.getViewState(e),!s)return;s.onUpdate(t);const n=s.cacheMode;n&&"FOREVER"!==n&&(null===(o=null===(i=this._cacheHandler)||void 0===i?void 0:i.onViewStateUpdate)||void 0===o||o.call(i,s))}hide(e,t){var i,o;if(!this._inited)return void console.error("viewMgr is no inited");let s="object"==typeof e?e:void 0;if(s="object"==typeof e?e:this.getViewState(e),!s)return;const n=s.cacheMode;s.onHide(t),n&&"FOREVER"!==n&&(null===(o=null===(i=this._cacheHandler)||void 0===i?void 0:i.onViewStateHide)||void 0===o||o.call(i,s)),(null==t?void 0:t.destroyAfterHide)&&this.deleteViewState(s.id)}destroy(e,t){var i,o;if(!this._inited)return void console.error("viewMgr is no inited");let s="object"==typeof e?e:void 0;s="object"==typeof e?e:this.getViewState(e);const n=s.cacheMode;s.onDestroy(t),n&&"FOREVER"!==n&&(null===(o=null===(i=this._cacheHandler)||void 0===i?void 0:i.onViewStateDestroy)||void 0===o||o.call(i,s)),this.deleteViewState(e)}isViewInited(e){let t;return t="object"!=typeof e?this.getViewState(e):e,null==t?void 0:t.isViewInited}isViewShowed(e){let t;return t="object"!=typeof e?this.getViewState(e):e,null==t?void 0:t.isViewShowed}createView(e){const t=e.template;let i=e.viewIns;return i||(i=this._templateHandler.createView(t),i?(i.viewState=e,e.viewIns=i,i.key=t.key):console.warn(`key:${t.key} ins fail`),i)}getViewState(e){return this._viewStateMap[e]}getOrCreateViewState(e){let t=this._viewStateMap[e];return t||(t=this.createViewState(e)),t?this._viewStateMap[e]=t:console.error(`id:${e},viewState is null`),t}createViewState(e){var t,i;let s;const n=this.getKeyById(e),a=this.getTemplate(n);if(a)return s=null===(i=(t=this._templateHandler).createViewState)||void 0===i?void 0:i.call(t,a),s||(s=new o),s&&(s.onCreate(Object.assign({},this._viewStateCreateOption,a.viewStateCreateOption)),s.id=e,s.viewMgr=this,s.template=a,s.cacheMode||(s.cacheMode=a.cacheMode),s.__$flag=1),s}deleteViewState(e){delete this._viewStateMap[e]}getViewIns(e){const t=this._viewStateMap[e];return null==t?void 0:t.viewIns}createViewId(e){return e.includes("_$_")?e:(this._viewCount++,`${e}_$_${this._viewCount}`)}getKeyById(e){if("string"==typeof e&&""!==e)return e.includes("_$_")?e.split("_$_")[0]:e}}export{l as ViewMgr,n as globalViewTemplateMap,a as viewTemplate};
