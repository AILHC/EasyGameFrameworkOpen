"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const e={};class t{constructor(){this.handleMethodMap=new Map}onRegist(){}onAkEvent(e,t,i,s,o){let n,a=this.handleMethodMap.get(e);a||(a=[],this.handleMethodMap.set(e,a)),t&&(n="object"==typeof t?t:{method:t,caller:i,args:s},o&&this.offAkEvent(e,n.method,n.caller),a.push(n))}onceAkEvent(e,t,i,s){const o={method:t,caller:i,args:s,once:!0};this.onAkEvent(e,o,null,null,!0)}offAkEvent(e,t,i){let s=this.handleMethodMap.get(e);if(s){let e;for(let o=s.length-1;o>=0;o--)e=s[o],e.method===t&&e.caller===i&&(s[o]=s[s.length-1],s.pop())}}emitAkEvent(e,t){let i=this.handleMethodMap.get(e);if(i){let e;for(let s=i.length-1;s>=0;s--)e=i[s],e.once&&(i[s]=i[i.length-1],i.pop()),e.method.call(e.caller,t,e.args)}}onAkViewEvent(e,t,i,s,o,n){const a=this.getIdEventKey(e,t);this.onAkEvent(a,i,s,o)}onceAkViewEvent(e,t,i,s,o){const n=this.getIdEventKey(e,t);this.onceAkEvent(n,i,s,o)}offAkViewEvent(e,t,i,s){const o=this.getIdEventKey(e,t);this.offAkEvent(o,i,s)}emitAkViewEvent(e,t,i){const s=this.getIdEventKey(e,t);i&&!i.viewId&&(i.viewId=e),this.emitAkEvent(s,i),this.emitAkEvent(t,i)}getIdEventKey(e,t){return e+"_*_"+t}}class i{constructor(e){this._option=e,this._templateLoadResConfigsMap={},this._loadedMap={},this._loadResIdMap={},this._resRefMap={},this._resInfoMap={},this._option||(this._option={})}createViewIns(e){const t=this._option;return t.createView&&t.createView(e)}addToLayer(e){const t=e.template,i=this._option;t.customHandleLayer||i.addToLayer&&i.addToLayer(e.viewIns)}removeFromLayer(e){const t=e.template,i=this._option;t.customHandleLayer||i.removeFromLayer&&i.removeFromLayer(e.viewIns)}destroyView(e,t){}getResInfo(e){const t=e.key,i=this._resInfoMap;let s=i[t];if(!s){s=e.getResInfo&&e.getResInfo();const o=this._option;s=s||o.getPreloadResInfo&&o.getPreloadResInfo(e),i[t]=s}return s}isLoaded(e){let t=this._loadedMap[e.key];if(!t){let i=this._option;t=!i.isLoaded||i.isLoaded(this.getResInfo(e))}return t}loadRes(e){var t;const i=e.id,s=e.template.key;let o,n=this._templateLoadResConfigsMap,a=n[s];if(a?o=Object.keys(a).length>0:(a={},n[s]=a),a[i]=e,o)return;const d=e=>{var t;const i=n[s];let o;e&&console.error(` templateKey ${s} load error:`,e),n[s]=void 0,Object.keys(i).length>0&&(e||(this._loadedMap[s]=!0));for(let s in i)o=i[s],o&&(null===(t=o.complete)||void 0===t||t.call(o,e),i[s]=void 0)},r=(...e)=>{const t=this._templateLoadResConfigsMap[s];let i;for(let s in t)i=t[s],i&&i.progress&&i.progress.apply(null,e)},h=this._option;if(h.loadRes){let i=null===(t=h.loadRes)||void 0===t?void 0:t.call(h,this.getResInfo(e.template),d,r,e.loadOption);this._loadResIdMap[s]=i}}cancelLoad(e,t){var i,s;let o=t.key;const n=this._templateLoadResConfigsMap[o];if(n){const t=n[e];t&&t.complete&&t.complete("cancel load",!0),delete n[e]}if(!Object.keys(n).length){const e=this._loadResIdMap;let n=e[o];n&&(e[o],null===(s=(i=this._option).cancelLoadRes)||void 0===s||s.call(i,n,this.getResInfo(t)))}}addResRef(e,t){var i,s;let o=this._resRefMap[e];o||(o=[],this._resRefMap[e]=o),o.push(e),null===(s=(i=this._option).addResRef)||void 0===s||s.call(i,t)}decResRef(e,t){var i,s;let o=this._resRefMap[e];if(o){const t=o.indexOf(e);t>-1&&(0===t?o.pop():o[t]=o.pop())}null===(s=(i=this._option).decResRef)||void 0===s||s.call(i,this.getResInfo(t)),o.length<=0&&(this._loadedMap[t.key]=!1)}destroyRes(e){var t,i;if(!e)return;const s=this._templateLoadResConfigsMap[e.key];if(s&&Object.keys(s).length)return!1;let o=this._resRefMap[e.key];return!(o&&o.length>0)&&(this._loadedMap[e.key]=!1,null===(i=(t=this._option).destroyRes)||void 0===i||i.call(t,this.getResInfo(e)),!0)}}
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function s(e,t,i,s){return new(i||(i=Promise))((function(o,n){function a(e){try{r(s.next(e))}catch(e){n(e)}}function d(e){try{r(s.throw(e))}catch(e){n(e)}}function r(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,d)}r((s=s.apply(e,t||[])).next())}))}class o{onCreate(e){this._isConstructed||(this._isConstructed=!0,this._option=e)}initAndShowView(){this.initView(),this.needShowView&&(this.isViewInited?this.showView():console.error(`id:${this.id} isViewInited is false`))}onShow(e){if(this.showCfg=e,this.needDestroy=!1,this.needShowView=e.needShowView,this._needDestroyRes=!1,(this.isViewShowed||this.hiding)&&(this.showingPromise&&(this.showingPromise=void 0),this.hidingPromise&&(this.hidingPromise=void 0),this.hideViewIns()),this.isHoldTemplateResRef||this.viewMgr.isPreloadResLoaded(this.id))this.initAndShowView();else if(!this.isLoading){const t=e=>{this.isLoading=!1,e||this.destroyed||this.initAndShowView()};this.isLoading=!0,this.viewMgr.preloadResById(this.id,t,e.loadOption)}}onUpdate(e){var t;if(this.destroyed)return;const i=this.viewIns;this.isViewInited?null===(t=null==i?void 0:i.onUpdateView)||void 0===t||t.call(i,e):this.updateState=e}onHide(e){var t,i;return s(this,void 0,void 0,(function*(){const s=this.viewIns;let o;if(this.hideCfg=e,this.hiding=!0,this.needDestroy=null===(t=this.hideCfg)||void 0===t?void 0:t.destroyAfterHide,this.showingPromise=void 0,this.isLoading&&(this.isLoading=!1,this.viewMgr.cancelPreloadRes(this.id)),this.viewMgr.eventBus.emitAkViewEvent("onViewHide",this.id),this.isViewShowed=!1,this.isViewShowEnd=!1,s&&(o=null===(i=s.onPlayAnim)||void 0===i?void 0:i.call(s,!1,null==e?void 0:e.hideOption),this.hidingPromise=o),o){if(yield o,this.hidingPromise!==o)return;this.hidingPromise=void 0}this.hideViewIns(),this.needDestroy&&this.entryDestroyed()}))}onDestroy(e){this.hidingPromise&&(this.hidingPromise=void 0),this.showingPromise&&(this.showingPromise=void 0),this.isLoading&&(this.isLoading=!1,this.viewMgr.cancelPreloadRes(this.id)),this._needDestroyRes=e,this.hideViewIns(),this.entryDestroyed()}initView(){var e;if(!this.isViewInited){const t=this.viewMgr.createViewIns(this);this.viewMgr.addTemplateResRef(this),!this.isViewInited&&t&&(null===(e=t.onInitView)||void 0===e||e.call(t,this.showCfg.onInitData),this.isViewInited=!0,this.viewMgr.eventBus.emitAkViewEvent("onViewInit",this.id))}}showView(){var e;const t=this.viewIns;null===(e=t.onBeforeViewShow)||void 0===e||e.call(t,this.showCfg.onShowData);const i=this.viewMgr,{tplHandler:s,eventBus:o}=i;o.onAkEvent("onWindowResize",t.onWindowResize,t),s&&s.addToLayer&&s.addToLayer(this),t.onShowView&&t.onShowView(this.showCfg.onShowData),o.emitAkViewEvent("onViewShow",this.id);const n=t.onPlayAnim&&t.onPlayAnim(!0);var a;this.showingPromise=n,this.isViewShowed=!0,this.needShowView=!1,this.updateState&&t.onUpdateView&&(t.onUpdateView(this.updateState),this.updateState=void 0),null!==(a=this.showingPromise)&&"object"==typeof a&&"function"==typeof a.then&&"function"==typeof a.catch?this.showingPromise.then((()=>{this.showingPromise===n&&(this.showingPromise=void 0,this.entryShowEnd())})):this.entryShowEnd()}entryShowEnd(){this.isViewShowEnd=!0,this.viewMgr.eventBus.emitAkViewEvent("onViewShowEnd",this.id)}hideViewIns(){this.hiding=!1,this.isViewShowed=!1,this.isViewShowEnd=!1;const e=this.hideCfg,t=this.viewIns,i=this.viewMgr,{eventBus:s,tplHandler:o}=i;t&&(o&&o.removeFromLayer&&o.removeFromLayer(this),t.onHideView&&t.onHideView(e&&e.hideOption),s.offAkEvent("onWindowResize",t.onWindowResize,t)),this._option.canDecTemplateResRefOnHide&&e&&e.decTemplateResRef&&i.decTemplateResRef(this),this.hideCfg=void 0,s.emitAkViewEvent("onViewHideEnd",this.id)}entryDestroyed(){var e;const t=this.viewMgr,i=this.viewIns;this.needDestroy=!1,this.destroyed=!0,this.isViewInited=!1,i&&(null===(e=i.onDestroyView)||void 0===e||e.call(i),this.viewIns=void 0);const s=this.template,o=t.tplHandler;null==o||o.destroyView(i,s),t.decTemplateResRef(this),(this._needDestroyRes||this._option.destroyResOnDestroy)&&t.destroyRes(s.key),this._needDestroyRes=!1,t.eventBus.emitAkViewEvent("onViewDestroyed",this.id)}}class n{constructor(e){this._option=e,this._option||(this._option={}),isNaN(this._option.fifoMaxSize)&&(this._option.fifoMaxSize=5),isNaN(this._option.lruMaxSize)&&(this._option.lruMaxSize=5),this.fifoQueue=new Map,this.lruQueue=new Map}onViewStateShow(e){this.put(e.id,e)}onViewStateUpdate(e){this.get(e.id)}onViewStateHide(e){}onViewStateDestroy(e){this.delete(e.id)}get(e){const t=this.lruQueue;let i;return this.fifoQueue.has(e)?(i=this.fifoQueue.get(e),this.fifoQueue.delete(e),t.set(e,i)):t.has(e)&&(i=t.get(e),t.delete(e),t.set(e,i)),i}put(e,t){const i=this._option.fifoMaxSize,s=this._option.lruMaxSize,o=this.lruQueue,n=this.fifoQueue;let a=!1;o.has(e)?a=o.delete(e):n.has(e)&&(a=n.delete(e)),a?(o.size>=s&&this.deleteViewStateInQueueByMaxSize(o,s),o.set(e,t)):n.size>=i&&this.deleteViewStateInQueueByMaxSize(n,i)}deleteViewStateInQueueByMaxSize(e,t){let i=e.size-t,s=0;for(let t of e.keys()){if(!(s<i))break;e.get(t).isViewShowed||e.delete(t),s++}}delete(e){this.fifoQueue.delete(e),this.lruQueue.delete(e)}}exports.DefaultPlugin=class{onUse(e){e=e||{},this.viewMgr._tplHandler=new i(e.tplHandlerOption),this.viewMgr._eventBus=new t,this.viewMgr._cacheHandler=new n(e.cacheHandlerOption),this.viewMgr.registViewStateClass("Default",o)}},exports.ViewMgr=class{constructor(){this._viewCount=0}get cacheHandler(){return this._cacheHandler}get eventBus(){return this._eventBus}get tplHandler(){return this._tplHandler}get option(){return this._option}getKey(e){return e}init(t){if(this._inited)return;t=t||{},this._eventBus=t.eventBus||{},this._cacheHandler=t.cacheHandler||{},this._viewStateMap={},this._tplHandler=t.tplHandler||{},this._option=t,this._vsCreateOpt=t.vsCreateOpt||{},this._vsClassMap={},this._vsClassMap.Default=t.defaultViewStateClass,this._inited=!0;const i=t.templateMap||e;this._templateMap=i?Object.assign({},i):{}}use(e,t){var i;e&&(e.viewMgr=this,null===(i=e.onUse)||void 0===i||i.call(e,t))}template(e){if(e)if(this._inited)if(Array.isArray(e)){let t;for(let i in e)t=e[i],"object"==typeof t?this._addTemplate(t):this._addTemplate({key:t})}else"object"==typeof e?this._addTemplate(e):"string"==typeof e&&this._addTemplate({key:e});else console.error("[viewMgr](template): is no inited")}hasTemplate(e){return!!this._templateMap[e]}getTemplate(e){const t=this._templateMap[e];return t||console.warn(`template is not exit:${e}`),t}registViewStateClass(e,t){this._vsClassMap[e]=t}_addTemplate(e){if(!e)return;if(!this._inited)return void console.error("[viewMgr](_addTemplate): is no inited");const t=e.key;"string"==typeof t&&""!==t?this._templateMap[t]?console.error(`[viewMgr](_addTemplate): [key:${t}] is exit`):this._templateMap[t]=e:console.error("[viewMgr](_addTemplate): key is null")}getTemplateResInfo(e){const t=this.getTemplate(e);if(t)return this._tplHandler.getResInfo(t)}preloadResById(e,t,i,s){var o,n;if(!this._inited)return void console.error("viewMgr is no inited");let a,d;d="object"==typeof e?e:{id:e},a=this.getKeyById(d.id);const r=this.getTemplate(a);if(!r)return;d.template=r,t&&"function"==typeof t&&(d.complete=t),s&&"function"==typeof s&&(d.progress=s),void 0!==i&&(d.loadOption=i),r.loadOption&&(d.loadOption=Object.assign({},r.loadOption,d.loadOption));const h=this._tplHandler;h.loadRes&&!(null===(o=h.isLoaded)||void 0===o?void 0:o.call(h,r))?h.loadRes(d):null===(n=d.complete)||void 0===n||n.call(d)}cancelPreloadRes(e){if(!e)return;const t=this.getKeyById(e),i=this.getTemplate(t);this._tplHandler.cancelLoad(e,i)}preloadRes(e,...t){var i;if(!this._inited)return void console.error("[ViewMgr.preloadRes] is no inited");if(!e||e.includes("_$_")){const t=`[ViewMgr.preloadRes] key:${e} is id`;return void console.error(t)}let s;const o=t[0];"object"==typeof o?s=s:"function"==typeof o&&(s={complete:o,id:void 0});const n=t[1];s||(s={});const a=t[2];if(a){if("function"!=typeof a)return void console.error("arg progress is not a function");s.progress=a}s.id=this.createViewId(e);if(this.getTemplate(e))return void 0!==n&&(s.loadOption=n),this.preloadResById(s),s.id;{const t=`template:${e} not registed`;null===(i=s.complete)||void 0===i||i.call(s,t)}}destroyRes(e){const t=this.getTemplate(e);return this._tplHandler.destroyRes(t)}isPreloadResLoaded(e){if(!this._inited)return void console.error("viewMgr is no inited");let t;t="object"==typeof e?e:this.getTemplate(this.getKeyById(e));const i=this._tplHandler;return!i.isLoaded||i.isLoaded(t)}addTemplateResRef(e){if(e&&!e.isHoldTemplateResRef){const t=e.id,i=e.template;this._tplHandler.addResRef(t,i),e.isHoldTemplateResRef=!0}}decTemplateResRef(e){if(e&&e.isHoldTemplateResRef){const t=e.template,i=e.id;this._tplHandler.decResRef(i,t),e.isHoldTemplateResRef=!1}}create(e,t,i,s,o){if(!this._inited)return void console.error("[viewMgr](show) is no inited");let n;if("string"==typeof e)n={key:e,onInitData:t,onShowData:s,needShowView:i};else{if("object"!=typeof e)return void console.warn("(create) unknown param",e);n=e,void 0!==s&&(n.onShowData=s),void 0!==t&&(n.onInitData=t),void 0!==i&&(n.needShowView=i)}n.id=this.createViewId(n.key);const a=this.createViewState(n.id);return a?(o&&(a.cacheMode=o),"FOREVER"===a.cacheMode&&(this._viewStateMap[a.id]=a),this._showViewState(a,n),a):void 0}show(e,t,i){let s,o,n,a,d;if("string"==typeof e)a=e,d=a,o=!0;else{if("object"!=typeof e)return void console.warn("[viewMgr](show) unknown param",e);e.__$flag?(n=e,a=n.id,d=n.template.key):(s=e,s.id=s.key,void 0!==t&&(s.onShowData=t),void 0!==i&&(s.onInitData=i))}return s||(s={id:a,key:d,onInitData:i,onShowData:t}),n||(n=this.getOrCreateViewState(s.id)),n&&(o&&!n.cacheMode&&(n.cacheMode="FOREVER"),s.needShowView=!0,this._showViewState(n,s)),n}_showViewState(e,t){var i,s;if(!this._inited)return void console.error("viewMgr is no inited");if(!e)return;e.onShow(t);const o=e.cacheMode;o&&"FOREVER"!==o&&(null===(s=(i=this._cacheHandler).onViewStateShow)||void 0===s||s.call(i,e))}update(e,t){var i,s;if(!this._inited)return void console.error("viewMgr is no inited");let o="object"==typeof e?e:void 0;if(o="object"==typeof e?e:this.getViewState(e),!o)return;o.onUpdate(t);const n=o.cacheMode;n&&"FOREVER"!==n&&(null===(s=(i=this._cacheHandler).onViewStateUpdate)||void 0===s||s.call(i,o))}hide(e,t){var i,s;if(!this._inited)return void console.error("viewMgr is no inited");let o="object"==typeof e?e:void 0;if(o="object"==typeof e?e:this.getViewState(e),!o)return;const n=o.cacheMode;o.onHide(t),n&&"FOREVER"!==n&&(null===(s=(i=this._cacheHandler).onViewStateHide)||void 0===s||s.call(i,o)),(null==t?void 0:t.destroyAfterHide)&&this.deleteViewState(o.id)}destroy(e,t){var i,s;if(!this._inited)return void console.error("viewMgr is no inited");let o="object"==typeof e?e:void 0;o="object"==typeof e?e:this.getViewState(e);const n=o.cacheMode;o.onDestroy(t),n&&"FOREVER"!==n&&(null===(s=(i=this._cacheHandler).onViewStateDestroy)||void 0===s||s.call(i,o)),this.deleteViewState(e)}isViewInited(e){let t;return t="object"!=typeof e?this.getViewState(e):e,t&&t.isViewInited}isViewShowed(e){let t;return t="object"!=typeof e?this.getViewState(e):e,t&&t.isViewShowed}createViewIns(e){const t=e.template;let i=e.viewIns;if(i)return i;let s=this._tplHandler;return i=t.viewClass&&new t.viewClass,i=i||s.createViewIns&&s.createViewIns(t),i?(i.viewState=e,e.viewIns=i,i.key=t.key):console.warn(`key:${t.key} ins fail`),i}getViewState(e){return this._viewStateMap[e]}getOrCreateViewState(e){let t=this._viewStateMap[e];return t||(t=this.createViewState(e)),t&&(this._viewStateMap[t.id]=t),t}createViewState(e){const t=this.getKeyById(e),i=this.getTemplate(t);if(!i)return;const s=i.vsClass||this._vsClassMap[i.vsClassType||"Default"];if(!s)return void console.error("viewStateType not regist");let o=new s;return o&&(o.onCreate(Object.assign({},this._vsCreateOpt,i.vsCreateOpt)),o.id=e,o.viewMgr=this,o.template=i,o.cacheMode||(o.cacheMode=i.cacheMode),o.__$flag=1),o}deleteViewState(e){delete this._viewStateMap[e]}getViewIns(e){const t=this._viewStateMap[e];return t&&t.viewIns}createViewId(e){return e.includes("_$_")?e:(this._viewCount++,`${e}_$_${this._viewCount}`)}getKeyById(e){if("string"==typeof e&&""!==e)return e.includes("_$_")?e.split("_$_")[0]:e}},exports.globalViewTemplateMap=e,exports.viewTemplate=function(t,i=e){const s=t.key;return i[s]?(console.error("template is exit"),!1):(i[s]=t,!0)};
