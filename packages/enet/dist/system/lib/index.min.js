System.register("@ailhc/enet",[],(function(t){"use strict";return{execute:function(){t({PackageType:void 0,SocketState:void 0});var e,n,o=t("DefaultNetEventHandler",function(){function t(){}return t.prototype.onStartConnenct=function(t){console.log("start connect:"+t.url+",opt:",t)},t.prototype.onConnectEnd=function(t,e){console.log("connect ok:"+t.url+",opt:",t),console.log("handshakeRes:",e)},t.prototype.onError=function(t,e){console.error("socket error,opt:",e),console.error(t)},t.prototype.onClosed=function(t,e){console.error("socket close,opt:",e),console.error(t)},t.prototype.onStartReconnect=function(t,e){console.log("start reconnect:"+e.url+",opt:",e)},t.prototype.onReconnecting=function(t,e,n){console.log("url:"+n.url+" reconnect count:"+t+",less count:"+e.reconnectCount+",opt:",n)},t.prototype.onReconnectEnd=function(t,e,n){console.log("url:"+n.url+"reconnect end "+(t?"ok":"fail")+" ,opt:",n)},t.prototype.onStartRequest=function(t,e){console.log("start request:"+t.protoKey+",id:"+t.reqId+",opt:",e),console.log("reqCfg:",t)},t.prototype.onData=function(t,e){console.log("data :"+t.key+",opt:",e)},t.prototype.onRequestTimeout=function(t,e){console.warn("request timeout:"+t.protoKey+",opt:",e)},t.prototype.onCustomError=function(t,e){console.error("proto key:"+t.key+",reqId:"+t.reqId+",code:"+t.code+",errorMsg:"+t.errorMsg+",opt:",e)},t.prototype.onKick=function(t,e){console.log("be kick,opt:",e)},t}());!function(t){t[t.HANDSHAKE=1]="HANDSHAKE",t[t.HANDSHAKE_ACK=2]="HANDSHAKE_ACK",t[t.HEARTBEAT=3]="HEARTBEAT",t[t.DATA=4]="DATA",t[t.KICK=5]="KICK"}(e||(e=t("PackageType",{}))),function(t){t[t.CONNECTING=0]="CONNECTING",t[t.OPEN=1]="OPEN",t[t.CLOSING=2]="CLOSING",t[t.CLOSED=3]="CLOSED"}(n||(n=t("SocketState",{})));var r=t("WSocket",function(){function t(){}return Object.defineProperty(t.prototype,"state",{get:function(){return this._sk?this._sk.readyState:n.CLOSED},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isConnected",{get:function(){return!!this._sk&&this._sk.readyState===n.OPEN},enumerable:!1,configurable:!0}),t.prototype.setEventHandler=function(t){this._eventHandler=t},t.prototype.connect=function(t){var e,n,o,r,i,s,c,a,h=t.url;if(!h){if(!t.host||!t.port)return!1;h=(t.protocol?"wss":"ws")+"://"+t.host+":"+t.port}t.url=h,this._sk&&this.close(!0),this._sk||(this._sk=new WebSocket(h),t.binaryType||(t.binaryType="arraybuffer"),this._sk.binaryType=t.binaryType,this._sk.onclose=(null===(e=this._eventHandler)||void 0===e?void 0:e.onSocketClosed)&&(null===(n=this._eventHandler)||void 0===n?void 0:n.onSocketClosed),this._sk.onerror=(null===(o=this._eventHandler)||void 0===o?void 0:o.onSocketError)&&(null===(r=this._eventHandler)||void 0===r?void 0:r.onSocketError),this._sk.onmessage=(null===(i=this._eventHandler)||void 0===i?void 0:i.onSocketMsg)&&(null===(s=this._eventHandler)||void 0===s?void 0:s.onSocketMsg),this._sk.onopen=(null===(c=this._eventHandler)||void 0===c?void 0:c.onSocketConnected)&&(null===(a=this._eventHandler)||void 0===a?void 0:a.onSocketConnected))},t.prototype.send=function(t){this._sk?this._sk.send(t):console.error("socket is null")},t.prototype.close=function(t){var e,n;if(this._sk){var o=this.isConnected;this._sk.close(),this._sk.onclose=null,this._sk.onerror=null,this._sk.onmessage=null,this._sk.onopen=null,this._sk=null,o&&(null===(e=this._eventHandler)||void 0===e?void 0:e.onSocketClosed)&&(null===(n=this._eventHandler)||void 0===n||n.onSocketClosed(t))}},t}()),i=(t("NetNode",function(){function t(){this._curReconnectCount=0,this._reqId=1}return Object.defineProperty(t.prototype,"socket",{get:function(){return this._socket},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"netEventHandler",{get:function(){return this._netEventHandler},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"protoHandler",{get:function(){return this._protoHandler},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"socketEventHandler",{get:function(){return this._socketEventHandler||(this._socketEventHandler={onSocketClosed:this._onSocketClosed.bind(this),onSocketConnected:this._onSocketConnected.bind(this),onSocketError:this._onSocketError.bind(this),onSocketMsg:this._onSocketMsg.bind(this)}),this._socketEventHandler},enumerable:!1,configurable:!0}),t.prototype.init=function(t){if(!this._inited){this._protoHandler=t&&t.protoHandler?t.protoHandler:new i,this._socket=t&&t.socket?t.socket:new r,this._netEventHandler=t&&t.netEventHandler?t.netEventHandler:new o,this._pushHandlerMap={},this._oncePushHandlerMap={},this._reqCfgMap={};var n=t&&t.reConnectCfg;n?(this._reConnectCfg=n,isNaN(n.reconnectCount)&&(this._reConnectCfg.reconnectCount=4),isNaN(n.connectTimeout)&&(this._reConnectCfg.connectTimeout=6e4)):this._reConnectCfg={reconnectCount:4,connectTimeout:6e4},this._gapThreashold=t&&!isNaN(t.heartbeatGapThreashold)?t.heartbeatGapThreashold:100,this._useCrypto=t&&t.useCrypto,this._inited=!0,this._socket.setEventHandler(this.socketEventHandler),this._pkgTypeHandlers={},this._pkgTypeHandlers[e.HANDSHAKE]=this._onHandshake.bind(this),this._pkgTypeHandlers[e.HEARTBEAT]=this._heartbeat.bind(this),this._pkgTypeHandlers[e.DATA]=this._onData.bind(this),this._pkgTypeHandlers[e.KICK]=this._onKick.bind(this)}},t.prototype.connect=function(t,e){var o=this._socket,r=o&&(o.state===n.CLOSING||o.state===n.CLOSED);if(this._inited&&r){"string"==typeof t&&(t={url:t,connectEnd:e}),e&&(t.connectEnd=e),this._connectOpt=t,this._socket.connect(t);var i=this._netEventHandler;i.onStartConnenct&&i.onStartConnenct(t)}else console.error("is not inited"+(o?" , socket state"+o.state:""))},t.prototype.disConnect=function(){this._socket.close(!0),this._heartbeatTimeId&&(clearTimeout(this._heartbeatTimeId),this._heartbeatTimeId=void 0),this._heartbeatTimeoutId&&(clearTimeout(this._heartbeatTimeoutId),this._heartbeatTimeoutId=void 0)},t.prototype.reConnect=function(){var t=this;if(this._inited&&this._socket)if(this._curReconnectCount>this._reConnectCfg.reconnectCount)this._stopReconnect(!1);else{if(!this._isReconnecting){var e=this._netEventHandler;e.onStartReconnect&&e.onStartReconnect(this._reConnectCfg,this._connectOpt)}this._isReconnecting=!0,this.connect(this._connectOpt),this._curReconnectCount++;var n=this._netEventHandler;n.onReconnecting&&n.onReconnecting(this._curReconnectCount,this._reConnectCfg,this._connectOpt),this._reconnectTimerId=setTimeout((function(){t.reConnect()}),this._reConnectCfg.connectTimeout)}},t.prototype.request=function(t,e,n,o){if(this._isSocketReady()){var r=this._reqId,i=this._protoHandler,s=i.encodeMsg({key:t,reqId:r,data:e},this._useCrypto);if(s){var c={reqId:r,protoKey:i.protoKey2Key(t),data:e,resHandler:n};o&&(c=Object.assign(c,o)),this._reqCfgMap[r]=c,this._reqId++,this._netEventHandler.onStartRequest&&this._netEventHandler.onStartRequest(c,this._connectOpt),this.send(s)}}},t.prototype.notify=function(t,e){if(this._isSocketReady()){var n=this._protoHandler.encodeMsg({key:t,data:e},this._useCrypto);this.send(n)}},t.prototype.send=function(t){this._socket.send(t)},t.prototype.onPush=function(t,e){var n=this._protoHandler.protoKey2Key(t);this._pushHandlerMap[n]?this._pushHandlerMap[n].push(e):this._pushHandlerMap[n]=[e]},t.prototype.oncePush=function(t,e){var n=this._protoHandler.protoKey2Key(t);this._oncePushHandlerMap[n]?this._oncePushHandlerMap[n].push(e):this._oncePushHandlerMap[n]=[e]},t.prototype.offPush=function(t,e,n,o){var r,i=this._protoHandler.protoKey2Key(t);if(r=o?this._oncePushHandlerMap[i]:this._pushHandlerMap[i])for(var s=void 0,c=void 0,a=r.length-1;a>-1;a--)c=!1,"function"==typeof(s=r[a])&&s===e?c=!0:"object"!=typeof s||s.method!==e||n&&n!==s.context||(c=!0),c&&(a!==r.length&&(r[a]=r[r.length-1],r[r.length-1]=s),r.pop())},t.prototype.offPushAll=function(t){if(t){var e=this._protoHandler.protoKey2Key(t);delete this._pushHandlerMap[e],delete this._oncePushHandlerMap[e]}else this._pushHandlerMap={},this._oncePushHandlerMap={}},t.prototype._onHandshake=function(t){if(!t.errorMsg){this._handshakeInit(t);var n=this._protoHandler.encodePkg({type:e.HANDSHAKE_ACK});this.send(n);var o=this._connectOpt,r=this._protoHandler.handShakeRes;o.connectEnd&&o.connectEnd(r),this._netEventHandler.onConnectEnd&&this._netEventHandler.onConnectEnd(o,r)}},t.prototype._handshakeInit=function(t){var e=this.protoHandler.heartbeatConfig;this._heartbeatConfig=e},t.prototype._heartbeat=function(t){var n=this,o=this._heartbeatConfig,r=this._protoHandler;o&&o.heartbeatInterval&&(this._heartbeatTimeoutId||(this._heartbeatTimeId=setTimeout((function(){n._heartbeatTimeId=void 0;var t=r.encodePkg({type:e.HEARTBEAT},n._useCrypto);n.send(t),n._nextHeartbeatTimeoutTime=Date.now()+o.heartbeatTimeout,n._heartbeatTimeoutId=setTimeout(n._heartbeatTimeoutCb.bind(n),o.heartbeatTimeout)}),o.heartbeatInterval)))},t.prototype._heartbeatTimeoutCb=function(){var t=this._nextHeartbeatTimeoutTime-Date.now();t>this._reConnectCfg?this._heartbeatTimeoutId=setTimeout(this._heartbeatTimeoutCb.bind(this),t):(console.error("server heartbeat timeout"),this.disConnect())},t.prototype._onData=function(t){if(!t.errorMsg){var e;if(!isNaN(t.reqId)&&t.reqId>0){var n=t.reqId;if(!(e=this._reqCfgMap[n]))return;e.decodePkg=t,this._runHandler(e.resHandler,t)}else{var o=t.key,r=this._pushHandlerMap[o],i=this._oncePushHandlerMap[o];if(r?i&&(r=r.concat(i)):r=i,delete this._oncePushHandlerMap[o],r)for(var s=0;s<r.length;s++)this._runHandler(r[s],t)}var c=this._netEventHandler;c.onData&&c.onData(t,this._connectOpt,e)}},t.prototype._onKick=function(t){this._netEventHandler.onKick&&this._netEventHandler.onKick(t,this._connectOpt)},t.prototype._isSocketReady=function(){var t=this._socket,e=t&&(t.state===n.CONNECTING||t.state===n.OPEN);return!(!this._inited||!e)||(console.error(this._inited?e?"socket is ready":"socket is null or unready":"netNode is unInited"),!1)},t.prototype._onSocketConnected=function(t){if(this._isReconnecting)this._stopReconnect();else{var n=this._netEventHandler,o=this._connectOpt,r=this._protoHandler;if(r&&o.handShakeReq){var i=r.encodePkg({type:e.HANDSHAKE,data:o.handShakeReq});this.send(i)}else o.connectEnd&&o.connectEnd(),n.onConnectEnd&&n.onConnectEnd(o)}},t.prototype._onSocketError=function(t){var e=this._netEventHandler;e.onError&&e.onError(t,this._connectOpt)},t.prototype._onSocketMsg=function(t){var e=this._protoHandler.decodePkg(t.data),n=this._netEventHandler,o=this._pkgTypeHandlers[e.type];o?o(e):console.error("There is no handler of this type:"+e.type),e.errorMsg&&n.onCustomError&&n.onCustomError(e,this._connectOpt),this._nextHeartbeatTimeoutTime&&(this._nextHeartbeatTimeoutTime=Date.now()+this._heartbeatConfig.heartbeatTimeout)},t.prototype._onSocketClosed=function(t){var e=this._netEventHandler;this._isReconnecting?(clearTimeout(this._reconnectTimerId),this.reConnect()):e.onClosed&&e.onClosed(t,this._connectOpt)},t.prototype._runHandler=function(t,e){"function"==typeof t?t(e):"object"==typeof t&&t.method&&t.method.apply(t.context,t.args?[e].concat(t.args):[e])},t.prototype._stopReconnect=function(t){if(void 0===t&&(t=!0),this._isReconnecting){this._isReconnecting=!1,clearTimeout(this._reconnectTimerId),this._curReconnectCount=0;var e=this._netEventHandler;e.onReconnectEnd&&e.onReconnectEnd(t,this._reConnectCfg,this._connectOpt)}},t}()),function(){function t(){}return Object.defineProperty(t.prototype,"handShakeRes",{get:function(){},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"heartbeatConfig",{get:function(){return this._heartbeatCfg},enumerable:!1,configurable:!0}),t.prototype.encodePkg=function(t,e){return JSON.stringify(t)},t.prototype.protoKey2Key=function(t){return t},t.prototype.encodeMsg=function(t,n){return JSON.stringify({type:e.DATA,data:t})},t.prototype.decodePkg=function(t){var n=JSON.parse(t),o=n.type;if(n.type===e.DATA){var r=n.data;return{key:r&&r.key,type:o,data:r.data,reqId:n.data&&n.data.reqId}}return o===e.HANDSHAKE&&(this._heartbeatCfg=n.data),{type:o,data:n.data}},t}())}}}));
