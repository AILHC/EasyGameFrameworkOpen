!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).enet={})}(this,(function(e){"use strict";var t,n,o=function(){function e(){}return e.prototype.onStartConnenct=function(e){console.log("start connect:"+e.url+",opt:",e)},e.prototype.onConnectEnd=function(e,t){console.log("connect ok:"+e.url+",opt:",e),console.log("handshakeRes:",t)},e.prototype.onError=function(e,t){console.error("socket error,opt:",t),console.error(e)},e.prototype.onClosed=function(e,t){console.error("socket close,opt:",t),console.error(e)},e.prototype.onStartReconnect=function(e,t){console.log("start reconnect:"+t.url+",opt:",t)},e.prototype.onReconnecting=function(e,t,n){console.log("url:"+n.url+" reconnect count:"+e+",less count:"+t.reconnectCount+",opt:",n)},e.prototype.onReconnectEnd=function(e,t,n){console.log("url:"+n.url+"reconnect end "+(e?"ok":"fail")+" ,opt:",n)},e.prototype.onStartRequest=function(e,t){console.log("start request:"+e.protoKey+",id:"+e.reqId+",opt:",t),console.log("reqCfg:",e)},e.prototype.onData=function(e,t){console.log("data :"+e.key+",opt:",t)},e.prototype.onRequestTimeout=function(e,t){console.warn("request timeout:"+e.protoKey+",opt:",t)},e.prototype.onCustomError=function(e,t){console.error("proto key:"+e.key+",reqId:"+e.reqId+",code:"+e.code+",errorMsg:"+e.errorMsg+",opt:",t)},e.prototype.onKick=function(e,t){console.log("be kick,opt:",t)},e}();(t=e.PackageType||(e.PackageType={}))[t.HANDSHAKE=1]="HANDSHAKE",t[t.HANDSHAKE_ACK=2]="HANDSHAKE_ACK",t[t.HEARTBEAT=3]="HEARTBEAT",t[t.DATA=4]="DATA",t[t.KICK=5]="KICK",(n=e.SocketState||(e.SocketState={}))[n.CONNECTING=0]="CONNECTING",n[n.OPEN=1]="OPEN",n[n.CLOSING=2]="CLOSING",n[n.CLOSED=3]="CLOSED";var r=function(){function t(){}return Object.defineProperty(t.prototype,"state",{get:function(){return this._sk?this._sk.readyState:e.SocketState.CLOSED},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isConnected",{get:function(){return!!this._sk&&this._sk.readyState===e.SocketState.OPEN},enumerable:!1,configurable:!0}),t.prototype.setEventHandler=function(e){this._eventHandler=e},t.prototype.connect=function(e){var t,n,o,r,i,s,a,c,h=e.url;if(!h){if(!e.host||!e.port)return!1;h=(e.protocol?"wss":"ws")+"://"+e.host+":"+e.port}e.url=h,this._sk&&this.close(!0),this._sk||(this._sk=new WebSocket(h),e.binaryType||(e.binaryType="arraybuffer"),this._sk.binaryType=e.binaryType,this._sk.onclose=(null===(t=this._eventHandler)||void 0===t?void 0:t.onSocketClosed)&&(null===(n=this._eventHandler)||void 0===n?void 0:n.onSocketClosed),this._sk.onerror=(null===(o=this._eventHandler)||void 0===o?void 0:o.onSocketError)&&(null===(r=this._eventHandler)||void 0===r?void 0:r.onSocketError),this._sk.onmessage=(null===(i=this._eventHandler)||void 0===i?void 0:i.onSocketMsg)&&(null===(s=this._eventHandler)||void 0===s?void 0:s.onSocketMsg),this._sk.onopen=(null===(a=this._eventHandler)||void 0===a?void 0:a.onSocketConnected)&&(null===(c=this._eventHandler)||void 0===c?void 0:c.onSocketConnected))},t.prototype.send=function(e){this._sk?this._sk.send(e):console.error("socket is null")},t.prototype.close=function(e){var t,n;if(this._sk){var o=this.isConnected;this._sk.close(),this._sk.onclose=null,this._sk.onerror=null,this._sk.onmessage=null,this._sk.onopen=null,this._sk=null,o&&(null===(t=this._eventHandler)||void 0===t?void 0:t.onSocketClosed)&&(null===(n=this._eventHandler)||void 0===n||n.onSocketClosed(e))}},t}(),i=function(){function t(){this._curReconnectCount=0,this._reqId=1}return Object.defineProperty(t.prototype,"socket",{get:function(){return this._socket},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"netEventHandler",{get:function(){return this._netEventHandler},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"protoHandler",{get:function(){return this._protoHandler},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"socketEventHandler",{get:function(){return this._socketEventHandler||(this._socketEventHandler={onSocketClosed:this._onSocketClosed.bind(this),onSocketConnected:this._onSocketConnected.bind(this),onSocketError:this._onSocketError.bind(this),onSocketMsg:this._onSocketMsg.bind(this)}),this._socketEventHandler},enumerable:!1,configurable:!0}),t.prototype.init=function(t){if(!this._inited){this._protoHandler=t&&t.protoHandler?t.protoHandler:new s,this._socket=t&&t.socket?t.socket:new r,this._netEventHandler=t&&t.netEventHandler?t.netEventHandler:new o,this._pushHandlerMap={},this._oncePushHandlerMap={},this._reqCfgMap={};var n=t&&t.reConnectCfg;n?(this._reConnectCfg=n,isNaN(n.reconnectCount)&&(this._reConnectCfg.reconnectCount=4),isNaN(n.connectTimeout)&&(this._reConnectCfg.connectTimeout=6e4)):this._reConnectCfg={reconnectCount:4,connectTimeout:6e4},this._gapThreashold=t&&!isNaN(t.heartbeatGapThreashold)?t.heartbeatGapThreashold:100,this._useCrypto=t&&t.useCrypto,this._inited=!0,this._socket.setEventHandler(this.socketEventHandler),this._pkgTypeHandlers={},this._pkgTypeHandlers[e.PackageType.HANDSHAKE]=this._onHandshake.bind(this),this._pkgTypeHandlers[e.PackageType.HEARTBEAT]=this._heartbeat.bind(this),this._pkgTypeHandlers[e.PackageType.DATA]=this._onData.bind(this),this._pkgTypeHandlers[e.PackageType.KICK]=this._onKick.bind(this)}},t.prototype.connect=function(t,n){var o=this._socket,r=o&&(o.state===e.SocketState.CLOSING||o.state===e.SocketState.CLOSED);if(this._inited&&r){"string"==typeof t&&(t={url:t,connectEnd:n}),n&&(t.connectEnd=n),this._connectOpt=t,this._socket.connect(t);var i=this._netEventHandler;i.onStartConnenct&&i.onStartConnenct(t)}else console.error("is not inited"+(o?" , socket state"+o.state:""))},t.prototype.disConnect=function(){this._socket.close(!0),this._heartbeatTimeId&&(clearTimeout(this._heartbeatTimeId),this._heartbeatTimeId=void 0),this._heartbeatTimeoutId&&(clearTimeout(this._heartbeatTimeoutId),this._heartbeatTimeoutId=void 0)},t.prototype.reConnect=function(){var e=this;if(this._inited&&this._socket)if(this._curReconnectCount>this._reConnectCfg.reconnectCount)this._stopReconnect(!1);else{if(!this._isReconnecting){var t=this._netEventHandler;t.onStartReconnect&&t.onStartReconnect(this._reConnectCfg,this._connectOpt)}this._isReconnecting=!0,this.connect(this._connectOpt),this._curReconnectCount++;var n=this._netEventHandler;n.onReconnecting&&n.onReconnecting(this._curReconnectCount,this._reConnectCfg,this._connectOpt),this._reconnectTimerId=setTimeout((function(){e.reConnect()}),this._reConnectCfg.connectTimeout)}},t.prototype.request=function(e,t,n,o){if(this._isSocketReady()){var r=this._reqId,i=this._protoHandler,s=i.encodeMsg({key:e,reqId:r,data:t},this._useCrypto);if(s){var a={reqId:r,protoKey:i.protoKey2Key(e),data:t,resHandler:n};o&&(a=Object.assign(a,o)),this._reqCfgMap[r]=a,this._reqId++,this._netEventHandler.onStartRequest&&this._netEventHandler.onStartRequest(a,this._connectOpt),this.send(s)}}},t.prototype.notify=function(e,t){if(this._isSocketReady()){var n=this._protoHandler.encodeMsg({key:e,data:t},this._useCrypto);this.send(n)}},t.prototype.send=function(e){this._socket.send(e)},t.prototype.onPush=function(e,t){var n=this._protoHandler.protoKey2Key(e);this._pushHandlerMap[n]?this._pushHandlerMap[n].push(t):this._pushHandlerMap[n]=[t]},t.prototype.oncePush=function(e,t){var n=this._protoHandler.protoKey2Key(e);this._oncePushHandlerMap[n]?this._oncePushHandlerMap[n].push(t):this._oncePushHandlerMap[n]=[t]},t.prototype.offPush=function(e,t,n,o){var r,i=this._protoHandler.protoKey2Key(e);if(r=o?this._oncePushHandlerMap[i]:this._pushHandlerMap[i])for(var s=void 0,a=void 0,c=r.length-1;c>-1;c--)a=!1,"function"==typeof(s=r[c])&&s===t?a=!0:"object"!=typeof s||s.method!==t||n&&n!==s.context||(a=!0),a&&(c!==r.length&&(r[c]=r[r.length-1],r[r.length-1]=s),r.pop())},t.prototype.offPushAll=function(e){if(e){var t=this._protoHandler.protoKey2Key(e);delete this._pushHandlerMap[t],delete this._oncePushHandlerMap[t]}else this._pushHandlerMap={},this._oncePushHandlerMap={}},t.prototype._onHandshake=function(t){if(!t.errorMsg){this._handshakeInit(t);var n=this._protoHandler.encodePkg({type:e.PackageType.HANDSHAKE_ACK});this.send(n);var o=this._connectOpt,r=this._protoHandler.handShakeRes;o.connectEnd&&o.connectEnd(r),this._netEventHandler.onConnectEnd&&this._netEventHandler.onConnectEnd(o,r)}},t.prototype._handshakeInit=function(e){var t=this.protoHandler.heartbeatConfig;this._heartbeatConfig=t},t.prototype._heartbeat=function(t){var n=this,o=this._heartbeatConfig,r=this._protoHandler;o&&o.heartbeatInterval&&(this._heartbeatTimeoutId||(this._heartbeatTimeId=setTimeout((function(){n._heartbeatTimeId=void 0;var t=r.encodePkg({type:e.PackageType.HEARTBEAT},n._useCrypto);n.send(t),n._nextHeartbeatTimeoutTime=Date.now()+o.heartbeatTimeout,n._heartbeatTimeoutId=setTimeout(n._heartbeatTimeoutCb.bind(n),o.heartbeatTimeout)}),o.heartbeatInterval)))},t.prototype._heartbeatTimeoutCb=function(){var e=this._nextHeartbeatTimeoutTime-Date.now();e>this._reConnectCfg?this._heartbeatTimeoutId=setTimeout(this._heartbeatTimeoutCb.bind(this),e):(console.error("server heartbeat timeout"),this.disConnect())},t.prototype._onData=function(e){if(!e.errorMsg){var t;if(!isNaN(e.reqId)&&e.reqId>0){var n=e.reqId;if(!(t=this._reqCfgMap[n]))return;t.decodePkg=e,this._runHandler(t.resHandler,e)}else{var o=e.key,r=this._pushHandlerMap[o],i=this._oncePushHandlerMap[o];if(r?i&&(r=r.concat(i)):r=i,delete this._oncePushHandlerMap[o],r)for(var s=0;s<r.length;s++)this._runHandler(r[s],e)}var a=this._netEventHandler;a.onData&&a.onData(e,this._connectOpt,t)}},t.prototype._onKick=function(e){this._netEventHandler.onKick&&this._netEventHandler.onKick(e,this._connectOpt)},t.prototype._isSocketReady=function(){var t=this._socket,n=t&&(t.state===e.SocketState.CONNECTING||t.state===e.SocketState.OPEN);return!(!this._inited||!n)||(console.error(this._inited?n?"socket is ready":"socket is null or unready":"netNode is unInited"),!1)},t.prototype._onSocketConnected=function(t){if(this._isReconnecting)this._stopReconnect();else{var n=this._netEventHandler,o=this._connectOpt,r=this._protoHandler;if(r&&o.handShakeReq){var i=r.encodePkg({type:e.PackageType.HANDSHAKE,data:o.handShakeReq});this.send(i)}else o.connectEnd&&o.connectEnd(),n.onConnectEnd&&n.onConnectEnd(o)}},t.prototype._onSocketError=function(e){var t=this._netEventHandler;t.onError&&t.onError(e,this._connectOpt)},t.prototype._onSocketMsg=function(e){var t=this._protoHandler.decodePkg(e.data),n=this._netEventHandler,o=this._pkgTypeHandlers[t.type];o?o(t):console.error("There is no handler of this type:"+t.type),t.errorMsg&&n.onCustomError&&n.onCustomError(t,this._connectOpt),this._nextHeartbeatTimeoutTime&&(this._nextHeartbeatTimeoutTime=Date.now()+this._heartbeatConfig.heartbeatTimeout)},t.prototype._onSocketClosed=function(e){var t=this._netEventHandler;this._isReconnecting?(clearTimeout(this._reconnectTimerId),this.reConnect()):t.onClosed&&t.onClosed(e,this._connectOpt)},t.prototype._runHandler=function(e,t){"function"==typeof e?e(t):"object"==typeof e&&e.method&&e.method.apply(e.context,e.args?[t].concat(e.args):[t])},t.prototype._stopReconnect=function(e){if(void 0===e&&(e=!0),this._isReconnecting){this._isReconnecting=!1,clearTimeout(this._reconnectTimerId),this._curReconnectCount=0;var t=this._netEventHandler;t.onReconnectEnd&&t.onReconnectEnd(e,this._reConnectCfg,this._connectOpt)}},t}(),s=function(){function t(){}return Object.defineProperty(t.prototype,"handShakeRes",{get:function(){},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"heartbeatConfig",{get:function(){return this._heartbeatCfg},enumerable:!1,configurable:!0}),t.prototype.encodePkg=function(e,t){return JSON.stringify(e)},t.prototype.protoKey2Key=function(e){return e},t.prototype.encodeMsg=function(t,n){return JSON.stringify({type:e.PackageType.DATA,data:t})},t.prototype.decodePkg=function(t){var n=JSON.parse(t),o=n.type;if(n.type===e.PackageType.DATA){var r=n.data;return{key:r&&r.key,type:o,data:r.data,reqId:n.data&&n.data.reqId}}return o===e.PackageType.HANDSHAKE&&(this._heartbeatCfg=n.data),{type:o,data:n.data}},t}();e.DefaultNetEventHandler=o,e.NetNode=i,e.WSocket=r,Object.defineProperty(e,"__esModule",{value:!0})}));var globalTarget=window||global;globalTarget.enet?Object.assign({},globalTarget.enet):globalTarget.enet=enet;
