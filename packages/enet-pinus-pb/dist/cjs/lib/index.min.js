"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t,e=function(){function t(){}return t.LITTLE_ENDIAN="littleEndian",t.BIG_ENDIAN="bigEndian",t}(),i=function(){function t(t,i){void 0===i&&(i=0),this.bufferExtSize=0,this.EOF_byte=-1,this.EOF_code_point=-1,i<0&&(i=0),this.bufferExtSize=i;var n,r=0;if(t){var o=void 0;if(t instanceof Uint8Array?(o=t,r=t.length):(r=t.byteLength,o=new Uint8Array(t)),0===i)n=new Uint8Array(r);else n=new Uint8Array((1+(r/i|0))*i);n.set(o)}else n=new Uint8Array(i);this.write_position=r,this._position=0,this._bytes=n,this.data=new DataView(n.buffer),this.endian=e.BIG_ENDIAN}return Object.defineProperty(t.prototype,"endian",{get:function(){return 0===this.$endian?e.LITTLE_ENDIAN:e.BIG_ENDIAN},set:function(t){this.$endian=t===e.LITTLE_ENDIAN?0:1},enumerable:!1,configurable:!0}),t.prototype.setArrayBuffer=function(t){},Object.defineProperty(t.prototype,"readAvailable",{get:function(){return this.write_position-this._position},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buffer",{get:function(){return this.data.buffer.slice(0,this.write_position)},set:function(t){var e,i=t.byteLength,n=new Uint8Array(t),r=this.bufferExtSize;0===r?e=new Uint8Array(i):e=new Uint8Array((1+(i/r|0))*r);e.set(n),this.write_position=i,this._bytes=e,this.data=new DataView(e.buffer)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rawBuffer",{get:function(){return this.data.buffer},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"bytes",{get:function(){return this._bytes},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dataView",{get:function(){return this.data},set:function(t){this.buffer=t.buffer},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"bufferOffset",{get:function(){return this.data.byteOffset},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"position",{get:function(){return this._position},set:function(t){this._position=t,t>this.write_position&&(this.write_position=t)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"length",{get:function(){return this.write_position},set:function(t){this.write_position=t,this.data.byteLength>t&&(this._position=t),this._validateBuffer(t)},enumerable:!1,configurable:!0}),t.prototype._validateBuffer=function(t){if(this.data.byteLength<t){var e=this.bufferExtSize,i=void 0;if(0===e)i=new Uint8Array(t);else i=new Uint8Array((1+(t/e>>0))*e);i.set(this._bytes),this._bytes=i,this.data=new DataView(i.buffer)}},Object.defineProperty(t.prototype,"bytesAvailable",{get:function(){return this.data.byteLength-this._position},enumerable:!1,configurable:!0}),t.prototype.clear=function(){var t=new ArrayBuffer(this.bufferExtSize);this.data=new DataView(t),this._bytes=new Uint8Array(t),this._position=0,this.write_position=0},t.prototype.readBoolean=function(){if(this.validate(1))return!!this._bytes[this.position++]},t.prototype.readByte=function(){if(this.validate(1))return this.data.getInt8(this.position++)},t.prototype.readBytes=function(t,e,i){if(void 0===e&&(e=0),void 0===i&&(i=0),t){var n=this._position,r=this.write_position-n;if(r<0)throw new Error("1025");if(0===i)i=r;else if(i>r)throw new Error("1025");t.validateBuffer(e+i),t._bytes.set(this._bytes.subarray(n,n+i),e),this.position+=i}},t.prototype.readDouble=function(){if(this.validate(8)){var t=this.data.getFloat64(this._position,0===this.$endian);return this.position+=8,t}},t.prototype.readFloat=function(){if(this.validate(4)){var t=this.data.getFloat32(this._position,0===this.$endian);return this.position+=4,t}},t.prototype.readInt=function(){if(this.validate(4)){var t=this.data.getInt32(this._position,0===this.$endian);return this.position+=4,t}},t.prototype.readShort=function(){if(this.validate(2)){var t=this.data.getInt16(this._position,0===this.$endian);return this.position+=2,t}},t.prototype.readUnsignedByte=function(){if(this.validate(1))return this._bytes[this.position++]},t.prototype.readUnsignedInt=function(){if(this.validate(4)){var t=this.data.getUint32(this._position,0===this.$endian);return this.position+=4,t}},t.prototype.readUnsignedShort=function(){if(this.validate(2)){var t=this.data.getUint16(this._position,0===this.$endian);return this.position+=2,t}},t.prototype.readUTF=function(){var t=this.readUnsignedShort();return t>0?this.readUTFBytes(t):""},t.prototype.readUTFBytes=function(t){if(this.validate(t)){var e=this.data,i=new Uint8Array(e.buffer,e.byteOffset+this._position,t);return this.position+=t,this.decodeUTF8(i)}},t.prototype.writeBoolean=function(t){this.validateBuffer(1),this._bytes[this.position++]=+t},t.prototype.writeByte=function(t){this.validateBuffer(1),this._bytes[this.position++]=255&t},t.prototype.writeBytes=function(t,e,i){var n;void 0===e&&(e=0),void 0===i&&(i=0),e<0||i<0||(n=0===i?t.length-e:Math.min(t.length-e,i))>0&&(this.validateBuffer(n),this._bytes.set(t._bytes.subarray(e,e+n),this._position),this.position=this._position+n)},t.prototype.writeDouble=function(t){this.validateBuffer(8),this.data.setFloat64(this._position,t,0===this.$endian),this.position+=8},t.prototype.writeFloat=function(t){this.validateBuffer(4),this.data.setFloat32(this._position,t,0===this.$endian),this.position+=4},t.prototype.writeInt=function(t){this.validateBuffer(4),this.data.setInt32(this._position,t,0===this.$endian),this.position+=4},t.prototype.writeShort=function(t){this.validateBuffer(2),this.data.setInt16(this._position,t,0===this.$endian),this.position+=2},t.prototype.writeUnsignedInt=function(t){this.validateBuffer(4),this.data.setUint32(this._position,t,0===this.$endian),this.position+=4},t.prototype.writeUnsignedShort=function(t){this.validateBuffer(2),this.data.setUint16(this._position,t,0===this.$endian),this.position+=2},t.prototype.writeUTF=function(t){var e=this.encodeUTF8(t),i=e.length;this.validateBuffer(2+i),this.data.setUint16(this._position,i,0===this.$endian),this.position+=2,this._writeUint8Array(e,!1)},t.prototype.writeUTFBytes=function(t){this._writeUint8Array(this.encodeUTF8(t))},t.prototype.toString=function(){return"[ByteArray] length:"+this.length+", bytesAvailable:"+this.bytesAvailable},t.prototype._writeUint8Array=function(t,e){void 0===e&&(e=!0);var i=this._position,n=i+t.length;e&&this.validateBuffer(n),this.bytes.set(t,i),this.position=n},t.prototype.validate=function(t){var e=this._bytes.length;if(e>0&&this._position+t<=e)return!0;console.error(1025)},t.prototype.validateBuffer=function(t){this.write_position=t>this.write_position?t:this.write_position,t+=this._position,this._validateBuffer(t)},t.prototype.encodeUTF8=function(t){for(var e=0,i=this.stringToCodePoints(t),n=[];i.length>e;){var r=i[e++];if(this.inRange(r,55296,57343))this.encoderError(r);else if(this.inRange(r,0,127))n.push(r);else{var o=void 0,s=void 0;for(this.inRange(r,128,2047)?(o=1,s=192):this.inRange(r,2048,65535)?(o=2,s=224):this.inRange(r,65536,1114111)&&(o=3,s=240),n.push(this.div(r,Math.pow(64,o))+s);o>0;){var a=this.div(r,Math.pow(64,o-1));n.push(128+a%64),o-=1}}}return new Uint8Array(n)},t.prototype.decodeUTF8=function(t){for(var e,i=!1,n=0,r="",o=0,s=0,a=0,h=0;t.length>n;){var d=t[n++];if(d===this.EOF_byte)e=0!==s?this.decoderError(i):this.EOF_code_point;else if(0===s)this.inRange(d,0,127)?e=d:(this.inRange(d,194,223)?(s=1,h=128,o=d-192):this.inRange(d,224,239)?(s=2,h=2048,o=d-224):this.inRange(d,240,244)?(s=3,h=65536,o=d-240):this.decoderError(i),o*=Math.pow(64,s),e=null);else if(this.inRange(d,128,191))if(a+=1,o+=(d-128)*Math.pow(64,s-a),a!==s)e=null;else{var f=o,p=h;o=0,s=0,a=0,h=0,e=this.inRange(f,p,1114111)&&!this.inRange(f,55296,57343)?f:this.decoderError(i,d)}else o=0,s=0,a=0,h=0,n--,e=this.decoderError(i,d);null!==e&&e!==this.EOF_code_point&&(e<=65535?e>0&&(r+=String.fromCharCode(e)):(e-=65536,r+=String.fromCharCode(55296+(e>>10&1023)),r+=String.fromCharCode(56320+(1023&e))))}return r},t.prototype.encoderError=function(t){console.error(1026,t)},t.prototype.decoderError=function(t,e){return t&&console.error(1027),e||65533},t.prototype.inRange=function(t,e,i){return e<=t&&t<=i},t.prototype.div=function(t,e){return Math.floor(t/e)},t.prototype.stringToCodePoints=function(t){for(var e=[],i=0,n=t.length;i<t.length;){var r=t.charCodeAt(i);if(this.inRange(r,55296,57343))if(this.inRange(r,56320,57343))e.push(65533);else if(i===n-1)e.push(65533);else{var o=t.charCodeAt(i+1);if(this.inRange(o,56320,57343)){var s=1023&r,a=1023&o;i+=1,e.push(65536+(s<<10)+a)}else e.push(65533)}else e.push(r);i+=1}return e},t}(),n=function(){function t(){}return t.init=function(t){this._clients=t&&t.client||{},this._servers=t&&t.server||{}},t.encode=function(t,e){var i=this._clients[t];return i?this.encodeProtos(i,e):null},t.decode=function(t,e){var i=this._servers[t];return i?this.decodeProtos(i,e):null},t.encodeProtos=function(t,e){var n=new i;for(var r in e)if(t[r]){var o=t[r];switch(o.option){case"optional":case"required":n.writeBytes(this.encodeTag(o.type,o.tag)),this.encodeProp(e[r],o.type,t,n);break;case"repeated":e[r]&&e[r].length>0&&this.encodeArray(e[r],o,t,n)}}return n},t.decodeProtos=function(t,e){for(var i={};e.bytesAvailable;){var n=this.getHead(e),r=t.__tags[n.tag];switch(t[r].option){case"optional":case"required":i[r]=this.decodeProp(t[r].type,t,e);break;case"repeated":i[r]||(i[r]=[]),this.decodeArray(i[r],t[r].type,t,e)}}return i},t.encodeTag=function(t,e){var i=void 0!==this.TYPES[t]?this.TYPES[t]:2;return this.encodeUInt32(e<<3|i)},t.getHead=function(t){var e=this.decodeUInt32(t);return{type:7&e,tag:e>>3}},t.encodeProp=function(t,n,r,o){switch(n){case"uInt32":o.writeBytes(this.encodeUInt32(t));break;case"int32":case"sInt32":o.writeBytes(this.encodeSInt32(t));break;case"float":var s=new i;s.endian=e.LITTLE_ENDIAN,s.writeFloat(t),o.writeBytes(s);break;case"double":var a=new i;a.endian=e.LITTLE_ENDIAN,a.writeDouble(t),o.writeBytes(a);break;case"string":o.writeBytes(this.encodeUInt32(t.length)),o.writeUTFBytes(t);break;default:var h=r.__messages[n]||this._clients["message "+n];if(h){var d=this.encodeProtos(h,t);o.writeBytes(this.encodeUInt32(d.length)),o.writeBytes(d)}}},t.decodeProp=function(n,r,o){switch(n){case"uInt32":return this.decodeUInt32(o);case"int32":case"sInt32":return this.decodeSInt32(o);case"float":var s=new i;return o.readBytes(s,0,4),s.endian=e.LITTLE_ENDIAN,o.readFloat(),s.readFloat();case"double":var a=new i;return o.readBytes(a,0,8),a.endian=e.LITTLE_ENDIAN,a.readDouble();case"string":var h=this.decodeUInt32(o);return o.readUTFBytes(h);default:var d=r&&(r.__messages[n]||this._servers["message "+n]);if(d){var f=this.decodeUInt32(o),p=void 0;return f&&(p=new i,o.readBytes(p,0,f)),!!f&&t.decodeProtos(d,p)}}},t.isSimpleType=function(t){return"uInt32"===t||"sInt32"===t||"int32"===t||"uInt64"===t||"sInt64"===t||"float"===t||"double"===t},t.encodeArray=function(t,e,i,n){if((0,this.isSimpleType)(e.type)){n.writeBytes(this.encodeTag(e.type,e.tag)),n.writeBytes(this.encodeUInt32(t.length));for(var r=this.encodeProp,o=0;o<t.length;o++)r(t[o],e.type,i,n)}else for(var s=this.encodeTag,a=0;a<t.length;a++)n.writeBytes(s(e.type,e.tag)),this.encodeProp(t[a],e.type,i,n)},t.decodeArray=function(t,e,i,n){var r=this.isSimpleType,o=this.decodeProp;if(r(e))for(var s=this.decodeUInt32(n),a=0;a<s;a++)t.push(o(e,i,n));else t.push(o(e,i,n))},t.encodeUInt32=function(t){var e=new i;do{var n=t%128,r=Math.floor(t/128);0!==r&&(n+=128),e.writeByte(n),t=r}while(0!==t);return e},t.decodeUInt32=function(t){for(var e=0,i=0;i<t.length;i++){var n=t.readUnsignedByte();if(e+=(127&n)*Math.pow(2,7*i),n<128)return e}return e},t.encodeSInt32=function(t){return t=t<0?2*Math.abs(t)-1:2*t,this.encodeUInt32(t)},t.decodeSInt32=function(t){var e=this.decodeUInt32(t);return e=(e%2+e)/2*(e%2==1?-1:1)},t.TYPES={uInt32:0,sInt32:0,int32:0,double:1,string:2,message:2,float:5},t._clients={},t._servers={},t}(),r=function(){function t(){}return t.strencode=function(t){var e=new i;return e.length=t.length,e.writeUTFBytes(t),e},t.strdecode=function(t){return t.readUTFBytes(t.bytesAvailable)},t}(),o=function(){function t(){}return t.init=function(t){this._names=t||{};var e=this._names,i=this._ids;for(var n in e)i[e[n]]=n},t.getID=function(t){return this._names[t]},t.getName=function(t){return this._ids[t]},t._ids={},t._names={},t}(),s=function(){function t(t){this.routeMap=t}return t.prototype.encode=function(e,s,a){var h=new i,d=e?t.TYPE_REQUEST:t.TYPE_NOTIFY,f=n.encode(s,a)||r.strencode(JSON.stringify(a)),p=o.getID(s)||s;if(h.writeByte(d<<1|("string"==typeof p?0:1)),e)do{var u=e%128,c=Math.floor(e/128);0!==c&&(u+=128),h.writeByte(u),e=c}while(0!==e);return p&&("string"==typeof p?(h.writeByte(255&p.length),h.writeUTFBytes(p)):(h.writeByte(p>>8&255),h.writeByte(255&p))),f&&h.writeBytes(f),h},t.prototype.decode=function(e){var i,s=e.readUnsignedByte(),a=s&t.MSG_COMPRESS_ROUTE_MASK,h=s>>1&t.MSG_TYPE_MASK,d=0;if(h===t.TYPE_REQUEST||h===t.TYPE_RESPONSE){var f=0,p=void 0;do{d+=(127&(p=e.readUnsignedByte()))*Math.pow(2,7*f),f++}while(p>=128)}if(h===t.TYPE_REQUEST||h===t.TYPE_NOTIFY||h===t.TYPE_PUSH)if(a)i=e.readUnsignedShort();else{var u=e.readUnsignedByte();i=u?e.readUTFBytes(u):""}else h===t.TYPE_RESPONSE&&(i=this.routeMap[d]);return d||"string"==typeof i||(i=o.getName(i)),{id:d,type:h,route:i,body:n.decode(i,e)||JSON.parse(r.strdecode(e))}},t.MSG_FLAG_BYTES=1,t.MSG_ROUTE_CODE_BYTES=2,t.MSG_ID_MAX_BYTES=5,t.MSG_ROUTE_LEN_BYTES=1,t.MSG_ROUTE_CODE_MAX=65535,t.MSG_COMPRESS_ROUTE_MASK=1,t.MSG_TYPE_MASK=7,t.TYPE_REQUEST=0,t.TYPE_NOTIFY=1,t.TYPE_RESPONSE=2,t.TYPE_PUSH=3,t}(),a=function(){function t(){}return t.prototype.encode=function(t,e){var n=e?e.length:0,r=new i;return r.writeByte(255&t),r.writeByte(n>>16&255),r.writeByte(n>>8&255),r.writeByte(255&n),e&&r.writeBytes(e,0,e.length),r},t.prototype.decode=function(t){var e,n=t.readUnsignedByte(),r=(t.readUnsignedByte()<<16|t.readUnsignedByte()<<8|t.readUnsignedByte())>>>0;return t.bytesAvailable>=r?(e=new i,r&&t.readBytes(e,0,r)):console.log("[Package] no enough length for current type:",n),{type:n,body:e,length:r}},t.TYPE_HANDSHAKE=1,t.TYPE_HANDSHAKE_ACK=2,t.TYPE_HEARTBEAT=3,t.TYPE_DATA=4,t.TYPE_KICK=5,t}();!function(t){t[t.HANDSHAKE=1]="HANDSHAKE",t[t.HANDSHAKE_ACK=2]="HANDSHAKE_ACK",t[t.HEARTBEAT=3]="HEARTBEAT",t[t.DATA=4]="DATA",t[t.KICK=5]="KICK"}(t||(t={}));var h=function(){function e(){this._reqIdRouteMap={},this.RES_OK=200,this.RES_FAIL=500,this.RES_OLD_CLIENT=501,this.JS_WS_CLIENT_TYPE="js-websocket",this.JS_WS_CLIENT_VERSION="0.0.5",this._msgUtil=new s(this._reqIdRouteMap),this._pkgUtil=new a,this._handshakeBuffer={sys:{type:this.JS_WS_CLIENT_TYPE,version:this.JS_WS_CLIENT_VERSION},user:{}}}return Object.defineProperty(e.prototype,"heartbeatConfig",{get:function(){return this._heartbeatConfig},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"handShakeRes",{get:function(){return this._handShakeRes},enumerable:!1,configurable:!0}),e.prototype.init=function(t,e){this._protoVersion=t.version||0;var i=t.server||{},r=t.client||{};e&&n.init({encoderProtos:r,decoderProtos:i})},e.prototype.handshakeInit=function(t){if(t.sys){o.init(t.sys.dict);var e=t.sys.protos;this._protoVersion=e.version||0,n.init(e)}t.sys&&t.sys.heartbeat&&(this._heartbeatConfig={heartbeatInterval:1e3*t.sys.heartbeat,heartbeatTimeout:1e3*t.sys.heartbeat*2}),this._handShakeRes=t},e.prototype.protoKey2Key=function(t){return t},e.prototype.encodePkg=function(e,i){var n;if(e.type===t.DATA){var o=e.data;!isNaN(o.reqId)&&o.reqId>0&&(this._reqIdRouteMap[o.reqId]=o.key),n=this._msgUtil.encode(o.reqId,o.key,o.data)}else e.type===t.HANDSHAKE&&(e.data&&(this._handshakeBuffer=Object.assign(this._handshakeBuffer,e.data)),n=r.strencode(JSON.stringify(this._handshakeBuffer)));return(n=this._pkgUtil.encode(e.type,n)).buffer},e.prototype.encodeMsg=function(e,i){return this.encodePkg({type:t.DATA,data:e},i)},e.prototype.decodePkg=function(e){var n=this._pkgUtil.decode(new i(e)),o={};if(n.type===a.TYPE_DATA){var s=this._msgUtil.decode(n.body);o.type=t.DATA,o.data=s.body,o.code=s.body.code,o.errorMsg=500===o.code?"\u670d\u52a1\u5668\u5185\u90e8\u9519\u8bef-Server Error":void 0,o.reqId=s.id,o.key=s.route}else if(n.type===a.TYPE_HANDSHAKE){var h=JSON.parse(r.strdecode(n.body)),d=void 0;h.code===this.RES_OLD_CLIENT&&(d="code:"+h.code+" \u534f\u8bae\u4e0d\u5339\u914d RES_OLD_CLIENT"),h.code!==this.RES_OK&&(d="code:"+h.code+" \u63e1\u624b\u5931\u8d25"),this.handshakeInit(h),o.type=t.HANDSHAKE,o.errorMsg=d,o.data=h,o.code=h.code}else n.type===a.TYPE_HEARTBEAT?o.type=t.HEARTBEAT:n.type===a.TYPE_KICK&&(o.type=t.KICK,o.data=JSON.parse(r.strdecode(n.body)));return o},e}();exports.ByteArray=i,exports.Endian=e,exports.Message=s,exports.Package=a,exports.PinusProtoHandler=h,exports.Protobuf=n,exports.Protocol=r,exports.Routedic=o;
