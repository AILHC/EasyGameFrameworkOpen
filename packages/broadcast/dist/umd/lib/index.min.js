!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).broadcast={})}(this,(function(t){"use strict";var e=function(){function t(){this.keys=new Proxy({},{get:function(t,e){return e}}),this._valueMap={},this._unuseHandlers=[]}return t.prototype.on=function(t,e,r,n,i){if("string"==typeof t){if(!e)return;this._addHandler(this._getHandler(t,e,r,n,i))}else if(this._isArr(t))for(var a=t,s=0;s<a.length;s++)this._addHandler(a[s]);else this._addHandler(t)},t.prototype.has=function(t){return this._handlerMap&&!!this._handlerMap[t]},t.prototype.offAllByContext=function(t){var e=this._handlerMap;if(t&&e)for(var r in e)e[r]&&this.off(r,null,t)},t.prototype.offAll=function(t){if(!this._isStringNull(t)){var e=this._handlerMap,r=this._stickHandlersMap,n=this._valueMap;if(r&&(r[t]=void 0),e){var i=e[t];if(this._isArr(i))for(var a=0;a<i.length;a++)this._recoverHandler(i[a]);else this._recoverHandler(i);e[t]=void 0}n&&(n[t]=void 0)}},t.prototype.off=function(t,e,r,n){if(!this._isStringNull(t)){var i=this._handlerMap;if(!i||!i[t])return this;var a=i[t];if(null!=a){var s=void 0;if(this._isArr(a)){for(var o=(s=a).length-1,l=o;l>=0;l--)!(a=s[l])||r&&a.context!==r||null!=e&&a.listener!==e||n&&!a.once||(l!==(o=s.length-1)&&(a=s[o],s[o]=s[l],s[l]=a),this._recoverHandler(s.pop()));s.length||(i[t]=void 0)}else r&&a.context!==r||null!=e&&a.listener!==e||n&&!a.once||(this._recoverHandler(a),i[t]=void 0)}return this}},t.prototype.broadcast=function(e,r,n,i){var a=this._handlerMap;if(a){var s=a[e];if(i){var o=this._valueMap;o||(o={},this._valueMap=o),o[e]=r}if(s)if(this._isArr(s)){for(var l=s,h=(p=void 0,l.length-1),d=h;d>=0;d--)p=l[d],r?t._runHandlerWithData(p,r,n):t._runHandler(p,n),p.once&&(p=l[h=l.length-1],l[h]=l[d],l[d]=p,this._recoverHandler(l.pop()));l.length||(this._handlerMap[e]=void 0)}else{var p=s;r?t._runHandlerWithData(p,r,n):t._runHandler(p,n),p.once&&(this._recoverHandler(p),this._handlerMap[e]=void 0)}}},t.prototype.stickyBroadcast=function(t,e,r,n){if(!this._isStringNull(t)){var i=this._handlerMap;if(i&&i[t])this.broadcast(t,e,r,n);else{var a=this._stickHandlersMap;a||(a={},this._stickHandlersMap=a);var s=a[t],o={key:t,value:e,callback:r,persistence:n};s?s.push(o):a[t]=[o]}}},t.prototype._isStringNull=function(t){return!t||""===t.trim()},t.prototype._isArr=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t._runHandlerWithData=function(t,e,r){if(null==t.listener)return null;var n;if(null==e){var i=t.args?t.args.unshift(r):[r];n=t.listener.apply(t.context,i)}else n=(t.args||e.unshift)&&t.args?t.listener.apply(t.context,[e,r].concat(t.args)):t.listener.apply(t.context,[e,r]);return n},t._runHandler=function(t,e){if(null==t.listener)return null;var r=t.args?t.args.unshift(e):[e];return t.listener.apply(t.context,r)},t.prototype._recoverHandler=function(t){t.args=void 0,t.context=void 0,t.listener=void 0,t.key=void 0,this._unuseHandlers.push(t)},t.prototype._getHandler=function(t,e,r,n,i){var a,s=this._unuseHandlers;return(a=s.length?s.pop():{}).key=t,a.listener=e,a.context=r,a.once=n,a.args=i,a},t.prototype._addHandler=function(t){var e=this._handlerMap;t.once&&this.off(t.key,t.listener,t.context,t.once),e||(e={},this._handlerMap=e);var r=e[t.key];r?this._isArr(r)?r.push(t):e[t.key]=[r,t]:e[t.key]=t;var n=this._stickHandlersMap;if(n){var i=n[t.key];if(i){for(var a,s=0;s<i.length;s++)a=i[s],this.broadcast(a.key,a.value,a.callback,a.persistence);n[a.key]=void 0}}t.key!==this.keys.onListenerOn&&this.broadcast(this.keys.onListenerOn,t.key)},t.prototype.value=function(t){return this._valueMap&&this._valueMap[t]},t.prototype.dispose=function(){this._handlerMap=void 0,this._stickHandlersMap=void 0,this._valueMap=void 0},t}();t.Broadcast=e,Object.defineProperty(t,"__esModule",{value:!0})}));var globalTarget=window||global;globalTarget.broadcast?Object.assign({},globalTarget.broadcast):globalTarget.broadcast=broadcast;
