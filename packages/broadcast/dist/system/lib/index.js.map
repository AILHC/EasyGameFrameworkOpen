{"version":3,"file":"index.js","sources":["../../../src/broadcast.ts"],"sourcesContent":["type IListenerHandler<T> = broadcast.IListenerHandler<T>;\nexport class Broadcast<KeyType extends broadcast.IMsgKey, T = any> {\n    public keyMap: { [key in keyof KeyType]: any };\n    private _valueMap: { [key in keyof KeyType]: any };\n    private _handlerMap: { [key in keyof KeyType]: IListenerHandler<KeyType> | IListenerHandler<KeyType>[] };\n    private _stickBroadcasterMap: { [key in keyof KeyType]: broadcast.IBroadcaster<KeyType>[] };\n    constructor() {\n        this.keyMap = new Proxy({} as any, {\n            get: (target, p) => {\n                return p;\n            }\n        })\n        this._valueMap = {} as any;\n\n    }\n    //注册\n    /**\n     * 注册事件\n     * @param key 事件名\n     * @param listener 监听回调\n     * @param context 上下文\n     * @param args 透传参数\n     * @param more 注册多个\n     */\n    public on(handler?: IListenerHandler<KeyType>[] | IListenerHandler<KeyType>) {\n        if (this._isArr(handler)) {\n            const handlers = (handler as IListenerHandler<KeyType>[]);\n            for (let i = 0; i < handlers.length; i++) {\n                this._addHandler(handlers[i]);\n            }\n        } else {\n            this._addHandler(handler as IListenerHandler<KeyType>);\n        }\n    }\n    public has(key: keyof KeyType) {\n        return this._handlerMap && !!this._handlerMap[key]\n    }\n\n    public offAllByContext(context: any) {\n        const handlerMap = this._handlerMap;\n        if (context && handlerMap) {\n            for (const key in handlerMap) {\n                if (handlerMap[key]) {\n                    this.off(key, null, context);\n                }\n\n            }\n        }\n    }\n    /**\n     * 注销\n     * @param key \n     */\n    public offAll(key?: keyof KeyType) {\n        if (this._isStringNull(key)) {\n            this._handlerMap = undefined;\n            this._stickBroadcasterMap = undefined;\n            this._valueMap = undefined;\n            return;\n        }\n        const handlerMap = this._handlerMap;\n        const stickyMap = this._stickBroadcasterMap;\n        const valueMap = this._valueMap;\n        if (stickyMap) stickyMap[key] = undefined;\n        if (handlerMap) handlerMap[key] = undefined;\n        if (valueMap) valueMap[key] = undefined;\n\n    }\n    public off(key: keyof KeyType, listener: broadcast.Listener, context?: any, onceOnly?: boolean) {\n        if (this._isStringNull(key)) return;\n        const handlerMap = this._handlerMap;\n        if (!handlerMap || !handlerMap[key]) return this;\n        let handler = handlerMap[key] as IListenerHandler<KeyType>;\n        if (handler !== undefined && handler !== null) {\n            let handlers: IListenerHandler<KeyType>[];\n            if (!this._isArr(handler)) {\n                if ((!context || handler.context === context)\n                    && (listener == null || handler.listener === listener)\n                    && (!onceOnly || handler.once)) {\n                    handlerMap[key] = undefined;\n                }\n            } else {\n                handlers = handler as any;\n                //倒序遍历做删除,将要删除的移到末尾，pop出去，时间复杂度O(1)\n                let endIndex = handlers.length - 1;\n                for (let i = endIndex; i >= 0; i--) {\n                    handler = handlers[i];\n                    if (handler && (!context || handler.context === context)\n                        && (listener == null || handler.listener === listener)\n                        && (!onceOnly || handler.once)) {\n                        endIndex = handlers.length - 1;\n                        if (i !== endIndex) {\n                            handler = handlers[endIndex];\n                            handlers[endIndex] = handlers[i];\n                            handlers[i] = handler;\n                        }\n                        handlers.pop();\n\n                    }\n                }\n                if (!handlers.length) {\n                    handlerMap[key] = undefined;\n                }\n                // let count: number = 0;\n                // for (let i: number = 0; i < handlers.length; i++) {\n                //     const item: IListenerHandler<KeyType> = handlers[i];\n                //     if (!item) {\n                //         count++;\n                //         continue;\n                //     }\n                //     if (item && (!context || item.context === context)\n                //         && (listener == null || item.listener === listener)\n                //         && (!onceOnly || item.once)) {\n                //         count++;\n                //         handlers[i] = undefined;\n                //     }\n                // }\n                // //如果全部移除，则删除索引\n                // if (count === handlers.length) {\n                //     handlerMap[key] = undefined;\n                // } else {\n                //     const newHandlers: IListenerHandler<KeyType>[] = [];\n                //     for (let i = 0; i < handlers.length; i++) {\n                //         handlers[i] && newHandlers.push(handlers[i]);\n                //     }\n                //     handlerMap[key] = newHandlers;\n                // }\n            }\n        }\n\n        return this;\n    }\n    //广播\n    /**\n     * 广播\n     * @param key 事件名\n     * @param value 数据\n     * @param callback 回调\n     * @param persistence 是否持久化数据\n     */\n    public broadcast<T = any>(key: keyof KeyType, value?: T, callback?: broadcast.ResultCallBack, persistence?: boolean) {\n        const handlerMap = this._handlerMap;\n        if (!handlerMap) return;\n        const handlers = handlerMap[key];\n        if (persistence) {\n            let valueMap = this._valueMap;\n            if (!valueMap) {\n                valueMap = {} as any;\n                this._valueMap = valueMap;\n            }\n            valueMap[key] = value;\n        }\n        if (!handlers) return;\n        if (!this._isArr(handlers)) {\n            const handler = handlers as IListenerHandler<KeyType>;\n            value ? Broadcast._runHandlerWithData(handler, value, callback) : Broadcast._runHandler(handler, callback);\n            if (handler.once) {\n                this._handlerMap[key] = undefined;\n            }\n        } else {\n            const handlerArr = handlers as IListenerHandler<KeyType>[];\n            let handler: IListenerHandler<KeyType>;\n            let endIndex = handlerArr.length - 1;\n            for (let i = endIndex; i >= 0; i--) {\n                handler = handlerArr[i];\n                value ? Broadcast._runHandlerWithData(handler, value, callback) : Broadcast._runHandler(handler, callback);\n                if (handler.once) {\n                    endIndex = handlerArr.length - 1;\n                    handler = handlerArr[endIndex];\n                    handlerArr[endIndex] = handlerArr[i];\n                    handlerArr[i] = handler;\n                    handlerArr.pop();\n                }\n            }\n            if (!handlerArr.length) {\n                this._handlerMap[key] = undefined;\n            }\n        }\n    }\n    /**\n     * 广播一条 指定 [key] 的粘性消息\n     * 如果广播系统中没有注册该类型的接收者，本条信息将被滞留在系统中。一旦有该类型接收者被注册，本条消息将会被立即发送给接收者\n     * 如果系统中已经注册有该类型的接收者，本条消息将会被立即发送给接收者。\n     * \n     * @param key 消息类型\n     * @param value 消息携带的数据。可以是任意类型或是null\n     * @param callback 能够收到接收器返回的消息\n     * @param persistence 是否持久化消息类型。持久化的消息可以在任意时刻通过 broadcast.value(key) 获取当前消息的数据包。默认情况下，未持久化的消息类型在没有接收者的时候会被移除，而持久化的消息类型则不会。开发者可以通过 [clear] 函数来移除持久化的消息类型。\n     */\n    public stickyBroadcast(key: keyof KeyType, value?: T, callback?: broadcast.ResultCallBack, persistence?: boolean) {\n        if (this._isStringNull(key)) return;\n        const handlerMap = this._handlerMap;\n        if (handlerMap && handlerMap[key]) {\n            this.broadcast(key, value, callback, persistence);\n        } else {\n            let stickyMap = this._stickBroadcasterMap;\n            if (!stickyMap) {\n                stickyMap = {} as any;\n                this._stickBroadcasterMap = stickyMap;\n            }\n            const broadcasters = stickyMap[key];\n            const broadcaster: broadcast.IBroadcaster<KeyType> = {\n                key: key,\n                value: value,\n                callback: callback,\n                persistence: persistence\n            };\n            if (!broadcasters) {\n                stickyMap[key] = [broadcaster]\n            } else {\n                broadcasters.push(broadcaster)\n            }\n        }\n    }\n    /**\n     * 字符串是否为空 undefined null \"\"\n     * @param str \n     */\n    protected _isStringNull(str: string | any) {\n        return !str || str.trim() === \"\";\n    }\n    /**\n     * 是否是数组\n     * @param target \n     */\n    protected _isArr(target: any) {\n        return Object.prototype.toString.call(target) === \"[object Array]\";\n    }\n    /**\n     * 将广播的数据作为参数，执行广播监听器的逻辑\n     * @param handler 广播监听器\n     * @param data 广播的消息数据\n     */\n    protected static _runHandlerWithData(handler: IListenerHandler<any>, data: any, callback: broadcast.Listener) {\n        if (handler.listener == null) return null;\n        let result: any;\n        if (data == null) {\n            const args = handler.args ? handler.args.unshift(callback) : [callback];\n            result = handler.listener.apply(handler.context, args);\n        }\n        else if (!handler.args && !data.unshift) result = handler.listener.apply(handler.context, [data, callback]);\n        else if (handler.args) result = handler.listener.apply(handler.context, [data, callback].concat(handler.args));\n        else result = handler.listener.apply(handler.context, [data, callback]);\n        return result;\n    }\n    /**\n     * 执行广播监听者的逻辑\n     * @param handler \n     */\n    protected static _runHandler(handler: IListenerHandler<any>, callback: broadcast.Listener) {\n        if (handler.listener == null) return null;\n        const args = handler.args ? handler.args.unshift(callback) : [callback];\n        const result: any = handler.listener.apply(handler.context, args);\n        return result;\n    }\n    /**\n     * 添加广播监听\n     * 如果是监听1次，则会移除上一次相同的监听\n     * 会判断是否有粘性广播，如果有就会触发广播\n     * @param handler \n     */\n    protected _addHandler(handler: IListenerHandler<KeyType>) {\n        let handlerMap = this._handlerMap;\n        if (handler.once) {\n            this.off(handler.key, handler.listener, handler.context, handler.once);\n        }\n        if (!handlerMap) {\n            handlerMap = {} as any;\n            this._handlerMap = handlerMap;\n        }\n        const events = handlerMap[handler.key];\n        if (events) {\n            if (this._isArr(events)) {\n                (events as IListenerHandler<KeyType>[]).push(handler);\n            } else {\n                handlerMap[handler.key] = [events as any, handler];\n            }\n        } else {\n            handlerMap[handler.key] = handler;\n        }\n        const stickyMap = this._stickBroadcasterMap;\n        if (stickyMap) {\n            const stickyBroadcasters = stickyMap[handler.key];\n            if (stickyBroadcasters) {\n                let broadcaster: broadcast.IBroadcaster<KeyType>;\n                for (let i = 0; i < stickyBroadcasters.length; i++) {\n                    broadcaster = stickyBroadcasters[i];\n                    this.broadcast(broadcaster.key, broadcaster.value, broadcaster.callback, broadcaster.persistence);\n                }\n                stickyMap[handler.key] = undefined;\n            }\n        }\n        if (handler.key !== this.keyMap.onListenerOn) {\n            this.broadcast(this.keyMap.onListenerOn, handler.key);\n        }\n\n    }\n    /**\n     * 取值\n     * @param key \n     */\n    public value(key: keyof KeyType): T[keyof T] {\n        return this._valueMap && this._valueMap[key];\n    }\n    /**\n     * 销毁广播系统\n     */\n    public dispose() {\n        this._handlerMap = undefined;\n        this._stickBroadcasterMap = undefined;\n        this._valueMap = undefined;\n    }\n\n}"],"names":[],"mappings":"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"}