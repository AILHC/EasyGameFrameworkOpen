import{platform as e}from"os";import{readFile as t}from"xlsx";import{join as r,isAbsolute as l,dirname as i,parse as n}from"path";import{deflateSync as o}from"zlib";import{statSync as a,readdirSync as s,existsSync as f,unlinkSync as c,ensureFileSync as u,writeFile as h,writeFileSync as d,readFileSync as g}from"fs-extra";import{createHash as p}from"crypto";import{all as m}from"micromatch";import{Worker as b}from"worker_threads";const v={};v.int=function(e,t){let r={};"string"==typeof t&&""!==t.trim()?r.value=t.includes(".")?parseFloat(t):parseInt(t):"number"==typeof t&&(r.value=t);return r},v.string=function(e,t){let r={};"string"==typeof t?""!==(t=t.trim())&&(r.value=t):r.value=t+"";return r},v["[int]"]=function(e,t){let r;t=(t=(t+"").replace(/\uff0c/g,",")).trim();const l={};if(""!==t)try{r=JSON.parse(t),l.value=r}catch(e){l.error=e}return l},v["[string]"]=function(e,t){t=(t=(t+"").replace(/\uff0c/g,",")).trim();let r,l={};if(""!==t)try{r=JSON.parse(t),l.value=r}catch(e){l.error=e}return l},v.json=function(e,t){let r,l;if(""!==(t=(t=(t+"").replace(/\uff0c/g,",")).trim()))try{r=JSON.parse(t)}catch(e){l=e,r=t}return{error:l,value:r}};const y="win32"===e()?"\n":"\r\n";var N;!function(e){e[e.info=0]="info",e[e.warn=1]="warn",e[e.error=2]="error",e[e.no=3]="no"}(N||(N={}));class P{static init(e){const t=e.logLevel?e.logLevel:"info";this._logLevel=N[t],this._enableOutPutLogFile=!1!==e.outputLogDirPath}static log(e,t="info"){if("no"!==t&&this._logLevel<=N[t])switch(t){case"error":console.error(e),this.hasError||(this.hasError=!0);break;case"info":console.log(e);break;case"warn":console.warn(e)}this._enableOutPutLogFile&&(this._logStr+=e+y)}static systemLog(e){console.log(e),this._enableOutPutLogFile&&(this._logStr+=e+y)}static get logStr(){if(!this._enableOutPutLogFile)return null;const e=this._logStr;return this._logStr="",e}}function F(e){return!e||void 0===e.v||("string"==typeof e.v?""===e.v:"number"==typeof e.v&&isNaN(e.v))}P._logStr="",P.hasError=!1;const T=90,D=65;function O(e){let t;for(let r=e.length-1;r>=0;r--){if(e[r]<90){e[r]+=1,t=!0;break}90===e[r]&&(e[r]=65)}return t||e.push(65),C(e)}function C(e){return String.fromCharCode(...e)}function S(e){const t=[];for(let r=0;r<e.length;r++)t.push(e.charCodeAt(r));return t}function w(e,t,r,l,i,n,o,a){const s=e["!ref"],f=parseInt(s.match(/\d+$/)[0]);let c,u,h=R(s.split(":")[1].match(/^[A-Za-z]+/)[0]),d=0;const g=S(r);for(let s=t;s<=f&&(!i||!i(e,s));s++){if(o&&o(e,s))continue;c=g.concat([]),u=r;let t=!n||!n(e,u);for(;t;)a&&a(e,u)||l(e,u,s),u=O(c),d=R(u),t=h>=d&&(!n||!n(e,u))}}function M(e,t,r,l,i,n,o,a){const s=e["!ref"],f=parseInt(s.match(/\d+$/)[0]),c=R(s.split(":")[1].match(/^[A-Za-z]+/)[0]);let u,h;u=S(r);let d=0;h=r;let g=!n||!n(e,h);for(;g;){if(!a||!a(e,h))for(let r=t;r<=f&&(!i||!i(e,r));r++)o&&o(e,r)||l(e,h,r);h=O(u),d=R(h),g=c>=d&&(!n||!n(e,h))}}let j={};function R(e){let t=j[e];if(!t){t=0;for(let r=0;r<e.length;r++)t+=e.charCodeAt(r);j[e]=t}return t}function x(e){return t(e.filePath,{type:_(e.fileExtName)?"string":"file"})}function _(e){return"csv"===e}var $;!function(e){e.vertical="vertical",e.horizontal="horizontal"}($||($={}));class k{constructor(){this._valueTransFuncMap=v}getTableDefine(e,t){const r=e.fileName,l={tableName:r};let i,n;const o=t.SheetNames;let a,s,f;for(let e=0;e<o.length&&(a=t.Sheets[o[e]],f=a.A1,F(f)||(s=this._getFirstCellValue(f),!s||s.tableNameInSheet!==r));e++);if(!s||s.tableNameInSheet!==r)return P.log(`\u8868\u683c\u4e0d\u89c4\u8303,\u8df3\u8fc7\u89e3\u6790,\u8def\u5f84:${e.filePath}`,"error"),null;if(l.tableType=s.tableType,l.tableType===$.vertical){l.verticalFieldDefine={};const e=l.verticalFieldDefine;e.textRow=1;for(let t=1;t<100&&(i="A"+t,n=a[i],F(n)||"NO"===n.v||"END"===n.v||"START"===n.v?l.startRow=t:"CLIENT"===n.v?e.fieldRow=t:"TYPE"===n.v&&(e.typeRow=t),!(l.startRow&&e.fieldRow&&e.typeRow));t++);l.startCol="B"}else if(l.tableType===$.horizontal){l.horizontalFieldDefine={};const e=l.horizontalFieldDefine;e.textCol="A",e.typeCol="B",e.fieldCol="C",l.startCol="E",l.startRow=2}return l}_getFirstCellValue(e){if(!e)return;const t=e.v.split(":");let r,l;return t.length>1?(r=t[1],l="H"===t[0]?$.horizontal:$.vertical):(r=t[0],l=$.vertical),{tableNameInSheet:r,tableType:l}}checkSheetCanParse(e,t,r){const l=t.A1,i=this._getFirstCellValue(l);return!(!l||!e)&&i.tableNameInSheet===e.tableName}isSheetRowEnd(e,t,r){if(r>1){const e=t["A"+(r-=1)];return e&&"END"===e.v}return!1}isSheetColEnd(e,t,r){return F(t[r+1])}checkRowNeedParse(e,t,r){const l=t["A"+r];return!l||"NO"!==l.v}parseVerticalCell(e,t,r,l,i){const n=this.getVerticalTableField(e,t,r,l);if(!n)return;const o=t[r+l];if(F(o))return;const a=this.transValue(e,n,o.v);a.error&&P.log(`!!!!!!!!!!!!!!!!!![-----\u89e3\u6790\u9519\u8bef-----]!!!!!!!!!!!!!!!!!!!!!!!!!\n[sheetName|\u5206\u8868\u540d]=> ${e.curSheetName}\n[row|\u884c]=> ${l}\n[col|\u5217]=> ${r}\n[field|\u5b57\u6bb5]=> ${n.originFieldName}\n[type|\u7c7b\u578b]=> ${n.originType}\n[error|\u9519\u8bef]=> ${"string"==typeof a.error?a.error:a.error.message}\n`,"error");const s=a.value;let f=e.mainKeyFieldName;f||(f=n.fieldName,e.mainKeyFieldName=n.fieldName,e.tableObj={});let c=e.curRowOrColObj;if(i&&(c={},e.curRowOrColObj=e.tableObj[s]=c),n.isMutiColObj){let e=c[n.fieldName];e||(e={},c[n.fieldName]=e),e[n.subFieldName]=s}else c[n.fieldName]=s}parseHorizontalCell(e,t,r,l,i){const n=this.getHorizontalTableField(e,t,r,l);if(!n)return;const o=t[r+l];if(F(o))return;const a=this.transValue(e,n,o.v);a.error&&P.log(`!!!!!!!!!!!!!!!!!![-----ParseError|\u89e3\u6790\u9519\u8bef-----]!!!!!!!!!!!!!!!!!!!!!!!!!\n[sheetName|\u5206\u8868\u540d]=> ${e.curSheetName}\n[row|\u884c]=> ${l}\n[col|\u5217]=> ${r}\n[field|\u5b57\u6bb5]=> ${n.originFieldName}\n[type|\u7c7b\u578b]=> ${n.originType}\n[error|\u9519\u8bef]=> ${"string"==typeof a.error?a.error:a.error.message}\n!!!!!!!!!!!!!!!!!![-----ParseError|\u89e3\u6790\u9519\u8bef-----]!!!!!!!!!!!!!!!!!!!!!!!!!\n`,"error");const s=a.value;if(e.tableObj||(e.tableObj={}),n.isMutiColObj){let t=e.tableObj[n.fieldName];t||(t={},e.tableObj[n.fieldName]=t),t[n.subFieldName]=s}else e.tableObj[n.fieldName]=s}getVerticalTableField(e,t,r,l){const i=e.tableDefine;let n=e.filedMap;n||(n={},e.filedMap=n);const o=i.verticalFieldDefine,a=t[r+o.fieldRow];let s;if(F(a)||(s=a.v),!s)return null;let f={};if(void 0!==n[s])return n[s];const c=t[r+o.textRow];F(c)||(f.text=c.v);let u=!1;const h=t[r+o.typeRow];if(F(h))return null;if(f.originType=h.v,f.originType.includes("mf:")){const e=f.originType.split(":");if(e.length<3)return null;f.type=e[2],u=!0}else f.type=f.originType;if(f.isMutiColObj=u,f.originFieldName=s,u){const e=f.originFieldName.split(":");if(e.length<2)return null;f.fieldName=e[0],f.subFieldName=e[1]}else f.fieldName=f.originFieldName;return n[r]=f,f}getHorizontalTableField(e,t,r,l){const i=e.tableDefine;let n=e.filedMap;n||(n={},e.filedMap=n);const o=i.horizontalFieldDefine,a=t[o.fieldCol+l];let s;if(F(a)||(s=a.v),!s)return null;if(void 0!==n[s])return n[s];let f={};const c=t[o.textCol+l];F(c)||(f.text=c.v);let u=!1;const h=t[o.typeCol+l];if(F(h))return null;if(f.originType=h.v,f.originType.includes("mf:")){const e=f.originType.split(":");if(e.length<3)return null;f.type=e[2],u=!0}else f.type=f.originType;if(f.isMutiColObj=u,f.originFieldName=s,u){const e=f.originFieldName.split(":");if(e.length<2)return null;f.fieldName=e[0],f.subFieldName=e[1]}else f.fieldName=f.originFieldName;return n[s]=f,f}checkColNeedParse(e,t,r){if(e.tableType===$.vertical){const l=e.verticalFieldDefine,i=t[r+l.typeRow],n=t[r+l.fieldRow];return!F(i)&&!F(n)}if(e.tableType===$.horizontal){return!F(t[r+1])}}transValue(e,t,r){let l,i=this._valueTransFuncMap[t.type];return i||(i=this._valueTransFuncMap.json),l=i(t,r),l}parseTableFile(e,t,r){const l=x(t);if(!l.SheetNames.length)return;const i=l.SheetNames,n=this.getTableDefine(t,l);for(let e=0;e<i.length;e++);if(!n)return null;let o,a;const s=this.isSheetRowEnd.bind(null,n),f=this.isSheetColEnd.bind(null,n),c=(e,t)=>!this.checkRowNeedParse(n,e,t),u=(e,t)=>!this.checkColNeedParse(n,e,t);let h;r.tableDefine=n,P.log(`[parseTable|\u89e3\u6790\u6587\u4ef6]=> ${t.filePath}`);for(let e=0;e<i.length;e++)if(o=i[e],a=l.Sheets[o],this.checkSheetCanParse(n,a,o))if(r.curSheetName=o,P.log(`|=[parseSheet|\u89e3\u6790\u5206\u8868]=> ${o}`),n.tableType===$.vertical){let e;w(a,n.startRow,n.startCol,((t,l,i)=>{let n=!1;e!==i&&(e=i,n=!0),h=t[l+i],F(h)||this.parseVerticalCell(r,t,l,i,n)}),s,f,c,u)}else if(n.tableType===$.horizontal){let e;M(a,n.startRow,n.startCol,((t,l,i)=>{let n=!1;e!==l&&(e=l,n=!0),h=t[l+i],F(h)||this.parseHorizontalCell(r,t,l,i,n)}),s,f,c,u)}return r}}class E{onStart(e,t){P.systemLog("convert-hook onStart"),t()}onParseBefore(e,t){P.systemLog("convert-hook onParseBefore"),t()}onParseAfter(e,t){e.outputTransformer.transform(e,t)}onWriteFileEnd(e){P.systemLog("convert-hook onWriteFileEnd \u5199\u5165\u7ed3\u675f")}}const I={int:"number",json:"any","[int]":"number[]","[string]":"string[]"};class L{transform(e,t){const l=e.convertConfig,i=e.parseResultMap;let n=l.outputConfig;if(!n)return void console.error("parseConfig.outputConfig is undefind");let a,s,f,c={},u={},h="",d="",g={};for(let e in i)a=i[e],a.tableDefine&&(s=a.tableDefine.tableName,f=c[s],f=f?Object.assign(f,a.tableObj):a.tableObj,c[s]=f,n.isGenDts&&void 0===g[s]&&(g[s]=a.tableDefine.tableType===$.horizontal,a.tableDefine.tableType===$.horizontal?h+="\treadonly "+s+"?: "+`IT_${s};`+y:h+=this._getOneTableTypeStr(s),void 0===n.isBundleDts&&(n.isBundleDts=!0),n.isBundleDts?d+=this._getSingleTableDts(a):this._addSingleTableDtsOutputFile(n,a,u)),n.clientSingleTableJsonDir&&this._addSingleTableJsonOutputFile(n,a,u));if(n.isGenDts){if(h="interface ITBase<T> { [key:string]:T}"+y+"interface IT_TableMap {"+y+h+"}"+y,n.isBundleDts){const e=n.bundleDtsFileName?n.bundleDtsFileName:"tableMap",t=r(n.clientDtsOutDir,`${e}.d.ts`);u[t]={filePath:t,data:h+d}}else{const e=r(n.clientDtsOutDir,"tableMap.d.ts");u[e]={filePath:e,data:h}}}if(n.clientBundleJsonOutPath){let e,t=n.clientBundleJsonOutPath;if(n.isCompress){const t={};let r,l;for(let e in c)if(g[e])t[e]=c[e];else{r=c[e],l={fieldValuesMap:{}};for(let e in r)l.fieldNames||(l.fieldNames=Object.keys(r[e])),l.fieldValuesMap[e]=Object.values(r[e]);t[e]=l}e=JSON.stringify(t)}else e=JSON.stringify(c);n.isZip&&(e=o(e)),u[t]={filePath:t,encoding:"string"!=typeof e?"binary":"utf-8",data:e}}if(e.outPutFileMap)for(let t in u)e.outPutFileMap[t]=u[t];else e.outPutFileMap=u;t()}_addSingleTableDtsOutputFile(e,t,l){if(!t.tableObj)return;let i=r(e.clientDtsOutDir,`${t.tableDefine.tableName}.d.ts`);if(!l[i]){const e=this._getSingleTableDts(t);e&&(l[i]={filePath:i,data:e})}}_getSingleTableDts(e){const t=e.tableDefine.tableName,r=e.filedMap;let l,i="interface IT_"+t+" {"+y,n={};for(let e in r)if(l=r[e],l)if(l.isMutiColObj){const e=l.fieldName;n[e]||(n[e]=""),n[e]+="\t\t/** "+l.text+" */"+y,n[e]+="\t\treadonly "+l.subFieldName+"?: "+(I[l.type]?I[l.type]:l.type)+";"+y}else i+="\t/** "+l.text+" */"+y,i+="\treadonly "+l.fieldName+"?: "+(I[l.type]?I[l.type]:l.type)+";"+y;for(let e in n)i+="\treadonly "+e+"?: {"+y+n[e],i+="\t}"+y;return i+="}"+y,i}_addSingleTableJsonOutputFile(e,t,l){const i=t.tableObj;if(!i)return;const n=t.tableDefine.tableName;let o=r(e.clientSingleTableJsonDir,`${n}.json`),a=JSON.stringify(i,null,"\t"),s=l[o];s?s.data=a:(s={filePath:o,data:a},l[o]=s)}_getOneTableTypeStr(e){return"\treadonly "+e+"?: ITBase<IT_"+e+">;"+y}}function z(e,t,r,l){let i;for(let n=t.length-1;n>=0;n--)i=r[t[n].filePath],i||(i={filePath:t[n].filePath}),i.tableObj||(i=l.parseTableFile(e,t[n],i)),i&&(r[t[n].filePath]=i)}
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function J(e,t,r,l){return new(r||(r=Promise))((function(i,n){function o(e){try{s(l.next(e))}catch(e){n(e)}}function a(e){try{s(l.throw(e))}catch(e){n(e)}}function s(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}s((l=l.apply(e,t||[])).next())}))}function A(e,t){if(a(e).isDirectory()){const i=s(e);let n;for(var l=0;l<i.length;l++)n=r(e,i[l]),A(n,t)}else t(e)}function B(e,t,r){let l;const i=e.length;if(e&&i){let n=0;const o=l=>{l&&P.log(l,"error"),n++,t&&t(e[n-1].filePath,i,n,!l),n>=i&&r&&r(i)};for(let t=e.length-1;t>=0;t--)if(l=e[t],l.isDelete&&f(l.filePath))c(l.filePath);else{if(f(l.filePath)&&a(l.filePath).isDirectory()){P.log(`\u8def\u5f84\u4e3a\u6587\u4ef6\u5939:${l.filePath}`,"error");continue}l.encoding||"string"!=typeof l.data||(l.encoding="utf8"),u(l.filePath),h(l.filePath,l.data,l.encoding?{encoding:l.encoding}:void 0,o)}}}function H(e,t,r){const l=q(t),i=Object.keys(l);let n;A(e,(e=>{var t=W(e);if((!l[e]||l[e]&&l[e]!==t)&&(l[e]=t,r(e,!1)),n=i.indexOf(e),n>-1){const e=i[i.length-1];i[n]=e,i.pop()}}));for(let e=0;e<i.length;e++)delete l[i[e]],r(i[e],!0);d(t,JSON.stringify(l),{encoding:"utf-8"})}function V(e,t){e?d(e,JSON.stringify(t),{encoding:"utf-8"}):P.log("cacheFilePath is null","error")}function q(e){if(!e)return void P.log("cacheFilePath is null","error");f(e)||(u(e),d(e,"{}",{encoding:"utf-8"}));const t=g(e,"utf-8");return JSON.parse(t)}function W(e){const t=g(e,"utf-8");var r=p("md5");return r.update(t),r.digest("hex")}function Z(e){return J(this,void 0,void 0,(function*(){return W(e)}))}function G(e){return J(this,void 0,void 0,(function*(){let t,o;e.projRoot||(e.projRoot=process.cwd()),t=e.customConvertHookPath?require(e.customConvertHookPath):new E,o=e.customOutPutTransformerPath?require(e.customOutPutTransformerPath):new L;const a=e.tableFileDir;if(!a)return void P.log("\u914d\u7f6e\u8868\u76ee\u5f55\uff1atableFileDir\u4e3a\u7a7a","error");if(!f(a))return void P.log(`\u914d\u7f6e\u8868\u6587\u4ef6\u5939\u4e0d\u5b58\u5728\uff1a${a}`,"error");const s=["**/*.{xlsx,csv}","!**/~$*.*","!**/~.*.*"];e.pattern||(e.pattern=s),e.useMultiThread&&isNaN(e.threadParseFileMaxNum)&&(e.threadParseFileMaxNum=5),P.init(e);const c={convertConfig:e,outputTransformer:o};yield new Promise((e=>{t.onStart(c,e)}));let u=[],h=[];const d=e.pattern,g=(e,t)=>{const r=(e=>{const t=n(e);return{filePath:e,fileName:t.name,fileExtName:t.ext,isDelete:!1}})(e);let l;return t?h.push(r):(l=m(r.filePath,d),l&&u.push(r)),{fileInfo:r,canRead:l}};let p,v,y={},N=e.cacheFileDirPath;if(e.useCache){N||(N=".excel2all"),l(N)||(N=r(e.projRoot,N)),p=r(N,".e2aprmc"),y=q(p),y||(y={});const t=Object.keys(y);let i,n;A(a,(e=>{var r=W(e);if(n=y[e],n||(n={filePath:e},y[e]=n),n&&n.md5hash!==r){const{fileInfo:t,canRead:l}=g(e,!1);l&&(n.md5hash=r)}if(i=t.indexOf(e),i>-1){const e=t[t.length-1];t[i]=e,t.pop()}}));for(let e=0;e<t.length;e++)delete y[t[e]],g(t[e],!0)}else A(a,g);if(e.customParseHandlerPath){if(v=require(e.customParseHandlerPath),!v||"function"!=typeof v.parseTableFile)return void console.error(`\u81ea\u5b9a\u4e49\u89e3\u6790\u5b9e\u73b0\u9519\u8bef:${e.customParseHandlerPath}`)}else v=new k;if(c.parseResultMap=y,c.deleteFileInfos=h,c.changedFileInfos=u,yield new Promise((e=>{t.onParseBefore(c,e)})),u.length>e.threadParseFileMaxNum&&e.useMultiThread){let l="";const n=Math.floor(u.length/e.threadParseFileMaxNum)+1;let o,a,s=0;const f=(new Date).getTime(),h=e=>{P.log(`----------------\u7ebf\u7a0b\u7ed3\u675f:${e.threadId}-----------------`);const r=e.parseResultMap;for(let e in r)y[e].tableDefine||(y[e]=r[e]);if(s++,l+=e.logStr+P.logStr,c.hasError||(c.hasError=P.hasError),s>=n){const e=(new Date).getTime();P.log("[\u591a\u7ebf\u7a0b\u5bfc\u8868\u65f6\u95f4]:"+(e-f)),K(c,p,t,l)}};for(let t=0;t<n;t++)a=u.splice(0,e.threadParseFileMaxNum),P.log(`----------------\u7ebf\u7a0b\u5f00\u59cb:${t}-----------------`),o=new b(r(i(__filename),"../../../worker_scripts/worker.js"),{workerData:{threadId:t,fileInfos:a,parseResultMap:y,convertConfig:e}}),o.on("message",h)}else{const r=(new Date).getTime();z(e,u,y,v);const l=(new Date).getTime();P.systemLog("[\u5355\u7ebf\u7a0b\u5bfc\u8868\u65f6\u95f4]:"+(l-r)),c.hasError=P.hasError,K(c,p,t)}}))}function K(e,t,i,n){return J(this,void 0,void 0,(function*(){const o=e.convertConfig,a=e.parseResultMap;if(o.useCache&&!e.hasError&&V(t,a),yield new Promise((t=>{i.onParseAfter(e,t)})),e.outPutFileMap){const t=e.outPutFileMap,r=Object.values(t);P.systemLog(`\u5f00\u59cb\u5199\u5165\u6587\u4ef6:0/${r.length}`),yield new Promise((e=>{B(r,((e,t,r,l)=>{P.log(`[\u5199\u5165\u6587\u4ef6] \u8fdb\u5ea6:(${r}/${t}) \u8def\u5f84:${e}`)}),(()=>{e()}))})),P.systemLog("\u5199\u5165\u7ed3\u675f~")}else P.systemLog("\u6ca1\u6709\u53ef\u5199\u5165\u6587\u4ef6~");if(n||(n=P.logStr),""!==n.trim()){let t=e.convertConfig.outputLogDirPath;t||(t=".excel2all"),l(t)||(t=r(e.convertConfig.projRoot,t));B([{filePath:r(t,"excel2all.log"),data:n}])}i.onWriteFileEnd(e)}))}function Y(e){e.projRoot||(e.projRoot=process.cwd()),e.customConvertHookPath&&require(e.customConvertHookPath);const t=e.tableFileDir;if(!t)return void P.log("\u914d\u7f6e\u8868\u76ee\u5f55\uff1atableFileDir\u4e3a\u7a7a","error");if(!f(t))return void P.log(`\u914d\u7f6e\u8868\u6587\u4ef6\u5939\u4e0d\u5b58\u5728\uff1a${t}`,"error");const i=["**/*.{xlsx,csv}","!**/~$*.*","!**/~.*.*"];e.pattern||(e.pattern=i),e.useMultiThread&&isNaN(e.threadParseFileMaxNum)&&(e.threadParseFileMaxNum=5);const n=e.pattern,o=[],a=(e,t)=>{let r;return t||(r=m(e,n),r&&o.push(e)),{canRead:r}};let s,c,u=e.cacheFileDirPath;if(e.useCache){u||(u=".cache"),l(u)||(u=r(e.projRoot,u)),s=r(u,".egfprmc"),c=q(s),c||(c={});const i=Object.keys(c);let n,o;A(t,(e=>{var t=W(e);if(o=c[e],o||(o={filePath:e},c[e]=o),o&&o.md5hash!==t){const{canRead:r}=a(e,!1);r&&(o.md5hash=t)}if(n=i.indexOf(e),n>-1){const e=i[i.length-1];i[n]=e,i.pop()}}));for(let e=0;e<i.length;e++)delete c[i[e]],a(i[e],!0)}else A(t,a);e.useCache&&console.log("----\u3010\u7f13\u5b58\u6a21\u5f0f\u3011----"),console.log("------------------------------\u5339\u914d\u5230\u7684\u6587\u4ef6---------------------"),console.log(o)}export{D as ACharCode,E as DefaultConvertHook,L as DefaultOutPutTransformer,k as DefaultParseHandler,P as Logger,$ as TableType,T as ZCharCode,C as charCodesToString,G as convert,z as doParse,H as forEachChangedFile,A as forEachFile,q as getCacheData,Z as getFileMd5,W as getFileMd5Sync,O as getNextColKey,M as horizontalForEachSheet,_ as isCSV,F as isEmptyCell,x as readTableFile,S as stringToCharCodes,Y as testFileMatch,v as valueTransFuncMap,w as verticalForEachSheet,V as writeCacheData,B as writeOrDeleteOutPutFiles};
