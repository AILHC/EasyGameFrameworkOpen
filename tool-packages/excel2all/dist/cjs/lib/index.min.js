"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("os"),t=require("path"),l=require("js-base64"),n=require("zlib"),r=require("fs-extra"),i=require("crypto"),a=require("micromatch"),o=require("worker_threads"),s=require("xlsx");function c(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(l){if("default"!==l){var n=Object.getOwnPropertyDescriptor(e,l);Object.defineProperty(t,l,n.get?n:{enumerable:!0,get:function(){return e[l]}})}})),t.default=e,Object.freeze(t)}const u=e.platform();let f="\n";"win32"===u&&(f="\r\n");const d={int:"number",json:"any","[int]":"number[]","[string]":"string[]"};const p={};function h(e,t,l){let n;for(let r=e.length-1;r>=0;r--)n=t[e[r].filePath],n||(n={filePath:e[r].filePath}),n.tableObj||(n=l.parseTableFile(e[r],n)),n&&(t[e[r].filePath]=n)}p.int=function(e,t){let l={};"string"==typeof t&&""!==t.trim()?l.value=t.includes(".")?parseFloat(t):parseInt(t):"number"==typeof t&&(l.value=t);return l},p.string=function(e,t){let l={};"string"==typeof t?""!==(t=t.trim())&&(l.value=t):l.value=t+"";return l},p["[int]"]=function(e,t){let l;t=(t=(t+"").replace(/\uff0c/g,",")).trim();const n={};if(""!==t)try{l=JSON.parse(t),n.value=l}catch(e){n.error=e}return n},p["[string]"]=function(e,t){t=(t=(t+"").replace(/\uff0c/g,",")).trim();let l,n={};if(""!==t)try{l=JSON.parse(t),n.value=l}catch(e){n.error=e,console.error(e)}return n},p.json=function(e,t){let l,n;if(""!==(t=(t=(t+"").replace(/\uff0c/g,",")).trim()))try{l=JSON.parse(t)}catch(e){n=e,l=t,console.error(e)}return{error:n,value:l}};var b=Object.freeze({__proto__:null,doParse:h});
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */function g(e,t,l,n){return new(l||(l=Promise))((function(r,i){function a(e){try{s(n.next(e))}catch(e){i(e)}}function o(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){e.done?r(e.value):new l((function(t){t(e.value)})).then(a,o)}s((n=n.apply(e,t||[])).next())}))}function y(e,l){if(r.statSync(e).isDirectory()){const i=r.readdirSync(e);let a;for(var n=0;n<i.length;n++)a=t.join(e,i[n]),y(a,l)}else l(e)}function m(e,t,l){let n;const i=e.length;if(e&&i){let a=0;const o=n=>{n&&console.error(n),a++,t&&t(e[a-1].filePath,i,a,!n),a>=i&&l&&l(i)};for(let t=e.length-1;t>=0;t--)n=e[t],n.isDelete&&r.existsSync(n.filePath)?r.unlinkSync(n.filePath):(n.encoding||"string"!=typeof n.data||(n.encoding="utf8"),r.ensureFileSync(n.filePath),r.writeFile(n.filePath,n.data,n.encoding?{encoding:n.encoding}:void 0,o))}}function T(e,t){e?r.writeFileSync(e,JSON.stringify(t),{encoding:"utf-8"}):console.error("cacheFilePath is null")}function v(e){if(!e)return void console.error("cacheFilePath is null");r.existsSync(e)||(r.ensureFileSync(e),r.writeFileSync(e,"{}",{encoding:"utf-8"}));const t=r.readFileSync(e,"utf-8");return JSON.parse(t)}function N(e){const t=r.readFileSync(e,"utf-8");var l=i.createHash("md5");return l.update(t),l.digest("hex")}function P(e,t,l,n,r,i){e.useCache&&T(t,i);let a=l.trans2Files(n,r,i);const o=Object.values(a);console.log(`\u5f00\u59cb\u5199\u5165\u6587\u4ef6:0/${o.length}`),m(o,((e,t,l,n)=>{console.log(`[\u5199\u5165\u6587\u4ef6] \u8fdb\u5ea6:(${l}/${t}) \u8def\u5f84:${e}`)}),(()=>{console.log("\u5199\u5165\u7ed3\u675f~")}))}function x(e){return!e||void 0===e.v||("string"==typeof e.v?""===e.v:"number"==typeof e.v&&isNaN(e.v))}function F(e){let t;for(let l=e.length-1;l>=0;l--){if(e[l]<90){e[l]+=1,t=!0;break}90===e[l]&&(e[l]=65)}return t||e.push(65),O(e)}function O(e){return String.fromCharCode(...e)}function S(e){const t=[];for(let l=0;l<e.length;l++)t.push(e.charCodeAt(l));return t}function D(e,t,l,n,r,i,a,o){const s=e["!ref"],c=parseInt(s.match(/\d+$/)[0]);let u,f,d=w(s.split(":")[1].match(/^[A-Za-z]+/)[0]),p=0;const h=S(l);for(let s=t;s<=c&&(!r||!r(e,s));s++){if(a&&a(e,s))continue;u=h.concat([]),f=l;let t=!i||!i(e,f);for(;t;)o&&o(e,f)||n(e,f,s),f=F(u),p=w(f),t=d>=p&&(!i||!i(e,f))}}function C(e,t,l,n,r,i,a,o){const s=e["!ref"],c=parseInt(s.match(/\d+$/)[0]),u=w(s.split(":")[1].match(/^[A-Za-z]+/)[0]);let f,d;f=S(l);let p=0;d=l;let h=!i||!i(e,d);for(;h;){if(!o||!o(e,d))for(let l=t;l<=c&&(!r||!r(e,l));l++)a&&a(e,l)||n(e,d,l);d=F(f),p=w(d),h=u>=p&&(!i||!i(e,d))}}let j={};function w(e){let t=j[e];if(!t){t=0;for(let l=0;l<e.length;l++)t+=e.charCodeAt(l);j[e]=t}return t}function _(e){return s.readFile(e.filePath,{type:M(e.fileExtName)?"string":"file"})}function M(e){return"csv"===e}var R;!function(){g(this,void 0,void 0,(function*(){const e=o.workerData,l=e.fileInfos,n=e.parseResultMap,r=e.parseConfig;let i;r.customParseHandlerPath&&(t.isAbsolute(r.customParseHandlerPath)||(r.customParseHandlerPath=t.resolve(__dirname,r.customParseHandlerPath)),i=yield Promise.resolve().then((function(){return c(require(r.customParseHandlerPath))}))),i&&(i=new I);(0,(yield Promise.resolve().then((function(){return b}))).doParse)(l,n,i),o.parentPort.postMessage({threadId:e.threadId,parseResultMap:n})}))}(),(R=exports.TableType||(exports.TableType={})).vertical="vertical",R.horizontal="horizontal";class I{constructor(){this._valueTransFuncMap=p}getTableDefine(e,t){const l=e.fileName,n={tableName:l};let r,i;const a=t.SheetNames;let o,s,c;for(let e=0;e<a.length&&(o=t.Sheets[a[e]],c=o.A1,x(c)||(s=this._getFirstCellValue(c),!s||s.tableNameInSheet!==l));e++);if(!s||s.tableNameInSheet!==l)return console.error(`\u8868\u683c\u4e0d\u89c4\u8303,\u8df3\u8fc7\u89e3\u6790,\u8def\u5f84:${e.filePath}`),null;if(n.tableType=s.tableType,n.tableType===exports.TableType.vertical){n.verticalFieldDefine={};const e=n.verticalFieldDefine;e.textRow=1;for(let t=1;t<100&&(r="A"+t,i=o[r],x(i)||"NO"===i.v||"END"===i.v||"START"===i.v?n.startRow=t:"CLIENT"===i.v?e.fieldRow=t:"TYPE"===i.v&&(e.typeRow=t),!(n.startRow&&e.fieldRow&&e.typeRow));t++);n.startCol="B"}else if(n.tableType===exports.TableType.horizontal){n.horizontalFieldDefine={};const e=n.horizontalFieldDefine;e.textCol="A",e.typeCol="B",e.fieldCol="C",n.startCol="E",n.startRow=2}return n}_getFirstCellValue(e){if(!e)return;const t=e.v.split(":");let l,n;return t.length>1?(l=t[1],n="H"===t[0]?exports.TableType.horizontal:exports.TableType.vertical):(l=t[0],n=exports.TableType.vertical),{tableNameInSheet:l,tableType:n}}checkSheetCanParse(e,t,l){const n=t.A1,r=this._getFirstCellValue(n);return!(!n||!e)&&r.tableNameInSheet===e.tableName}isSheetRowEnd(e,t,l){if(l>1){const e=t["A"+(l-=1)];return e&&"END"===e.v}return!1}isSheetColEnd(e,t,l){return x(t[l+1])}checkRowNeedParse(e,t,l){const n=t["A"+l];return!n||"NO"!==n.v}parseVerticalCell(e,t,l,n,r){const i=this.getVerticalTableField(e,t,l,n);if(!i)return;const a=t[l+n];if(x(a))return;const o=this.transValue(e,i,a.v);o.error&&console.error(`\u8868\u683c:${e.filePath},\u5206\u8868:${e.curSheetName},\u884c:${n},\u5217\uff1a${l}\u89e3\u6790\u51fa\u9519`);const s=o.value;let c=e.mainKeyFieldName;c||(c=i.fieldName,e.mainKeyFieldName=i.fieldName,e.tableObj={});let u=e.curRowOrColObj;if(r&&(u={},e.curRowOrColObj=e.tableObj[s]=u),i.isMutiColObj){let e=u[i.fieldName];e||(e={},u[i.fieldName]=e),e[i.subFieldName]=s}else u[i.fieldName]=s}parseHorizontalCell(e,t,l,n,r){const i=this.getHorizontalTableField(e,t,l,n);if(!i)return;const a=t[l+n];if(x(a))return;const o=this.transValue(e,i,a.v);if(e.tableObj||(e.tableObj={}),i.isMutiColObj){let t=e.tableObj[i.fieldName];t||(t={},e.tableObj[i.fieldName]=t),t[i.subFieldName]=o}else e.tableObj[i.fieldName]=o}getVerticalTableField(e,t,l,n){const r=e.tableDefine;let i=e.filedMap;i||(i={},e.filedMap=i);const a=r.verticalFieldDefine,o=t[l+a.fieldRow];let s;if(x(o)||(s=o.v),!s)return null;let c={};if(void 0!==i[s])return i[s];const u=t[l+a.textRow];x(u)||(c.text=u.v);let f=!1;const d=t[l+a.typeRow];if(x(d))return null;if(c.originType=d.v,c.originType.includes("mf:")){const e=c.originType.split(":");if(e.length<3)return null;c.type=e[2],f=!0}else c.type=c.originType;if(c.isMutiColObj=f,c.originFieldName=s,f){const e=c.originFieldName.split(":");if(e.length<2)return null;c.fieldName=e[0],c.subFieldName=e[1]}else c.fieldName=c.originFieldName;return i[l]=c,c}getHorizontalTableField(e,t,l,n){const r=e.tableDefine;let i=e.filedMap;i||(i={},e.filedMap=i);const a=r.horizontalFieldDefine,o=t[a.fieldCol+n];let s;if(x(o)||(s=o.v),!s)return null;if(void 0!==i[s])return i[s];let c={};const u=t[a.textCol+n];x(u)||(c.text=u.v);let f=!1;const d=t[a.typeCol+n];if(x(d))return null;if(c.originType=d.v,c.originType.includes("mf:")){const e=c.originType.split(":");if(e.length<3)return null;c.type=e[2],f=!0}else c.type=c.originType;if(c.isMutiColObj=f,c.originFieldName=s,f){const e=c.originFieldName.split(":");if(e.length<2)return null;c.fieldName=e[0],c.subFieldName=e[1]}else c.fieldName=c.originFieldName;return i[s]=c,c}checkColNeedParse(e,t,l){if(e.tableType===exports.TableType.vertical){const n=e.verticalFieldDefine,r=t[l+n.typeRow],i=t[l+n.fieldRow];return!x(r)&&!x(i)}if(e.tableType===exports.TableType.horizontal){return!x(t[l+1])}}transValue(e,t,l){let n,r=this._valueTransFuncMap[t.type];return r||(r=this._valueTransFuncMap.json),n=r(t,l),n}parseTableFile(e,t){const l=_(e);if(!l.SheetNames.length)return;const n=l.SheetNames,r=this.getTableDefine(e,l);for(let e=0;e<n.length;e++);if(!r)return null;let i,a;const o=this.isSheetRowEnd.bind(null,r),s=this.isSheetColEnd.bind(null,r),c=(e,t)=>!this.checkRowNeedParse(r,e,t),u=(e,t)=>!this.checkColNeedParse(r,e,t);let f;t.tableDefine=r;for(let d=0;d<n.length;d++)if(i=n[d],a=l.Sheets[i],this.checkSheetCanParse(r,a,i))if(t.curSheetName=i,console.log(`\u89e3\u6790:${e.filePath}=> sheet:${i} ....`),r.tableType===exports.TableType.vertical){let e;D(a,r.startRow,r.startCol,((l,n,r)=>{let i=!1;e!==r&&(e=r,i=!0),f=l[n+r],x(f)||this.parseVerticalCell(t,l,n,r,i)}),o,s,c,u)}else if(r.tableType===exports.TableType.horizontal){let e;C(a,r.startRow,r.startCol,((l,n,r)=>{let i=!1;e!==n&&(e=n,i=!0),f=l[n+r],x(f)||this.parseHorizontalCell(t,l,n,r,i)}),o,s,c,u)}return t}}exports.ACharCode=65,exports.DefaultParseHandler=I,exports.Trans2JsonAndDtsHandler=class{constructor(){}init(e){e||(this._outputConfig={clientSingleTableJsonDir:t.join(process.cwd(),"./excelJsonOut")}),this._outputConfig=e}trans2Files(e,r,i){let a={},o={};const s=this._outputConfig;let c,u,d,p="",h="",b={};for(let e in i)c=i[e],c.tableDefine&&(u=c.tableDefine.tableName,c.tableDefine.tableType===exports.TableType.horizontal?p+="\treadonly "+u+"?: "+`IT_${u};`+f:p+=this._getOneTableTypeStr(u),d=a[u],d=d?Object.assign(d,c.tableObj):c.tableObj,a[u]=d,b[u]=c.tableDefine.tableType===exports.TableType.horizontal,s.isGenDts&&(void 0===s.isBundleDts&&(s.isBundleDts=!0),s.isBundleDts?h+=this._getSingleTableDts(c):this._addSingleTableDtsOutputFile(s,c,o)),s.clientSingleTableJsonDir&&this._addSingleTableJsonOutputFile(s,c,o));if(s.isGenDts){if(p="interface ITBase<T> { [key:string]:T}"+f+"interface IT_TableMap {"+f+p+"}"+f,s.isBundleDts){const e=t.join(s.clientDtsOutDir,"tableMap.d.ts");o[e]={filePath:e,data:p+h}}else{const e=t.join(s.clientDtsOutDir,"tableMap.d.ts");o[e]={filePath:e,data:p}}}if(s.clientBundleJsonOutPath){let e,t=s.clientBundleJsonOutPath;if(s.isCompress){const t={};let l,n;for(let e in a)if(b[e])t[e]=a[e];else{l=a[e],n={fieldValuesMap:{}};for(let e in l)n.fieldNames||(n.fieldNames=Object.keys(l[e])),n.fieldValuesMap[e]=Object.values(l[e]);t[e]=n}e=JSON.stringify(t)}else e=JSON.stringify(a);s.bundleJsonIsEncode2Base64&&(e=l.Base64.encode(e),s.preBase64UglyString&&(e=s.preBase64UglyString+e),s.sufBase64UglyString&&(e+=s.sufBase64UglyString)),s.isZip&&(e=n.deflateSync(e)),o[t]={filePath:t,encoding:"string"!=typeof e?"binary":"utf-8",data:e}}return o}_addSingleTableDtsOutputFile(e,l,n){if(!l.tableObj)return;let r=t.join(e.clientDtsOutDir,`${l.tableDefine.tableName}.d.ts`);if(!n[r]){const e=this._getSingleTableDts(l);e&&(n[r]={filePath:r,data:e})}}_getSingleTableDts(e){const t=e.tableDefine.tableName,l=e.filedMap;let n,r="interface IT_"+t+" {"+f,i={};for(let e in l)if(n=l[e],n)if(n.isMutiColObj){const e=n.fieldName;i[e]||(i[e]=""),i[e]+="\t\t/** "+n.text+" */"+f,i[e]+="\t\treadonly "+n.subFieldName+"?: "+(d[n.subType]?d[n.subType]:n.subType)+";"+f}else r+="\t/** "+n.text+" */"+f,r+="\treadonly "+n.fieldName+"?: "+(d[n.type]?d[n.type]:n.type)+";"+f;for(let e in i)r+="\treadonly "+e+"?: {"+f+i[e],r+="\t}"+f;return r+="}"+f,r}_addSingleTableJsonOutputFile(e,l,n){const r=l.tableObj;if(!r)return;const i=l.tableDefine.tableName;let a=t.join(e.clientSingleTableJsonDir,`${i}.json`),o=JSON.stringify(r,null,"\t"),s=n[a];s?s.data=o:(s={filePath:a,data:o},n[a]=s)}_getOneTableTypeStr(e){return"\treadonly "+e+"?: ITBase<IT_"+e+">;"+f}},exports.ZCharCode=90,exports.charCodesToString=O,exports.doParse=h,exports.forEachChangedFile=function(e,t,l){const n=v(t),i=Object.keys(n);let a;y(e,(e=>{var t=N(e);if((!n[e]||n[e]&&n[e]!==t)&&(n[e]=t,l(e,!1)),a=i.indexOf(e),a>-1){const e=i[i.length-1];i[a]=e,i.pop()}}));for(let e=0;e<i.length;e++)delete n[i[e]],l(i[e],!0);r.writeFileSync(t,JSON.stringify(n),{encoding:"utf-8"})},exports.forEachFile=y,exports.generate=function(e,l){return g(this,void 0,void 0,(function*(){const n=e.tableFileDir;if(!n)return void console.error("\u914d\u7f6e\u8868\u76ee\u5f55\uff1atableFileDir\u4e3a\u7a7a");if(!r.existsSync(n))return void console.error(`\u914d\u7f6e\u8868\u6587\u4ef6\u5939\u4e0d\u5b58\u5728\uff1a${n}`);const i=["**/*.{xlsx,csv}","!**/~$*.*","!**/~.*.*"];if(e.pattern){if(e.pattern&&"object"==typeof e.pattern)for(let t=0;t<i.length;t++)e.pattern.includes(i[t])||e.pattern.push(i[t])}else e.pattern=i;e.useMultiThread&&isNaN(e.threadParseFileMaxNum)&&(e.threadParseFileMaxNum=5);let s=[],u=[];const f=e.pattern,d=(e,l)=>{const n=(e=>{const l=t.parse(e);return{filePath:e,fileName:l.name,fileExtName:l.ext,isDelete:!1}})(e);let r;return l?u.push(n):(r=a.all(n.filePath,f),r&&s.push(n)),{fileInfo:n,canRead:r}};let p,b={},g=e.cacheFileDirPath;if(e.useCache){g||(g=".cache"),t.isAbsolute(g)||(g=t.join(n,g),p=t.join(g,".egfprmc")),b=v(p),b||(b={});const e=Object.keys(b);let l,r;y(n,(t=>{var n=N(t);if(r=b[t],r||(r={filePath:t},b[t]=r),r&&r.md5hash!==n){const{fileInfo:e,canRead:l}=d(t,!1);l&&(r.md5hash=n)}if(l=e.indexOf(t),l>-1){const t=e[e.length-1];e[l]=t,e.pop()}}));for(let t=0;t<e.length;t++)delete b[e[t]],d(e[t],!0)}else y(n,d);if(s.length>e.threadParseFileMaxNum&&e.useMultiThread){const n=Math.floor(s.length/e.threadParseFileMaxNum)+1;let r,i,a=0;const c=(new Date).getTime(),f=t=>{if(console.log(`\u7ebf\u7a0b\u7ed3\u675f:${t.threadId}`),b=Object.assign(b,t.parseResultMap),a++,a>=n){P(e,p,l,s,u,b);const t=(new Date).getTime();console.log("[\u591a\u7ebf\u7a0b\u5bfc\u8868\u65f6\u95f4]:"+(t-c))}};for(let l=0;l<n;l++)i=s.splice(0,e.threadParseFileMaxNum),r=new o.Worker(t.join(t.dirname(__filename),"./worker.js"),{workerData:{threadId:l,fileInfos:i,parseResultMap:b}}),r.on("message",f)}else{const n=(new Date).getTime();let r;e.customParseHandlerPath&&(t.isAbsolute(e.customParseHandlerPath)||(e.customParseHandlerPath=t.resolve(__dirname,e.customParseHandlerPath)),r=yield Promise.resolve().then((function(){return c(require(e.customParseHandlerPath))}))),r||(r=new I),h(s,b,r),P(e,p,l,s,u,b);const i=(new Date).getTime();console.log("[\u5355\u7ebf\u7a0b\u5bfc\u8868\u65f6\u95f4]:"+(i-n))}}))},exports.getCacheData=v,exports.getFileMd5=function(e){return g(this,void 0,void 0,(function*(){return N(e)}))},exports.getFileMd5Sync=N,exports.getNextColKey=F,exports.horizontalForEachSheet=C,exports.isCSV=M,exports.isEmptyCell=x,exports.readTableFile=_,exports.stringToCharCodes=S,exports.valueTransFuncMap=p,exports.verticalForEachSheet=D,exports.writeCacheData=T,exports.writeOrDeleteOutPutFiles=m;
