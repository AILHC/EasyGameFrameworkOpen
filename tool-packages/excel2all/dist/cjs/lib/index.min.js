"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("os"),t=require("xlsx"),r=require("path"),l=require("zlib"),i=require("fs-extra"),n=require("crypto"),o=require("micromatch"),a=require("worker_threads");const s={};s.int=function(e,t){let r={};"string"==typeof t&&""!==t.trim()?r.value=t.includes(".")?parseFloat(t):parseInt(t):"number"==typeof t&&(r.value=t);return r},s.string=function(e,t){let r={};"string"==typeof t?""!==(t=t.trim())&&(r.value=t):r.value=t+"";return r},s["[int]"]=function(e,t){let r;t=(t=(t+"").replace(/\uff0c/g,",")).trim();const l={};if(""!==t)try{r=JSON.parse(t),l.value=r}catch(e){l.error=e}return l},s["[string]"]=function(e,t){t=(t=(t+"").replace(/\uff0c/g,",")).trim();let r,l={};if(""!==t)try{r=JSON.parse(t),l.value=r}catch(e){l.error=e}return l},s.json=function(e,t){let r,l;if(""!==(t=(t=(t+"").replace(/\uff0c/g,",")).trim()))try{r=JSON.parse(t)}catch(e){l=e,r=t}return{error:l,value:r}};const c="win32"===e.platform()?"\n":"\r\n";var u;!function(e){e[e.info=0]="info",e[e.warn=1]="warn",e[e.error=2]="error",e[e.no=3]="no"}(u||(u={}));class f{static init(e){const t=e.logLevel?e.logLevel:"info";this._logLevel=u[t],this._enableOutPutLogFile=!1!==e.outputLogDirPath}static log(e,t="info"){if("no"!==t&&this._logLevel<=u[t])switch(t){case"error":console.error(e),this.hasError||(this.hasError=!0);break;case"info":console.log(e);break;case"warn":console.warn(e)}this._enableOutPutLogFile&&(this._logStr+=e+c)}static systemLog(e){console.log(e),this._enableOutPutLogFile&&(this._logStr+=e+c)}static get logStr(){if(!this._enableOutPutLogFile)return null;const e=this._logStr;return this._logStr="",e}}function h(e){return!e||void 0===e.v||("string"==typeof e.v?""===e.v:"number"==typeof e.v&&isNaN(e.v))}f._logStr="",f.hasError=!1;function p(e){let t;for(let r=e.length-1;r>=0;r--){if(e[r]<90){e[r]+=1,t=!0;break}90===e[r]&&(e[r]=65)}return t||e.push(65),d(e)}function d(e){return String.fromCharCode(...e)}function g(e){const t=[];for(let r=0;r<e.length;r++)t.push(e.charCodeAt(r));return t}function b(e,t,r,l,i,n,o,a){const s=e["!ref"],c=parseInt(s.match(/\d+$/)[0]);let u,f,h=T(s.split(":")[1].match(/^[A-Za-z]+/)[0]),d=0;const b=g(r);for(let s=t;s<=c&&(!i||!i(e,s));s++){if(o&&o(e,s))continue;u=b.concat([]),f=r;let t=!n||!n(e,f);for(;t;)a&&a(e,f)||l(e,f,s),f=p(u),d=T(f),t=h>=d&&(!n||!n(e,f))}}function m(e,t,r,l,i,n,o,a){const s=e["!ref"],c=parseInt(s.match(/\d+$/)[0]),u=T(s.split(":")[1].match(/^[A-Za-z]+/)[0]);let f,h;f=g(r);let d=0;h=r;let b=!n||!n(e,h);for(;b;){if(!a||!a(e,h))for(let r=t;r<=c&&(!i||!i(e,r));r++)o&&o(e,r)||l(e,h,r);h=p(f),d=T(h),b=u>=d&&(!n||!n(e,h))}}let y={};function T(e){let t=y[e];if(!t){t=0;for(let r=0;r<e.length;r++)t+=e.charCodeAt(r);y[e]=t}return t}function v(e){return t.readFile(e.filePath,{type:F(e.fileExtName)?"string":"file"})}function F(e){return"csv"===e}var N;(N=exports.TableType||(exports.TableType={})).vertical="vertical",N.horizontal="horizontal";class P{constructor(){this._valueTransFuncMap=s}getTableDefine(e,t){const r=e.fileName,l={tableName:r};let i,n;const o=t.SheetNames;let a,s,c;for(let e=0;e<o.length&&(a=t.Sheets[o[e]],c=a.A1,h(c)||(s=this._getFirstCellValue(c),!s||s.tableNameInSheet!==r));e++);if(!s||s.tableNameInSheet!==r)return f.log(`\u8868\u683c\u4e0d\u89c4\u8303,\u8df3\u8fc7\u89e3\u6790,\u8def\u5f84:${e.filePath}`,"error"),null;if(l.tableType=s.tableType,l.tableType===exports.TableType.vertical){l.verticalFieldDefine={};const e=l.verticalFieldDefine;e.textRow=1;for(let t=1;t<100&&(i="A"+t,n=a[i],h(n)||"NO"===n.v||"END"===n.v||"START"===n.v?l.startRow=t:"CLIENT"===n.v?e.fieldRow=t:"TYPE"===n.v&&(e.typeRow=t),!(l.startRow&&e.fieldRow&&e.typeRow));t++);l.startCol="B"}else if(l.tableType===exports.TableType.horizontal){l.horizontalFieldDefine={};const e=l.horizontalFieldDefine;e.textCol="A",e.typeCol="B",e.fieldCol="C",l.startCol="E",l.startRow=2}return l}_getFirstCellValue(e){if(!e)return;const t=e.v.split(":");let r,l;return t.length>1?(r=t[1],l="H"===t[0]?exports.TableType.horizontal:exports.TableType.vertical):(r=t[0],l=exports.TableType.vertical),{tableNameInSheet:r,tableType:l}}checkSheetCanParse(e,t,r){const l=t.A1,i=this._getFirstCellValue(l);return!(!l||!e)&&i.tableNameInSheet===e.tableName}isSheetRowEnd(e,t,r){if(r>1){const e=t["A"+(r-=1)];return e&&"END"===e.v}return!1}isSheetColEnd(e,t,r){return h(t[r+1])}checkRowNeedParse(e,t,r){const l=t["A"+r];return!l||"NO"!==l.v}parseVerticalCell(e,t,r,l,i){const n=this.getVerticalTableField(e,t,r,l);if(!n)return;const o=t[r+l];if(h(o))return;const a=this.transValue(e,n,o.v);a.error&&f.log(`!!!!!!!!!!!!!!!!!![-----\u89e3\u6790\u9519\u8bef-----]!!!!!!!!!!!!!!!!!!!!!!!!!\n[sheetName|\u5206\u8868\u540d]=> ${e.curSheetName}\n[row|\u884c]=> ${l}\n[col|\u5217]=> ${r}\n[field|\u5b57\u6bb5]=> ${n.originFieldName}\n[type|\u7c7b\u578b]=> ${n.originType}\n[error|\u9519\u8bef]=> ${"string"==typeof a.error?a.error:a.error.message}\n`,"error");const s=a.value;let c=e.mainKeyFieldName;c||(c=n.fieldName,e.mainKeyFieldName=n.fieldName,e.tableObj={});let u=e.curRowOrColObj;if(i&&(u={},e.curRowOrColObj=e.tableObj[s]=u),n.isMutiColObj){let e=u[n.fieldName];e||(e={},u[n.fieldName]=e),e[n.subFieldName]=s}else u[n.fieldName]=s}parseHorizontalCell(e,t,r,l,i){const n=this.getHorizontalTableField(e,t,r,l);if(!n)return;const o=t[r+l];if(h(o))return;const a=this.transValue(e,n,o.v);a.error&&f.log(`!!!!!!!!!!!!!!!!!![-----ParseError|\u89e3\u6790\u9519\u8bef-----]!!!!!!!!!!!!!!!!!!!!!!!!!\n[sheetName|\u5206\u8868\u540d]=> ${e.curSheetName}\n[row|\u884c]=> ${l}\n[col|\u5217]=> ${r}\n[field|\u5b57\u6bb5]=> ${n.originFieldName}\n[type|\u7c7b\u578b]=> ${n.originType}\n[error|\u9519\u8bef]=> ${"string"==typeof a.error?a.error:a.error.message}\n!!!!!!!!!!!!!!!!!![-----ParseError|\u89e3\u6790\u9519\u8bef-----]!!!!!!!!!!!!!!!!!!!!!!!!!\n`,"error");const s=a.value;if(e.tableObj||(e.tableObj={}),n.isMutiColObj){let t=e.tableObj[n.fieldName];t||(t={},e.tableObj[n.fieldName]=t),t[n.subFieldName]=s}else e.tableObj[n.fieldName]=s}getVerticalTableField(e,t,r,l){const i=e.tableDefine;let n=e.filedMap;n||(n={},e.filedMap=n);const o=i.verticalFieldDefine,a=t[r+o.fieldRow];let s;if(h(a)||(s=a.v),!s)return null;let c={};if(void 0!==n[s])return n[s];const u=t[r+o.textRow];h(u)||(c.text=u.v);let f=!1;const p=t[r+o.typeRow];if(h(p))return null;if(c.originType=p.v,c.originType.includes("mf:")){const e=c.originType.split(":");if(e.length<3)return null;c.type=e[2],f=!0}else c.type=c.originType;if(c.isMutiColObj=f,c.originFieldName=s,f){const e=c.originFieldName.split(":");if(e.length<2)return null;c.fieldName=e[0],c.subFieldName=e[1]}else c.fieldName=c.originFieldName;return n[r]=c,c}getHorizontalTableField(e,t,r,l){const i=e.tableDefine;let n=e.filedMap;n||(n={},e.filedMap=n);const o=i.horizontalFieldDefine,a=t[o.fieldCol+l];let s;if(h(a)||(s=a.v),!s)return null;if(void 0!==n[s])return n[s];let c={};const u=t[o.textCol+l];h(u)||(c.text=u.v);let f=!1;const p=t[o.typeCol+l];if(h(p))return null;if(c.originType=p.v,c.originType.includes("mf:")){const e=c.originType.split(":");if(e.length<3)return null;c.type=e[2],f=!0}else c.type=c.originType;if(c.isMutiColObj=f,c.originFieldName=s,f){const e=c.originFieldName.split(":");if(e.length<2)return null;c.fieldName=e[0],c.subFieldName=e[1]}else c.fieldName=c.originFieldName;return n[s]=c,c}checkColNeedParse(e,t,r){if(e.tableType===exports.TableType.vertical){const l=e.verticalFieldDefine,i=t[r+l.typeRow],n=t[r+l.fieldRow];return!h(i)&&!h(n)}if(e.tableType===exports.TableType.horizontal){return!h(t[r+1])}}transValue(e,t,r){let l,i=this._valueTransFuncMap[t.type];return i||(i=this._valueTransFuncMap.json),l=i(t,r),l}parseTableFile(e,t,r){const l=v(t);if(!l.SheetNames.length)return;const i=l.SheetNames,n=this.getTableDefine(t,l);for(let e=0;e<i.length;e++);if(!n)return null;let o,a;const s=this.isSheetRowEnd.bind(null,n),c=this.isSheetColEnd.bind(null,n),u=(e,t)=>!this.checkRowNeedParse(n,e,t),p=(e,t)=>!this.checkColNeedParse(n,e,t);let d;r.tableDefine=n,f.log(`[parseTable|\u89e3\u6790\u6587\u4ef6]=> ${t.filePath}`);for(let e=0;e<i.length;e++)if(o=i[e],a=l.Sheets[o],this.checkSheetCanParse(n,a,o))if(r.curSheetName=o,f.log(`|=[parseSheet|\u89e3\u6790\u5206\u8868]=> ${o}`),n.tableType===exports.TableType.vertical){let e;b(a,n.startRow,n.startCol,((t,l,i)=>{let n=!1;e!==i&&(e=i,n=!0),d=t[l+i],h(d)||this.parseVerticalCell(r,t,l,i,n)}),s,c,u,p)}else if(n.tableType===exports.TableType.horizontal){let e;m(a,n.startRow,n.startCol,((t,l,i)=>{let n=!1;e!==l&&(e=l,n=!0),d=t[l+i],h(d)||this.parseHorizontalCell(r,t,l,i,n)}),s,c,u,p)}return r}}class x{onStart(e,t){f.systemLog("convert-hook onStart"),t()}onParseBefore(e,t){f.systemLog("convert-hook onParseBefore"),t()}onParseAfter(e,t){e.outputTransformer.transform(e,t)}onWriteFileEnd(e){f.systemLog("convert-hook onWriteFileEnd \u5199\u5165\u7ed3\u675f")}}const S={int:"number",json:"any","[int]":"number[]","[string]":"string[]"};class C{transform(e,t){const i=e.convertConfig,n=e.parseResultMap;let o=i.outputConfig;if(!o)return void console.error("parseConfig.outputConfig is undefind");let a,s,u,f={},h={},p="",d="",g={};for(let e in n)a=n[e],a.tableDefine&&(s=a.tableDefine.tableName,u=f[s],u=u?Object.assign(u,a.tableObj):a.tableObj,f[s]=u,o.isGenDts&&void 0===g[s]&&(g[s]=a.tableDefine.tableType===exports.TableType.horizontal,a.tableDefine.tableType===exports.TableType.horizontal?p+="\treadonly "+s+"?: "+`IT_${s};`+c:p+=this._getOneTableTypeStr(s),void 0===o.isBundleDts&&(o.isBundleDts=!0),o.isBundleDts?d+=this._getSingleTableDts(a):this._addSingleTableDtsOutputFile(o,a,h)),o.clientSingleTableJsonDir&&this._addSingleTableJsonOutputFile(o,a,h));if(o.isGenDts){if(p="interface ITBase<T> { [key:string]:T}"+c+"interface IT_TableMap {"+c+p+"}"+c,o.isBundleDts){const e=o.bundleDtsFileName?o.bundleDtsFileName:"tableMap",t=r.join(o.clientDtsOutDir,`${e}.d.ts`);h[t]={filePath:t,data:p+d}}else{const e=r.join(o.clientDtsOutDir,"tableMap.d.ts");h[e]={filePath:e,data:p}}}if(o.clientBundleJsonOutPath){let e,t=o.clientBundleJsonOutPath;if(o.isCompress){const t={};let r,l;for(let e in f)if(g[e])t[e]=f[e];else{r=f[e],l={fieldValuesMap:{}};for(let e in r)l.fieldNames||(l.fieldNames=Object.keys(r[e])),l.fieldValuesMap[e]=Object.values(r[e]);t[e]=l}e=JSON.stringify(t)}else e=JSON.stringify(f);o.isZip&&(e=l.deflateSync(e)),h[t]={filePath:t,encoding:"string"!=typeof e?"binary":"utf-8",data:e}}if(e.outPutFileMap)for(let t in h)e.outPutFileMap[t]=h[t];else e.outPutFileMap=h;t()}_addSingleTableDtsOutputFile(e,t,l){if(!t.tableObj)return;let i=r.join(e.clientDtsOutDir,`${t.tableDefine.tableName}.d.ts`);if(!l[i]){const e=this._getSingleTableDts(t);e&&(l[i]={filePath:i,data:e})}}_getSingleTableDts(e){const t=e.tableDefine.tableName,r=e.filedMap;let l,i="interface IT_"+t+" {"+c,n={};for(let e in r)if(l=r[e],l)if(l.isMutiColObj){const e=l.fieldName;n[e]||(n[e]=""),n[e]+="\t\t/** "+l.text+" */"+c,n[e]+="\t\treadonly "+l.subFieldName+"?: "+(S[l.type]?S[l.type]:l.type)+";"+c}else i+="\t/** "+l.text+" */"+c,i+="\treadonly "+l.fieldName+"?: "+(S[l.type]?S[l.type]:l.type)+";"+c;for(let e in n)i+="\treadonly "+e+"?: {"+c+n[e],i+="\t}"+c;return i+="}"+c,i}_addSingleTableJsonOutputFile(e,t,l){const i=t.tableObj;if(!i)return;const n=t.tableDefine.tableName;let o=r.join(e.clientSingleTableJsonDir,`${n}.json`),a=JSON.stringify(i,null,"\t"),s=l[o];s?s.data=a:(s={filePath:o,data:a},l[o]=s)}_getOneTableTypeStr(e){return"\treadonly "+e+"?: ITBase<IT_"+e+">;"+c}}function D(e,t,r,l){let i;for(let n=t.length-1;n>=0;n--)i=r[t[n].filePath],i||(i={filePath:t[n].filePath}),i.tableObj||(i=l.parseTableFile(e,t[n],i)),i&&(r[t[n].filePath]=i)}
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */function O(e,t,r,l){return new(r||(r=Promise))((function(i,n){function o(e){try{s(l.next(e))}catch(e){n(e)}}function a(e){try{s(l.throw(e))}catch(e){n(e)}}function s(e){e.done?i(e.value):new r((function(t){t(e.value)})).then(o,a)}s((l=l.apply(e,t||[])).next())}))}function w(e,t){if(i.statSync(e).isDirectory()){const n=i.readdirSync(e);let o;for(var l=0;l<n.length;l++)o=r.join(e,n[l]),w(o,t)}else t(e)}function j(e,t,r){let l;const n=e.length;if(e&&n){let o=0;const a=l=>{l&&f.log(l,"error"),o++,t&&t(e[o-1].filePath,n,o,!l),o>=n&&r&&r(n)};for(let t=e.length-1;t>=0;t--)if(l=e[t],l.isDelete&&i.existsSync(l.filePath))i.unlinkSync(l.filePath);else{if(i.existsSync(l.filePath)&&i.statSync(l.filePath).isDirectory()){f.log(`\u8def\u5f84\u4e3a\u6587\u4ef6\u5939:${l.filePath}`,"error");continue}l.encoding||"string"!=typeof l.data||(l.encoding="utf8"),i.ensureFileSync(l.filePath),i.writeFile(l.filePath,l.data,l.encoding?{encoding:l.encoding}:void 0,a)}}}function M(e,t){e?i.writeFileSync(e,JSON.stringify(t),{encoding:"utf-8"}):f.log("cacheFilePath is null","error")}function R(e){if(!e)return void f.log("cacheFilePath is null","error");i.existsSync(e)||(i.ensureFileSync(e),i.writeFileSync(e,"{}",{encoding:"utf-8"}));const t=i.readFileSync(e,"utf-8");return JSON.parse(t)}function _(e){const t=i.readFileSync(e,"utf-8");var r=n.createHash("md5");return r.update(t),r.digest("hex")}function $(e,t,l,i){return O(this,void 0,void 0,(function*(){const n=e.convertConfig,o=e.parseResultMap;if(n.useCache&&!e.hasError&&M(t,o),yield new Promise((t=>{l.onParseAfter(e,t)})),e.outPutFileMap){const t=e.outPutFileMap,r=Object.values(t);f.systemLog(`\u5f00\u59cb\u5199\u5165\u6587\u4ef6:0/${r.length}`),yield new Promise((e=>{j(r,((e,t,r,l)=>{f.log(`[\u5199\u5165\u6587\u4ef6] \u8fdb\u5ea6:(${r}/${t}) \u8def\u5f84:${e}`)}),(()=>{e()}))})),f.systemLog("\u5199\u5165\u7ed3\u675f~")}else f.systemLog("\u6ca1\u6709\u53ef\u5199\u5165\u6587\u4ef6~");if(i||(i=f.logStr),""!==i.trim()){let t=e.convertConfig.outputLogDirPath;t||(t=".excel2all"),r.isAbsolute(t)||(t=r.join(e.convertConfig.projRoot,t));j([{filePath:r.join(t,"excel2all.log"),data:i}])}l.onWriteFileEnd(e)}))}exports.ACharCode=65,exports.DefaultConvertHook=x,exports.DefaultOutPutTransformer=C,exports.DefaultParseHandler=P,exports.Logger=f,exports.ZCharCode=90,exports.charCodesToString=d,exports.convert=function(e){return O(this,void 0,void 0,(function*(){let t,l;e.projRoot||(e.projRoot=process.cwd()),t=e.customConvertHookPath?require(e.customConvertHookPath):new x,l=e.customOutPutTransformerPath?require(e.customOutPutTransformerPath):new C;const n=e.tableFileDir;if(!n)return void f.log("\u914d\u7f6e\u8868\u76ee\u5f55\uff1atableFileDir\u4e3a\u7a7a","error");if(!i.existsSync(n))return void f.log(`\u914d\u7f6e\u8868\u6587\u4ef6\u5939\u4e0d\u5b58\u5728\uff1a${n}`,"error");const s=["**/*.{xlsx,csv}","!**/~$*.*","!**/~.*.*"];e.pattern||(e.pattern=s),e.useMultiThread&&isNaN(e.threadParseFileMaxNum)&&(e.threadParseFileMaxNum=5),f.init(e);const c={convertConfig:e,outputTransformer:l};yield new Promise((e=>{t.onStart(c,e)}));let u=[],h=[];const p=e.pattern,d=(e,t)=>{const l=(e=>{const t=r.parse(e);return{filePath:e,fileName:t.name,fileExtName:t.ext,isDelete:!1}})(e);let i;return t?h.push(l):(i=o.all(l.filePath,p),i&&u.push(l)),{fileInfo:l,canRead:i}};let g,b,m={},y=e.cacheFileDirPath;if(e.useCache){y||(y=".excel2all"),r.isAbsolute(y)||(y=r.join(e.projRoot,y)),g=r.join(y,".e2aprmc"),m=R(g),m||(m={});const t=Object.keys(m);let l,i;w(n,(e=>{var r=_(e);if(i=m[e],i||(i={filePath:e},m[e]=i),i&&i.md5hash!==r){const{fileInfo:t,canRead:l}=d(e,!1);l&&(i.md5hash=r)}if(l=t.indexOf(e),l>-1){const e=t[t.length-1];t[l]=e,t.pop()}}));for(let e=0;e<t.length;e++)delete m[t[e]],d(t[e],!0)}else w(n,d);if(e.customParseHandlerPath){if(b=require(e.customParseHandlerPath),!b||"function"!=typeof b.parseTableFile)return void console.error(`\u81ea\u5b9a\u4e49\u89e3\u6790\u5b9e\u73b0\u9519\u8bef:${e.customParseHandlerPath}`)}else b=new P;if(c.parseResultMap=m,c.deleteFileInfos=h,c.changedFileInfos=u,yield new Promise((e=>{t.onParseBefore(c,e)})),u.length>e.threadParseFileMaxNum&&e.useMultiThread){let l="";const i=Math.floor(u.length/e.threadParseFileMaxNum)+1;let n,o,s=0;const h=(new Date).getTime(),p=e=>{f.log(`----------------\u7ebf\u7a0b\u7ed3\u675f:${e.threadId}-----------------`);const r=e.parseResultMap;for(let e in r)m[e].tableDefine||(m[e]=r[e]);if(s++,l+=e.logStr+f.logStr,c.hasError||(c.hasError=f.hasError),s>=i){const e=(new Date).getTime();f.log("[\u591a\u7ebf\u7a0b\u5bfc\u8868\u65f6\u95f4]:"+(e-h)),$(c,g,t,l)}};for(let t=0;t<i;t++)o=u.splice(0,e.threadParseFileMaxNum),f.log(`----------------\u7ebf\u7a0b\u5f00\u59cb:${t}-----------------`),n=new a.Worker(r.join(r.dirname(__filename),"../../../worker_scripts/worker.js"),{workerData:{threadId:t,fileInfos:o,parseResultMap:m,convertConfig:e}}),n.on("message",p)}else{const r=(new Date).getTime();D(e,u,m,b);const l=(new Date).getTime();f.systemLog("[\u5355\u7ebf\u7a0b\u5bfc\u8868\u65f6\u95f4]:"+(l-r)),c.hasError=f.hasError,$(c,g,t)}}))},exports.doParse=D,exports.forEachChangedFile=function(e,t,r){const l=R(t),n=Object.keys(l);let o;w(e,(e=>{var t=_(e);if((!l[e]||l[e]&&l[e]!==t)&&(l[e]=t,r(e,!1)),o=n.indexOf(e),o>-1){const e=n[n.length-1];n[o]=e,n.pop()}}));for(let e=0;e<n.length;e++)delete l[n[e]],r(n[e],!0);i.writeFileSync(t,JSON.stringify(l),{encoding:"utf-8"})},exports.forEachFile=w,exports.getCacheData=R,exports.getFileMd5=function(e){return O(this,void 0,void 0,(function*(){return _(e)}))},exports.getFileMd5Sync=_,exports.getNextColKey=p,exports.horizontalForEachSheet=m,exports.isCSV=F,exports.isEmptyCell=h,exports.readTableFile=v,exports.stringToCharCodes=g,exports.testFileMatch=function(e){e.projRoot||(e.projRoot=process.cwd()),e.customConvertHookPath&&require(e.customConvertHookPath);const t=e.tableFileDir;if(!t)return void f.log("\u914d\u7f6e\u8868\u76ee\u5f55\uff1atableFileDir\u4e3a\u7a7a","error");if(!i.existsSync(t))return void f.log(`\u914d\u7f6e\u8868\u6587\u4ef6\u5939\u4e0d\u5b58\u5728\uff1a${t}`,"error");const l=["**/*.{xlsx,csv}","!**/~$*.*","!**/~.*.*"];e.pattern||(e.pattern=l),e.useMultiThread&&isNaN(e.threadParseFileMaxNum)&&(e.threadParseFileMaxNum=5);const n=e.pattern,a=[],s=(e,t)=>{let r;return t||(r=o.all(e,n),r&&a.push(e)),{canRead:r}};let c,u,h=e.cacheFileDirPath;if(e.useCache){h||(h=".cache"),r.isAbsolute(h)||(h=r.join(e.projRoot,h)),c=r.join(h,".egfprmc"),u=R(c),u||(u={});const l=Object.keys(u);let i,n;w(t,(e=>{var t=_(e);if(n=u[e],n||(n={filePath:e},u[e]=n),n&&n.md5hash!==t){const{canRead:r}=s(e,!1);r&&(n.md5hash=t)}if(i=l.indexOf(e),i>-1){const e=l[l.length-1];l[i]=e,l.pop()}}));for(let e=0;e<l.length;e++)delete u[l[e]],s(l[e],!0)}else w(t,s);e.useCache&&console.log("----\u3010\u7f13\u5b58\u6a21\u5f0f\u3011----"),console.log("------------------------------\u5339\u914d\u5230\u7684\u6587\u4ef6---------------------"),console.log(a)},exports.valueTransFuncMap=s,exports.verticalForEachSheet=b,exports.writeCacheData=M,exports.writeOrDeleteOutPutFiles=j;
